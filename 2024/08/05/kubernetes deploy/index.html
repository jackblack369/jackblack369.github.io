<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="k8s deployinstall kubelet kubeadm kubectl all nodes should install   Step1  123# Set SELinux in permissive mode (effectively disabling it)sudo setenforce 0sudo sed -i &amp;#x27;s&#x2F;^SELINUX&#x3D;enforcing$&#x2F;SELIN">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes delploy">
<meta property="og:url" content="https://www.willshirley.top/2024/08/05/kubernetes%20deploy/index.html">
<meta property="og:site_name" content="Clean &amp; Focus">
<meta property="og:description" content="k8s deployinstall kubelet kubeadm kubectl all nodes should install   Step1  123# Set SELinux in permissive mode (effectively disabling it)sudo setenforce 0sudo sed -i &amp;#x27;s&#x2F;^SELINUX&#x3D;enforcing$&#x2F;SELIN">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-08-04T16:37:47.000Z">
<meta property="article:modified_time" content="2025-06-04T08:34:01.221Z">
<meta property="article:author" content="brook">
<meta property="article:tag" content="deploy">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Kubernetes delploy</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Clean & Focus" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Log</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/08/05/Kubernetes%20learn/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/07/30/shell%20bash/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&text=Kubernetes delploy"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kubernetes delploy&body=Check out this article: https://www.willshirley.top/2024/08/05/kubernetes%20deploy/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&t=Kubernetes delploy"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-deploy"><span class="toc-number">1.</span> <span class="toc-text">k8s deploy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#install-kubelet-kubeadm-kubectl"><span class="toc-number">1.1.</span> <span class="toc-text">install kubelet kubeadm kubectl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#install-Container-Runtimes"><span class="toc-number">1.2.</span> <span class="toc-text">install Container Runtimes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#containerd"><span class="toc-number">1.2.1.</span> <span class="toc-text">containerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRI-O-optional"><span class="toc-number">1.2.2.</span> <span class="toc-text">CRI-O (optional)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Engine-optional"><span class="toc-number">1.2.3.</span> <span class="toc-text">Docker Engine (optional)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crictl"><span class="toc-number">1.3.</span> <span class="toc-text">crictl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-deploy-cluster"><span class="toc-number">1.4.</span> <span class="toc-text">kubeadm deploy cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Initializing-control-plane-node"><span class="toc-number">1.4.1.</span> <span class="toc-text">Initializing  control-plane node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#join-node"><span class="toc-number">1.4.2.</span> <span class="toc-text">join node</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#plugin"><span class="toc-number">2.</span> <span class="toc-text">plugin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dashboard"><span class="toc-number">2.1.</span> <span class="toc-text">dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#best-practices"><span class="toc-number">3.</span> <span class="toc-text">best practices</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#change-etcd-default-port"><span class="toc-number">3.1.</span> <span class="toc-text">change etcd default port</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rejoin-work-node"><span class="toc-number">3.2.</span> <span class="toc-text">rejoin work node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other-node-use-kubectl"><span class="toc-number">3.3.</span> <span class="toc-text">other node use kubectl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#log"><span class="toc-number">4.</span> <span class="toc-text">log</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-control-plane-kubeadm-init"><span class="toc-number">4.1.</span> <span class="toc-text">init control-plane (kubeadm init)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join-node-to-cluter"><span class="toc-number">4.2.</span> <span class="toc-text">join node to cluter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#troubelshoot"><span class="toc-number">5.</span> <span class="toc-text">troubelshoot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flannel"><span class="toc-number">5.1.</span> <span class="toc-text">flannel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#containerd-1"><span class="toc-number">5.2.</span> <span class="toc-text">containerd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubelet-serivce-failed"><span class="toc-number">5.3.</span> <span class="toc-text">kubelet serivce failed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#control-plane-NotReady"><span class="toc-number">5.4.</span> <span class="toc-text">control-plane NotReady</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Kubernetes delploy
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">brook</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-08-04T16:37:47.000Z" class="dt-published" itemprop="datePublished">2024-08-05</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Kubernetes/">Kubernetes</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/deploy/" rel="tag">deploy</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="k8s-deploy"><a href="#k8s-deploy" class="headerlink" title="k8s deploy"></a>k8s deploy</h1><h2 id="install-kubelet-kubeadm-kubectl"><a href="#install-kubelet-kubeadm-kubectl" class="headerlink" title="install kubelet kubeadm kubectl"></a>install kubelet kubeadm kubectl</h2><blockquote>
<p>all nodes should install</p>
</blockquote>
<ul>
<li>Step1</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Set SELinux <span class="keyword">in</span> permissive mode (effectively disabling it)</span></span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Step2</p>
<blockquote>
<p>注意下面示例的v1.32不是最新的版本，可修改到最新的版本进行安装</p>
</blockquote>
</li>
</ul>
<p><strong>CentOS/RHEL/Rocky</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.ustc.edu.cn/kubernetes/core:/stable:/v1.32/rpm/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/kubernetes/core:/stable:/v1.32/rpm/repodata/repomd.xml.key</span><br><span class="line">exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>Ubuntu/Debian</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y apt-transport-https ca-certificates curl</span><br><span class="line">sudo curl -fsSL https://mirrors.ustc.edu.cn/kubernetes/core:/stable:/v1.32/deb/Release.key | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/kubernetes-ustc.gpg</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://mirrors.ustc.edu.cn/kubernetes/core:/stable:/v1.32/deb/ /</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>

<ul>
<li>step3</li>
</ul>
<p><strong>CentOS/RHEL/Rocky</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> all node</span></span><br><span class="line">sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<p><strong>Ubuntu/Debian</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y kubelet kubeadm kubectl</span><br><span class="line">sudo systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<ul>
<li><p>step4 disable swap</p>
<blockquote>
<p>主要是 kubelet 服务需要禁用swap</p>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br><span class="line">sudo sed -i &#x27;/[[:space:]]swap[[:space:]]/s/^/#/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>

<h2 id="install-Container-Runtimes"><a href="#install-Container-Runtimes" class="headerlink" title="install Container Runtimes"></a>install Container Runtimes</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cloudraft.io/blog/container-runtimes">https://www.cloudraft.io/blog/container-runtimes</a></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Runtime	Path to Unix domain socket</span><br><span class="line">containerd	unix:<span class="comment">///var/run/containerd/containerd.sock</span></span><br><span class="line">CRI-O	unix:<span class="comment">///var/run/crio/crio.sock</span></span><br><span class="line">Docker Engine (using cri-dockerd)	unix:<span class="comment">///var/run/cri-dockerd.sock</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Enable ipv4 packet forward</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sysctl params required by setup, params persist across reboots</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Apply sysctl params without reboot</span></span><br><span class="line">sudo sysctl --system</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Verify that net.ipv4.ip_forward is <span class="built_in">set</span> to 1</span></span><br><span class="line">sysctl net.ipv4.ip_forward</span><br></pre></td></tr></table></figure>

<ul>
<li>cgroup driver (optional in container and CRI-O)</li>
</ul>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd">containerd</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cri-o">CRI-O</a></li>
</ul>
</blockquote>
<p>To set <code>systemd</code> as the cgroup driver, edit the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/"><code>KubeletConfiguration</code></a> option of <code>cgroupDriver</code> and set it to <code>systemd</code>. For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br></pre></td></tr></table></figure>

<p>Starting with v1.22 and later, when creating a cluster with kubeadm, if the user does not set the <code>cgroupDriver</code> field under <code>KubeletConfiguration</code>, kubeadm defaults it to <code>systemd</code>.</p>
<h3 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h3><ul>
<li><p>init config.toml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> must create /etc/containerd directory advanced</span></span><br><span class="line">sudo mkdir -p /etc/containerd</span><br><span class="line">sudo containerd config default | sudo tee /etc/containerd/config.toml</span><br></pre></td></tr></table></figure></li>
<li><p>config </p>
</li>
</ul>
<p>Configuring the <code>systemd</code> cgroup driver</p>
<p><code>sudo vim /etc/containerd/config.toml</code></p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disabled_plugins = [&quot;cri&quot;]</span></span><br><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span></span><br><span class="line">  <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span></span><br><span class="line">    <span class="attr">SystemdCgroup</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span></span><br><span class="line">  <span class="attr">sandbox_image</span> = <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9&quot;</span> <span class="comment"># &quot;swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/pause:3.10&quot;</span></span><br><span class="line">  <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span></span><br><span class="line">		xxxxxx</span><br><span class="line">  <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span></span><br><span class="line">    xxxxxx</span><br></pre></td></tr></table></figure>

<p><code>sudo systemctl restart containerd</code></p>
<blockquote>
<p>启动完成后就可以使用 containerd 的本地 CLI 工具 <code>ctr</code> 和 <code>crictl</code> 了</p>
</blockquote>
<ul>
<li><p>check containerd version</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containerd --version</span><br><span class="line"><span class="meta">#</span><span class="bash"> containerd containerd.io 1.7.19</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CRI-O-optional"><a href="#CRI-O-optional" class="headerlink" title="CRI-O (optional)"></a>CRI-O (optional)</h3><ul>
<li><p>set repo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/cri-o.repo</span><br><span class="line">[cri-o]</span><br><span class="line">name=CRI-O</span><br><span class="line">baseurl=https://mirrors.ustc.edu.cn/kubernetes/addons:/cri-o:/stable:/v1.30/rpm/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/kubernetes/addons:/cri-o:/stable:/v1.30/rpm/repodata/repomd.xml.key</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li>
<li><p>install</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y container-selinux</span><br><span class="line">dnf install -y cri-o</span><br><span class="line">systemctl start crio.service</span><br></pre></td></tr></table></figure></li>
<li><p>bootstrap cluster</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Docker-Engine-optional"><a href="#Docker-Engine-optional" class="headerlink" title="Docker Engine (optional)"></a>Docker Engine (optional)</h3><ul>
<li><p>install docker (existing)</p>
</li>
<li><p>install <code>cri-dockerd</code>, the CRI socket is <code>/run/cri-dockerd.sock</code> by default.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> download</span> </span><br><span class="line">wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.16/cri-dockerd-0.3.16.amd64.tgz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> extract tgz</span></span><br><span class="line">tar -xzvf cri-dockerd-0.3.16.amd64.tgz</span><br><span class="line"></span><br><span class="line">sudo mv ./cri-dockerd /usr/local/bin/ # mv binary cri-dockerd file</span><br><span class="line">wget https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.service</span><br><span class="line">wget https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.socket</span><br><span class="line">sudo mv cri-docker.socket cri-docker.service /etc/systemd/system/</span><br><span class="line">sudo sed -i -e &#x27;s,/usr/bin/cri-dockerd,/usr/local/bin/cri-dockerd,&#x27; /etc/systemd/system/cri-docker.service</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> config always auto-restart</span></span><br><span class="line">vim /etc/systemd/system/cri-docker.socket</span><br><span class="line">[Socket]</span><br><span class="line">Restart=always</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> service, cri-docker.socket -&gt; trigger -&gt; cri-docker.service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable cri-docker.service</span><br><span class="line">sudo systemctl enable --now cri-docker.socket</span><br><span class="line">sudo systemctl status cri-docker.socket</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="crictl"><a href="#crictl" class="headerlink" title="crictl"></a>crictl</h2><blockquote>
<p> cri client, could check container running on k8s</p>
<p> all node should install it </p>
</blockquote>
<ul>
<li>Config containerd <code>vim /etc/crictl.yaml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runtime-endpoint:</span> <span class="string">unix:///run/containerd/containerd.sock</span> <span class="comment"># docker-engine use unix:///var/run/cri-dockerd.sock </span></span><br><span class="line"><span class="attr">image-endpoint:</span> <span class="string">unix:///run/containerd/containerd.sock</span> <span class="comment"># docker-engine use unix:///var/run/cri-dockerd.sock </span></span><br><span class="line"><span class="attr">timeout:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">pull-image-on-create:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>verify mirror</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crictl info</span><br></pre></td></tr></table></figure>

<ul>
<li>command</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> List All Pods</span></span><br><span class="line">crictl pods</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Filter Pods by Namespace, To view pods <span class="keyword">in</span> a specific namespace, use the `--namespace` or `-n` option:</span></span><br><span class="line">crictl pods --namespace=&lt;namespace_name&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check Container Status</span></span><br><span class="line">crictl containers --namespace=&lt;namespace_name&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Describe a Specific Container</span></span><br><span class="line">crictl describe --namespace=&lt;namespace_name&gt; &lt;container_id&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check Logs (<span class="keyword">if</span> applicable)</span></span><br><span class="line">crictl logs --namespace=&lt;namespace_name&gt; &lt;container_id&gt;</span><br></pre></td></tr></table></figure>



<h2 id="kubeadm-deploy-cluster"><a href="#kubeadm-deploy-cluster" class="headerlink" title="kubeadm deploy cluster"></a>kubeadm deploy cluster</h2><blockquote>
<p>To use different container runtime or if there are more than one installed on the provisioned node, specify the <code>--cri-socket</code> argument to <code>kubeadm</code>.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Runtime</th>
<th>Path to Unix domain socket</th>
</tr>
</thead>
<tbody><tr>
<td>containerd</td>
<td><code>unix:///var/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>CRI-O</td>
<td><code>unix:///var/run/crio/crio.sock</code></td>
</tr>
<tr>
<td>Docker Engine (using cri-dockerd)</td>
<td><code>unix:///var/run/cri-dockerd.sock</code></td>
</tr>
</tbody></table>
<h3 id="Initializing-control-plane-node"><a href="#Initializing-control-plane-node" class="headerlink" title="Initializing  control-plane node"></a>Initializing  control-plane node</h3><ul>
<li><p>bootstrap cluster</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> use flannel as Pod network add-on (CNI plugin), 10.244.0.0/16 is config <span class="keyword">for</span> flannel</span></span><br><span class="line">sudo kubeadm init  --apiserver-advertise-address=10.220.32.16 --pod-network-cidr=10.244.0.0/16  --cri-socket=unix:///var/run/containerd/containerd.sock	 # 如果使用其他 cri， 需要修改sock文件</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo kubeadm config images pull --config kubeadm.conf (提前拉取相关镜像)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo kubeadm init --config kubeadm.conf （使用指定的配置文件，上文中的 apiserver-advertise-address 等参数均在配置文件中配置）</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>(optional) resert (back to kubeadm init) </p>
<blockquote>
<p>执行报错，或修改init配置的时候，进行resert操作</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm reset</span><br><span class="line"></span><br><span class="line">sudo rm -rf /etc/cni/net.d</span><br><span class="line">sudo rm -rf $HOME/.kube/config </span><br><span class="line">sudo systemctl restart kubelet # 必须执行重启</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ul>
<li><p>Use kubectl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></li>
<li><p>install flannel</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> apply flannel(optional) CNI plugin</span> </span><br><span class="line">kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果需要替换 flannel 相关的镜像源，需要提前wget 下载 kube-flannel.yml, 然后修改image信息</span></span><br><span class="line">swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/flannel-io/flannel:v0.26.4 </span><br><span class="line">swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/flannel-io/flannel-cni-plugin:v1.6.2-flannel1</span><br></pre></td></tr></table></figure></li>
<li><p>check the CoreDNS Pod is <code>Running</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-7b5944fdcf-mgwq2            1/1     Running   0          4h22m</span><br><span class="line">kube-system   coredns-7b5944fdcf-sxfvt            1/1     Running   0          4h22m</span><br><span class="line">kube-system   etcd-dingo7232                      1/1     Running   1          4h22m</span><br><span class="line">kube-system   kube-apiserver-dingo7232            1/1     Running   1          4h22m</span><br><span class="line">kube-system   kube-controller-manager-dingo7232   1/1     Running   1          4h22m</span><br><span class="line">kube-system   kube-proxy-w2lfk                    1/1     Running   0          4h22m</span><br><span class="line">kube-system   kube-scheduler-dingo7232            1/1     Running   1          4h22m</span><br></pre></td></tr></table></figure></li>
<li><p><code>kubeadm.conf</code> info</p>
<blockquote>
<p>sudo kubeadm config print init-defaults &gt; kubeadm.conf</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">172.20</span><span class="number">.7</span><span class="number">.232</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dingo7232</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.30</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="join-node"><a href="#join-node" class="headerlink" title="join node"></a>join node</h3><blockquote>
<p>工作节点加入集群 （工作及节点需要提前安装 kubelet、kubeadm、kubectl）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shangdi 16</span></span><br><span class="line">sudo kubeadm join 172.20.7.232:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:9f2fac23dc994bb63b7510b1925f143a5b6fd3305ec8f376b402aa3c08ae5e90 --cri-socket unix:///var/run/containerd/containerd.sock</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sjj 127</span></span><br><span class="line">sudo kubeadm join 172.30.14.127:6443 --token c2ixm4.l1iv90mj1b1ug3bq \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:600be5a4505e894ac2ee7a963b28ff33e6756291dfaf542884bf63a73ddf3fca \</span><br><span class="line">        --cri-socket unix:///var/run/cri-dockerd.sock</span><br><span class="line">        </span><br><span class="line">sudo kubeadm join 172.30.14.127:6443 --token c0ctm3.nkii2s87omvon67u --discovery-token-ca-cert-hash sha256:600be5a4505e894ac2ee7a963b28ff33e6756291dfaf542884bf63a73ddf3fca \</span><br><span class="line">--cri-socket unix:///var/run/cri-dockerd.sock</span><br></pre></td></tr></table></figure>

<p>注意：kubeadm的token会有TTL，可用 <code>kubeadm token list</code> 查看token是否有效，否则使用<code>kubeadm token create --print-join-command</code>创建一个新的token</p>
<ul>
<li>Check on control-plane</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME        STATUS   ROLES           AGE     VERSION</span><br><span class="line">dingo7232   Ready    control-plane   4h31m   v1.30.3</span><br><span class="line">dingo7233   Ready    &lt;none&gt;          98s     v1.30.3</span><br></pre></td></tr></table></figure>

<ul>
<li><p>check all pods</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE      NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel   kube-flannel-ds-gmdks              1/1     Running   0          56s</span><br><span class="line">kube-flannel   kube-flannel-ds-qzmb9              1/1     Running   0          10m</span><br><span class="line">kube-flannel   kube-flannel-ds-tvdjg              1/1     Running   0          3m58s</span><br><span class="line">kube-system    coredns-55cb58b774-7wwq7           1/1     Running   0          74m</span><br><span class="line">kube-system    coredns-55cb58b774-z8v87           1/1     Running   0          74m</span><br><span class="line">kube-system    etcd-dingo127                      1/1     Running   0          74m</span><br><span class="line">kube-system    kube-apiserver-dingo127            1/1     Running   0          74m</span><br><span class="line">kube-system    kube-controller-manager-dingo127   1/1     Running   0          74m</span><br><span class="line">kube-system    kube-proxy-6wv22                   1/1     Running   0          74m</span><br><span class="line">kube-system    kube-proxy-mc6nt                   1/1     Running   0          56s</span><br><span class="line">kube-system    kube-proxy-zv8fp                   1/1     Running   0          3m58s</span><br><span class="line">kube-system    kube-scheduler-dingo127            1/1     Running   0          74m</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h1><h2 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h2><ul>
<li><p>install online</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span><br><span class="line">helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard</span><br></pre></td></tr></table></figure></li>
<li><p>install offline</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install kubernetes-dashboard kubernetes-dashboard-7.5.0.tgz --create-namespace --namespace kubernetes-dashboard</span><br></pre></td></tr></table></figure></li>
<li><p>uninstall</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete kubernetes-dashboard --namespace kubernetes-dashboard</span><br></pre></td></tr></table></figure></li>
<li><p>reference</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.frognew.com/2023/08/kubeadm-install-kubernetes-1.28.html#3kubernetes%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2">https://blog.frognew.com/2023/08/kubeadm-install-kubernetes-1.28.html#3kubernetes%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2</a></li>
</ul>
</li>
</ul>
<h1 id="best-practices"><a href="#best-practices" class="headerlink" title="best practices"></a>best practices</h1><h2 id="change-etcd-default-port"><a href="#change-etcd-default-port" class="headerlink" title="change etcd default port"></a>change etcd default port</h2><ul>
<li><p>step 1: init kubeadm config</p>
<blockquote>
<p>只需要更新需要修改的参数，例如下面的配置信息就是修改etcd的默认端口改为 12379、12380</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///var/run/cri-dockerd.sock</span>  <span class="comment"># 使用了 docker engine 作为 container runtime</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dingo127</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.30</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="string">&quot;10.244.0.0/16&quot;</span>  <span class="comment"># 对应了命令行的 pod-network-cidr 参数</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">advertise-address:</span> <span class="string">&quot;172.30.14.127&quot;</span></span><br><span class="line">    <span class="attr">etcd-servers:</span> <span class="string">&quot;https://127.0.0.1:12379&quot;</span>  <span class="comment"># etcd 服务地址</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/k8s-etcd</span></span><br><span class="line">    <span class="attr">extraArgs:</span></span><br><span class="line">      <span class="attr">advertise-client-urls:</span> <span class="string">&quot;https://172.30.14.127:12379&quot;</span> </span><br><span class="line">      <span class="attr">initial-advertise-peer-urls:</span> <span class="string">&quot;https://172.30.14.127:12380&quot;</span></span><br><span class="line">      <span class="attr">listen-client-urls:</span> <span class="string">&quot;https://127.0.0.1:12379,https://172.30.14.127:12379&quot;</span></span><br><span class="line">      <span class="attr">listen-peer-urls:</span> <span class="string">&quot;https://172.30.14.127:12380&quot;</span></span><br><span class="line">      <span class="attr">initial-cluster:</span> <span class="string">&quot;dingo127=https://172.30.14.127:12380&quot;</span></span><br><span class="line">      <span class="attr">listen-metrics-urls:</span> <span class="string">&quot;http://127.0.0.1:12381&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意：kubeadm.k8s.io/v1beta3 版本的 extraArgs 是 map[string]string 格式；如果使用的是 kubeadm.k8s.io/v1beta4，则相应的extraArgs 需要变为 list 类型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;advertise-address&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;172.30.14.127&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;etcd-servers&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;https://127.0.0.1:12379&quot;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;advertise-client-urls&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;https://172.30.14.127:12379&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;initial-advertise-peer-urls&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;https://172.30.14.127:12380&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;listen-client-urls&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;https://127.0.0.1:12379,https://172.30.14.127:12379&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;listen-peer-urls&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;https://172.30.14.127:12380&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;initial-cluster&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;dingo127=https://172.30.14.127:12380&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;listen-metrics-urls&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;http://127.0.0.1:12381&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>step2: 执行  init 操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --config=kubeadm.conf --ignore-preflight-errors=Port-2379,Port-2380</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为 kubeadm 需要做 pref-light(检测etcd端口2379和2380端口是否被占用)，这里需要跳过对这两个端口的检测</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="rejoin-work-node"><a href="#rejoin-work-node" class="headerlink" title="rejoin work node"></a>rejoin work node</h2><ul>
<li><p>step1: remove node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;old-node-name&gt; --ignore-daemonsets --delete-emptydir-data</span><br><span class="line">kubectl delete node &lt;old-node-name&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>step 2： 重置kubeadm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Reset kubeadm on the Worker Node</span></span><br><span class="line">sudo kubeadm reset -f # --cri-socket unix:///var/run/cri-dockerd.sock</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> restart kubelet on workder node</span></span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure></li>
<li><p>step 3:  join node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join &lt;control-plane-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt; # # --cri-socket unix:///var/run/cri-dockerd.sock</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="other-node-use-kubectl"><a href="#other-node-use-kubectl" class="headerlink" title="other node use kubectl"></a>other node use kubectl</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> method 1</span></span><br><span class="line">scp root@&lt;control-plane-host&gt;:/etc/kubernetes/admin.conf .</span><br><span class="line">kubectl --kubeconfig ./admin.conf get nodes</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> method 2: <span class="built_in">set</span> kubectl default config</span></span><br><span class="line">scp root@&lt;control-plane-host&gt;:/etc/kubernetes/admin.conf ~/.kube/config</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<h1 id="log"><a href="#log" class="headerlink" title="log"></a>log</h1><h2 id="init-control-plane-kubeadm-init"><a href="#init-control-plane-kubeadm-init" class="headerlink" title="init control-plane (kubeadm init)"></a>init control-plane (kubeadm init)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[reset] Reading configuration from the cluster...                                                          </span><br><span class="line">[reset] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;  </span><br><span class="line">W0804 19:50:00.492596  337004 reset.go:124] [reset] Unable to fetch the kubeadm-config ConfigMap from cluster: failed to get config map: configmaps &quot;kubeadm-config&quot; is forbidden: User &quot;kubernetes-admin&quot; cannot get </span><br><span class="line">resource &quot;configmaps&quot; in API group &quot;&quot; in the namespace &quot;kube-system&quot;                                       </span><br><span class="line">W0804 19:50:00.492782  337004 preflight.go:56] [reset] WARNING: Changes made to this host by &#x27;kubeadm init&#x27; or &#x27;kubeadm join&#x27; will be reverted.                                                                       </span><br><span class="line">[reset] Are you sure you want to proceed? [y/N]: y   </span><br><span class="line">[preflight] Running pre-flight checks                                                                                                                                                                                 </span><br><span class="line">W0804 19:50:04.771583  337004 removeetcdmember.go:106] [reset] No kubeadm config, using etcd pod spec to get data directory                                                                                           </span><br><span class="line">[reset] Deleted contents of the etcd data directory: /var/lib/etcd                                                                                                                                                    </span><br><span class="line">[reset] Stopping the kubelet service                                                                                                                                                                                  </span><br><span class="line">[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;                                                                                                                                                          </span><br><span class="line">[reset] Deleting contents of directories: [/etc/kubernetes/manifests /var/lib/kubelet /etc/kubernetes/pki]                                                                                                            </span><br><span class="line">[reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/super-admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/sched</span><br><span class="line">uler.conf]                                                                                                                                                                                      </span><br><span class="line">The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d                                                                                                              </span><br><span class="line">The reset process does not reset or clean up iptables rules or IPVS tables.                                </span><br><span class="line">If you wish to reset iptables, you must do so manually by using the &quot;iptables&quot; command.                                                                                                   </span><br><span class="line">If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)                                                                                                                                           </span><br><span class="line">to reset your system&#x27;s IPVS tables.                                                                                                                                                                              </span><br><span class="line">The reset process does not clean your kubeconfig files and you must remove them manually.                                                                                                                             </span><br><span class="line">Please, check the contents of the $HOME/.kube/config file.                                                 </span><br><span class="line">[dongw@dingo7232 kubernetes]$               </span><br><span class="line">[dongw@dingo7232 kubernetes]$ sudo kubeadm init --config kubeadm-containerd.conf                                                                                                            </span><br><span class="line">[init] Using Kubernetes version: v1.30.0                                                                   </span><br><span class="line">[preflight] Running pre-flight checks                                                                                                                                                                                 </span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster                                    </span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &#x27;kubeadm config images pull&#x27;</span><br><span class="line">W0804 19:50:17.819534  337405 checks.go:844] detected that the sandbox image &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot; of the container runtime is inconsistent with that used by kubeadm.It is </span><br><span class="line">recommended to use &quot;registry.aliyuncs.com/google_containers/pause:3.9&quot; as the CRI sandbox image.           </span><br><span class="line">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;                                                  </span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key                                                                </span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key   </span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [dingo7232 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.20.7.232]</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key                </span><br><span class="line">[certs] Generating &quot;etcd/ca&quot; certificate and key                                                           </span><br><span class="line">[certs] Generating &quot;etcd/server&quot; certificate and key                                                       </span><br><span class="line">[certs] etcd/server serving cert is signed for DNS names [dingo7232 localhost] and IPs [172.20.7.232 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/peer&quot; certificate and key                                                         </span><br><span class="line">[certs] etcd/peer serving cert is signed for DNS names [dingo7232 localhost] and IPs [172.20.7.232 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key                                                                                                                                                      </span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key                                                                                                                                                        </span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;                                                                                                                                                                </span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file                                                          </span><br><span class="line">[kubeconfig] Writing &quot;super-admin.conf&quot; kubeconfig file                                 </span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file                                                                                                                                                                   </span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file                                                      </span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[kubelet-check] Waiting for a healthy kubelet. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.002018544s</span><br><span class="line">[api-check] Waiting for a healthy API server. This can take up to 4m0s</span><br><span class="line">[api-check] The API server is healthy after 6.001201324s</span><br><span class="line">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node dingo7232 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node dingo7232 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: abcdef.0123456789abcdef</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, if you are the root user, you can run: </span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 172.20.7.232:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:9f2fac23dc994bb63b7510b1925f143a5b6fd3305ec8f376b402aa3c08ae5e90</span><br></pre></td></tr></table></figure>

<h2 id="join-node-to-cluter"><a href="#join-node-to-cluter" class="headerlink" title="join node to cluter"></a>join node to cluter</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-check] Waiting for a healthy kubelet. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.501334955s</span><br><span class="line">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster.</span><br></pre></td></tr></table></figure>

<h1 id="troubelshoot"><a href="#troubelshoot" class="headerlink" title="troubelshoot"></a>troubelshoot</h1><h2 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h2><p><strong>Failed to check br_netfilter: stat /proc/sys/net/bridge/bridge-nf-call-iptables: no such file or directory</strong></p>
<p>Solution : Load the br_netfilter Module</p>
<ol>
<li><p>Check if br_netfilter is loaded</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure></li>
<li><p>If not loaded, load the module:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe br_netfilter</span><br></pre></td></tr></table></figure></li>
<li><p>Enable br_netfilter on boot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Add the following line to /etc/modules-load.d/k8s.conf:</span></span><br><span class="line">br_netfilter</span><br></pre></td></tr></table></figure></li>
<li><p>Ensure bridge-nf-call-iptables and bridge-nf-call-ip6tables are set to 1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">sudo sysctl net.bridge.bridge-nf-call-ip6tables=1</span><br></pre></td></tr></table></figure></li>
<li><p>Persist the settings by adding the following to <code>/etc/sysctl.d/k8s.conf</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br></pre></td></tr></table></figure></li>
<li><p>Reload sysctl settings:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="containerd-1"><a href="#containerd-1" class="headerlink" title="containerd"></a>containerd</h2><p><strong>change containerd’s default data path</strong></p>
<ol>
<li><p>Identify the Current Data Path</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config default | grep &quot;root&quot; # Expected output: root = &quot;/var/lib/containerd&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>Modify the following lines in /etc/containerd/config.toml:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root = &quot;/path/to/new/data/path&quot; # the location where container data (images, volumes) is stored</span><br></pre></td></tr></table></figure></li>
<li><p>Move Existing Data (if required)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop containerd  # optional</span><br><span class="line">sudo mv /var/lib/containerd /data/containerd</span><br><span class="line">sudo systemctl start containerd</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="kubelet-serivce-failed"><a href="#kubelet-serivce-failed" class="headerlink" title="kubelet serivce failed"></a>kubelet serivce failed</h2><p><strong>The connection to the server 10.220.32.16:6443 was refused - did you specify the right host or port?</strong></p>
<blockquote>
<p>API server process is up and listening on port 6443</p>
</blockquote>
<ul>
<li><strong>disable swap</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br><span class="line">sudo sed -i &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>

<ul>
<li><code>systemctl start kubelet</code></li>
</ul>
<h2 id="control-plane-NotReady"><a href="#control-plane-NotReady" class="headerlink" title="control-plane NotReady"></a>control-plane NotReady</h2><ul>
<li><p>restart kubelet service on control-plane node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubectl</span><br></pre></td></tr></table></figure></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/archives/">Log</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-deploy"><span class="toc-number">1.</span> <span class="toc-text">k8s deploy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#install-kubelet-kubeadm-kubectl"><span class="toc-number">1.1.</span> <span class="toc-text">install kubelet kubeadm kubectl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#install-Container-Runtimes"><span class="toc-number">1.2.</span> <span class="toc-text">install Container Runtimes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#containerd"><span class="toc-number">1.2.1.</span> <span class="toc-text">containerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRI-O-optional"><span class="toc-number">1.2.2.</span> <span class="toc-text">CRI-O (optional)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Engine-optional"><span class="toc-number">1.2.3.</span> <span class="toc-text">Docker Engine (optional)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crictl"><span class="toc-number">1.3.</span> <span class="toc-text">crictl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-deploy-cluster"><span class="toc-number">1.4.</span> <span class="toc-text">kubeadm deploy cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Initializing-control-plane-node"><span class="toc-number">1.4.1.</span> <span class="toc-text">Initializing  control-plane node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#join-node"><span class="toc-number">1.4.2.</span> <span class="toc-text">join node</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#plugin"><span class="toc-number">2.</span> <span class="toc-text">plugin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dashboard"><span class="toc-number">2.1.</span> <span class="toc-text">dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#best-practices"><span class="toc-number">3.</span> <span class="toc-text">best practices</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#change-etcd-default-port"><span class="toc-number">3.1.</span> <span class="toc-text">change etcd default port</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rejoin-work-node"><span class="toc-number">3.2.</span> <span class="toc-text">rejoin work node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other-node-use-kubectl"><span class="toc-number">3.3.</span> <span class="toc-text">other node use kubectl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#log"><span class="toc-number">4.</span> <span class="toc-text">log</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-control-plane-kubeadm-init"><span class="toc-number">4.1.</span> <span class="toc-text">init control-plane (kubeadm init)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join-node-to-cluter"><span class="toc-number">4.2.</span> <span class="toc-text">join node to cluter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#troubelshoot"><span class="toc-number">5.</span> <span class="toc-text">troubelshoot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flannel"><span class="toc-number">5.1.</span> <span class="toc-text">flannel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#containerd-1"><span class="toc-number">5.2.</span> <span class="toc-text">containerd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubelet-serivce-failed"><span class="toc-number">5.3.</span> <span class="toc-text">kubelet serivce failed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#control-plane-NotReady"><span class="toc-number">5.4.</span> <span class="toc-text">control-plane NotReady</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&text=Kubernetes delploy"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kubernetes delploy&body=Check out this article: https://www.willshirley.top/2024/08/05/kubernetes%20deploy/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&title=Kubernetes delploy"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.willshirley.top/2024/08/05/kubernetes%20deploy/&t=Kubernetes delploy"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    brook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Log</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
