<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Clean &amp; Focus</title>
  
  
  <link href="https://www.willshirley.top/atom.xml" rel="self"/>
  
  <link href="https://www.willshirley.top/"/>
  <updated>2026-01-30T07:17:46.258Z</updated>
  <id>https://www.willshirley.top/</id>
  
  <author>
    <name>brook</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AI Philosophy</title>
    <link href="https://www.willshirley.top/2026/01/29/AI%20Philosophy/"/>
    <id>https://www.willshirley.top/2026/01/29/AI%20Philosophy/</id>
    <published>2026-01-29T07:55:31.000Z</published>
    <updated>2026-01-30T07:17:46.258Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Will-AI-make-some-people-lazy"><a href="#Will-AI-make-some-people-lazy" class="headerlink" title="Will AI make some people lazy"></a>Will AI make some people lazy</h1><p>However, <strong>I do not believe that humans will stop creating legendary programming languages.</strong> In fact, we might be on the verge of a new era of language creation. </p><p>Here is why AI might actually fuel creativity rather than kill it, and why the â€œlazinessâ€ argument is only half the picture.</p><h2 id="1-History-Repeats-Itself-The-â€œLazinessâ€-Cycle"><a href="#1-History-Repeats-Itself-The-â€œLazinessâ€-Cycle" class="headerlink" title="1. History Repeats Itself: The â€œLazinessâ€ Cycle"></a>1. History Repeats Itself: The â€œLazinessâ€ Cycle</h2><p>Every major leap in technology was accused of making humans lazy, but it actually shifted <em>where</em> we applied our effort.</p><ul><li>  <strong>Assembly to C:</strong> People said, â€œIf we use C, we wonâ€™t understand how the CPU works.â€ True. But it allowed us to build Operating Systems (Unix, Windows) that were too complex to write in Assembly.   </li><li>  <strong>C to Python/Java:</strong> People said, â€œGarbage collection and high-level syntax will make programmers weak.â€ True, but it allowed us to build the Internet, massive platforms like Google, and complex AI models.</li></ul><p>AI is simply the next layer of abstraction. It removes the mechanical labor (typing syntax) so humans can focus on <strong>system architecture</strong> and <strong>problem-solving</strong>.</p><h2 id="2-New-Problems-Require-New-Tools"><a href="#2-New-Problems-Require-New-Tools" class="headerlink" title="2. New Problems Require New Tools"></a>2. New Problems Require New Tools</h2><p>â€œLegendaryâ€ languages are usually born to solve a specific, difficult new problem that current languages cannot handle efficiently.</p><ul><li>  <strong>C</strong> was needed for system portability.</li><li>  <strong>Java</strong> was needed for â€œwrite once, run anywhere.â€</li><li>  <strong>Rust</strong> was created to solve the memory safety issues that plague C++.</li></ul><p><strong>AI introduces massive new problems that current languages struggle with:</strong></p><ul><li>  <strong>GPU Compute:</strong> Python is great for AI research, but it is slow. New languages like <strong>Mojo</strong> are being created specifically to bridge the gap between Pythonâ€™s ease of use and C++â€™s speed for AI hardware.  </li><li>  <strong>Security:</strong> As we rely more on AI, code security becomes paramount. We may need languages designed with â€œverifiable AI safetyâ€ built into their syntax.  </li><li>  <strong>Quantum Computing:</strong> This will require entirely new programming paradigms and languages (like Q#) that look nothing like Python or C++. </li></ul><p>As long as the hardware landscape changes (moving from CPUs to GPUs/TPUs/Quantum chips), humans will need to invent new languages to harness that power.</p><h2 id="3-AI-Democratizes-Language-Creation"><a href="#3-AI-Democratizes-Language-Creation" class="headerlink" title="3. AI Democratizes Language Creation"></a>3. AI Democratizes Language Creation</h2><p>Creating a new programming language is incredibly hard. You need to write a parser, a compiler, a standard library, and an ecosystem.</p><ul><li>  <strong>The Old Way:</strong> A small team of geniuses (like Guido van Rossum for Python, or Bjarne Stroustrup for C++) spends years grinding through low-level code.</li><li>  <strong>The AI Way:</strong> An aspiring language designer can use AI to generate the boilerplate for the compiler, write the documentation, and optimize the assembly output. This lowers the barrier to entry.</li></ul><p>This means we might see <strong>more</strong> niche languages, not fewer. We might see â€œDomain Specific Languagesâ€ (DSLs) created for specific industries (e.g., a language just for genetic engineering or legal contracts) that were previously too niche to build.</p><h2 id="4-The-Difference-Between-â€œLazyâ€-and-â€œEfficientâ€"><a href="#4-The-Difference-Between-â€œLazyâ€-and-â€œEfficientâ€" class="headerlink" title="4. The Difference Between â€œLazyâ€ and â€œEfficientâ€"></a>4. The Difference Between â€œLazyâ€ and â€œEfficientâ€</h2><p>You mentioned that AI makes people lazy. There is a risk here: if a programmer never learns the fundamentals, they cannot design a complex system.   </p><p>However, <strong>laziness is often the mother of invention.</strong></p><ul><li>  Programmers are lazy, so they invented functions so they wouldnâ€™t have to copy-paste code.</li><li>  Programmers are lazy, so they invented high-level languages so they wouldnâ€™t have to write Assembly.</li></ul><p>We want to be â€œlazyâ€ about the boring stuff so we can be â€œcreativeâ€ about the hard stuff. If AI handles the syntax, the next â€œlegendaryâ€ language creator wonâ€™t be worrying about memory pointers; they will be worrying about how to structure code so that an AI can<br>understand and optimize it.</p><h2 id="The-Verdict"><a href="#The-Verdict" class="headerlink" title="The Verdict"></a>The Verdict</h2><p>Will AI make some people lazy? <strong>Yes.</strong> People who only want to be â€œcodersâ€ (writers of syntax) may struggle.</p><p>But for <strong>Computer Scientists and Engineers</strong>, AI is a tool. It will help them design the next legendary language faster and with better optimization.  </p><p>We will see the next Python or C++. It might be a language designed specifically to talk to AI, or a language that runs natively on neural network chips. The spark of creativity is still human; AI is just the faster hammer we use to build it.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Will-AI-make-some-people-lazy&quot;&gt;&lt;a href=&quot;#Will-AI-make-some-people-lazy&quot; class=&quot;headerlink&quot; title=&quot;Will AI make some people lazy&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="AI" scheme="https://www.willshirley.top/categories/AI/"/>
    
    
    <category term="Philosophy" scheme="https://www.willshirley.top/tags/Philosophy/"/>
    
  </entry>
  
  <entry>
    <title>lvmlocked sanlock</title>
    <link href="https://www.willshirley.top/2026/01/13/fs:%20lvmlockd/"/>
    <id>https://www.willshirley.top/2026/01/13/fs:%20lvmlockd/</id>
    <published>2026-01-13T10:19:01.000Z</published>
    <updated>2026-02-02T10:22:01.133Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p> LVM + lvmlockd (clvm replacement)</p></blockquote><h1 id="source-code"><a href="#source-code" class="headerlink" title="source code"></a>source code</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https://sourceware.org/git/?p=lvm2.git</span><br><span class="line">https://gitlab.com/lvmteam/lvm2</span><br><span class="line">https://github.com/lvmteam/lvm2</span><br><span class="line"></span><br><span class="line">https://android.googlesource.com/platform/external/lvm2/+/d44af0be2c6f4652eafd90a70e7ba5f24c0f6d5a/lib/locking/lvmlockd.c</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> how lvmlockdÂ  talks to Â sanlockÂ , look at the Â daemons/lvmlockd/Â  directory <span class="keyword">in</span> the <span class="built_in">source</span> tree.</span></span><br><span class="line">â€¢Core Logic: Â daemons/lvmlockd/lvmlockd-core.cÂ </span><br><span class="line">â€¢Sanlock Adapter: Â daemons/lvmlockd/lvmlockd-sanlock.cÂ </span><br><span class="line">â€¢This file contains the C functions that translate LVM lock requests (Â lock_lvÂ , Â lock_vgÂ ) into Â sanlock_acquireÂ andÂ sanlock_release calls.</span><br></pre></td></tr></table></figure><h1 id="ğŸš¨prepare"><a href="#ğŸš¨prepare" class="headerlink" title="ğŸš¨prepare"></a>ğŸš¨prepare</h1><ul><li><p>â—æ“ä½œä¹‹åéœ€è¦æŠŠä¹‹å‰å†—ä½™çš„ <code>activate</code> çš„ lv éƒ½è®¾ç½®æˆ <code>inactive</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> flite</span></span><br><span class="line">lvscan | grep &#x27;/csi-lvm/&#x27; | grep -v inactive</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deactivate duplicate pv</span></span><br><span class="line">lvchange -an /dev/csi-lvm/pvc-xxx</span><br></pre></td></tr></table></figure></li></ul><h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sanlock and lvmlocked</span></span><br><span class="line">apt install lvm2 sanlock lvm2-lockd</span><br></pre></td></tr></table></figure><h2 id="lvmlocked"><a href="#lvmlocked" class="headerlink" title="lvmlocked"></a>lvmlocked</h2><ul><li><p>enable locked</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/lvm/lvm.conf</span></span><br><span class="line">use_lvmlockd = 1</span><br></pre></td></tr></table></figure></li><li><p>check</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvmconfig --type current global/use_lvmlockd</span><br></pre></td></tr></table></figure></li><li><p>restart lvmlockd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart lvmlockd</span><br></pre></td></tr></table></figure></li></ul><h2 id="sanlock"><a href="#sanlock" class="headerlink" title="sanlock"></a>sanlock</h2><ul><li><p>config host id</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/lvm/lvmlocal.conf</span></span><br><span class="line">local &#123;</span><br><span class="line">    # Replace &lt;nodeNum&gt; with the unique integer for this node (e.g., 1, 2, 3...)</span><br><span class="line">    host_id = &lt;nodeNum&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Restart</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sanlock</span><br><span class="line">sleep 8</span><br><span class="line">systemctl restart lvmlockd</span><br></pre></td></tr></table></figure></li></ul><h1 id="first-node"><a href="#first-node" class="headerlink" title="first node"></a>first node</h1><h2 id="Convert-VG-to-sanlock"><a href="#Convert-VG-to-sanlock" class="headerlink" title="Convert VG to sanlock"></a>Convert VG to sanlock</h2><ul><li><p>config sanlock</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(optional) lvchange -an csi-lvm</span><br></pre></td></tr></table></figure></li><li><p>skip global lockspace </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vgchange --lock-type sanlock --lockopt skipgl csi-lvm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span></span></span><br><span class="line">WARNING: skipping global lock in lvmlockd.</span><br><span class="line">Logical volume &quot;lvmlock&quot; created.</span><br><span class="line">device-mapper: remove ioctl on  (253:9) failed: Device or resource busy</span><br><span class="line">Volume group &quot;csi-lvm&quot; successfully changed</span><br></pre></td></tr></table></figure></li></ul><h2 id="Start-the-Lockspace"><a href="#Start-the-Lockspace" class="headerlink" title="Start the Lockspace"></a>Start the Lockspace</h2><blockquote><p>Activate the lockspace for newly converted VG.This allows the local lvmlockd to manage it.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vgchange --lock-start csi-lvm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span></span></span><br><span class="line">Skipping global lock: lockspace not found or started</span><br><span class="line">VG csi-lvm starting sanlock lockspace</span><br><span class="line">Starting locking.  Waiting for sanlock may take 20 sec to 3 min...</span><br></pre></td></tr></table></figure><h2 id="Enable-the-Global-Lock"><a href="#Enable-the-Global-Lock" class="headerlink" title="Enable the Global Lock"></a>Enable the Global Lock</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span></span> </span><br><span class="line">lvmlockctl --gl-enable csi-lvm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span></span><br><span class="line">lvmlockctl -i</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ­£å¸¸æ‰“å°</span></span><br><span class="line">VG csi-lvm lock_type=sanlock UShLSg-JLRf-Agkb-YRQK-asNV-GSFn-IRqbDH</span><br><span class="line">LS sanlock lvm_csi-lvm</span><br><span class="line">LK VG un ver 0 ğŸš¨ åˆå§‹åŒ–ä¹‹åï¼Œæœ¬æ¥ä¸º0ï¼Œç­‰åˆ›å»ºlvä¹‹åï¼ˆlvcreate -L 10G -n lv-temp-1 csi-lvmï¼‰ä¼šå‡ºç°æ•°å­—</span><br><span class="line">LK GL un ver 0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Verify the Global Lock</span></span><br><span class="line">sanlock client status</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span></span><br><span class="line">vgs -o vg_name,lock_type</span><br><span class="line">or</span><br><span class="line">vgs -o+lock_type,lock_args</span><br></pre></td></tr></table></figure><h1 id="other-node"><a href="#other-node" class="headerlink" title="other node"></a>other node</h1><h2 id="Start-the-Lockspace-1"><a href="#Start-the-Lockspace-1" class="headerlink" title="Start the Lockspace"></a>Start the Lockspace</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vgchange --lock-start csi-lvm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Verify the Global Lock</span></span><br><span class="line">sanlock client status</span><br><span class="line"></span><br><span class="line">vgs -o vg_name,lock_type</span><br></pre></td></tr></table></figure><h1 id="init-lock"><a href="#init-lock" class="headerlink" title="init lock"></a>init lock</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 10G -n lv-temp-1 csi-lvm</span><br></pre></td></tr></table></figure><h1 id="best-practices"><a href="#best-practices" class="headerlink" title="best practices"></a>best practices</h1><h2 id="æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æŒæœ‰çš„é”"><a href="#æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æŒæœ‰çš„é”" class="headerlink" title="æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æŒæœ‰çš„é”"></a>æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æŒæœ‰çš„é”</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sanlock client status</span><br></pre></td></tr></table></figure><h2 id="check-lvmlockd-status"><a href="#check-lvmlockd-status" class="headerlink" title="check lvmlockd status"></a>check lvmlockd status</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status lvmlockd</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt; LVM + lvmlockd (clvm replacement)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;source-code&quot;&gt;&lt;a href=&quot;#source-code&quot; class=&quot;headerlink&quot; title=&quot;s</summary>
      
    
    
    
    <category term="fs" scheme="https://www.willshirley.top/categories/fs/"/>
    
    
    <category term="lvmlocked" scheme="https://www.willshirley.top/tags/lvmlocked/"/>
    
  </entry>
  
  <entry>
    <title>linux alternative</title>
    <link href="https://www.willshirley.top/2025/11/10/linux%20env:%20alternatives/"/>
    <id>https://www.willshirley.top/2025/11/10/linux%20env:%20alternatives/</id>
    <published>2025-11-10T03:22:26.000Z</published>
    <updated>2025-11-14T02:46:14.370Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>alternatives and update-alternatives are part of the <strong>system for managing multiple versions of the same tool</strong> (Java, Python, editor, Maven, etc.).</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;alternatives and update-alternatives are part of the &lt;strong&gt;system for managing multiple versions of the same tool&lt;/strong&gt;</summary>
      
    
    
    
    <category term="linux" scheme="https://www.willshirley.top/categories/linux/"/>
    
    
    <category term="env" scheme="https://www.willshirley.top/tags/env/"/>
    
  </entry>
  
  <entry>
    <title>kubectl kustomize</title>
    <link href="https://www.willshirley.top/2025/11/06/k8s-cmd%20kustomize/"/>
    <id>https://www.willshirley.top/2025/11/06/k8s-cmd%20kustomize/</id>
    <published>2025-11-06T07:01:42.000Z</published>
    <updated>2025-11-06T09:16:48.698Z</updated>
    
    <content type="html"><![CDATA[<h1 id="verify"><a href="#verify" class="headerlink" title="verify"></a>verify</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl kustomize .</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;verify&quot;&gt;&lt;a href=&quot;#verify&quot; class=&quot;headerlink&quot; title=&quot;verify&quot;&gt;&lt;/a&gt;verify&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut</summary>
      
    
    
    
    <category term="kustomize" scheme="https://www.willshirley.top/categories/kustomize/"/>
    
    
    <category term="command" scheme="https://www.willshirley.top/tags/command/"/>
    
  </entry>
  
  <entry>
    <title>ceph nvme-of</title>
    <link href="https://www.willshirley.top/2025/11/03/ceph%20nvme-of/"/>
    <id>https://www.willshirley.top/2025/11/03/ceph%20nvme-of/</id>
    <published>2025-11-03T10:38:35.000Z</published>
    <updated>2025-12-12T06:19:26.485Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>server: </p><p>dingo-dongwei-1,dingo-dongwei-2,dingo-dongwei-3</p><p>client:</p><p>ubuntu1,ubuntu2,ubuntu3</p></blockquote><h1 id="conceph"><a href="#conceph" class="headerlink" title="conceph"></a>conceph</h1><h2 id="NQN"><a href="#NQN" class="headerlink" title="NQN"></a>NQN</h2><p>stands for NVMe Qualified Name.Itâ€™s a unique identifier string used in <strong>NVMe-over-Fabrics (NVMe-oF)</strong>.<br>NQN Format (defined by NVMe spec): <strong>nqn.yyyy-mm.domain:unique-name</strong></p><h1 id="config-server"><a href="#config-server" class="headerlink" title="config server"></a>config server</h1><h2 id="create-pool"><a href="#create-pool" class="headerlink" title="create pool"></a>create pool</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create nvmeof_csi</span><br><span class="line">rbd pool init nvmeof_csi</span><br><span class="line">ceph orch apply nvmeof nvmeof_csi --placement=&quot;dingo-dongwei-1,dingo-dongwei-2&quot;</span><br></pre></td></tr></table></figure><h2 id="create-NVMe-subsystem"><a href="#create-NVMe-subsystem" class="headerlink" title="create NVMe subsystem"></a>create NVMe subsystem</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> latest ceph</span></span><br><span class="line">podman pull quay.io/ceph/nvmeof-cli:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> ceph version 18.2.5 reef (stable)</span></span><br><span class="line">podman pull quay.io/ceph/nvmeof-cli:1.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> podman run -it --rm quay.io/ceph/nvmeof-cli:latest --server-address GATEWAY_IP --server-port GATEWAY_PORT 5500 subsystem add --subsystem SUSYSTEM_NQN</span></span><br><span class="line"></span><br><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">  --server-address 10.225.10.50 \</span><br><span class="line">  --server-port 5500 \</span><br><span class="line">  subsystem add --subsystem nqn.2025-11.io.ceph:dongwei-nvme</span><br></pre></td></tr></table></figure><h2 id="add-listener"><a href="#add-listener" class="headerlink" title="add listener"></a>add listener</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> get the NVME-oF Gateway name:</span></span><br><span class="line">ceph orch ps | grep nvme</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Define the IP port <span class="keyword">for</span> the gateway(tell Ceph <span class="built_in">where</span> to listen <span class="keyword">for</span> NVMe-oF connections)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> podman run -it --rm quay.io/ceph/nvmeof-cli:latest --server-address GATEWAY_IP --server-port GATEWAY_PORT 5500 listener add --subsystem SUBSYSTEM_NQN --host-name HOST_NAME --traddr GATEWAY_IP --trsvcid 4420</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> version &gt; reef</span></span><br><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">  --server-address 10.225.10.50 \</span><br><span class="line">  --server-port 5500 \</span><br><span class="line">  listener add \</span><br><span class="line">  --subsystem nqn.2025-11.io.ceph:dongwei-nvme \</span><br><span class="line">  --host-name dingo-dongwei-1 --traddr 10.225.10.50 \</span><br><span class="line">  --trsvcid 4420</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> version = reff</span></span><br><span class="line">podman run -it quay.io/ceph/nvmeof-cli:1.1.0 \</span><br><span class="line">  --server-address 10.225.10.50 \</span><br><span class="line">  --server-port 5500 \</span><br><span class="line">  listener add \</span><br><span class="line">  --subsystem nqn.2025-11.io.ceph:dongwei-nvme \</span><br><span class="line">  --gateway-name client.nvmeof.nvmeof_csi.dingo-dongwei-1.ligmtr \</span><br><span class="line">  --traddr 10.225.10.50 \</span><br><span class="line">  --trsvcid 4420</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> list listener</span></span><br><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest   --server-address 10.225.10.50   --server-port 5500   listener list --subsystem nqn.2025-11.io.ceph:dongwei-nvme</span><br></pre></td></tr></table></figure><h1 id="config-client"><a href="#config-client" class="headerlink" title="config client"></a>config client</h1><h2 id="optional-init-NQN-on-client"><a href="#optional-init-NQN-on-client" class="headerlink" title="(optional) init NQN on client"></a>(optional) init NQN on client</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nvme gen-hostnqn | sudo tee /etc/nvme/hostnqn</span><br><span class="line"></span><br><span class="line">cat /etc/nvme/hostnqn  # nqn.2014-08.org.nvmexpress:uuid:40bf4b78-4229-4d44-81b0-9bee0d1604fe</span><br></pre></td></tr></table></figure><h2 id="on-server-add-client-host-access-permissions"><a href="#on-server-add-client-host-access-permissions" class="headerlink" title="(on server) add client host access permissions"></a>(on server) add client host access permissions</h2><p>Allow the initiator host to connect to the newly-created NVMe subsystem:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">podman run -it quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">--server-address 10.225.10.50 \</span><br><span class="line">--server-port 5500 \</span><br><span class="line">host add --subsystem nqn.2025-11.io.ceph:dongwei-nvme --host &quot;nqn.2014-08.org.nvmexpress:uuid:40bf4b78-4229-4d44-81b0-9bee0d1604fe&quot;</span><br><span class="line"></span><br><span class="line">podman run -it quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">--server-address 10.225.10.50 \</span><br><span class="line">--server-port 5500 \</span><br><span class="line">host add --subsystem nqn.2025-11.io.ceph:dongwei-nvme --host &quot;nqn.2014-08.org.nvmexpress:uuid:74faf23a-5c3e-43d8-87a8-d2247a0593c7&quot;</span><br><span class="line"></span><br><span class="line">podman run -it quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">--server-address 10.225.10.50 \</span><br><span class="line">--server-port 5500 \</span><br><span class="line">host add --subsystem nqn.2025-11.io.ceph:dongwei-nvme --host &quot;nqn.2014-08.org.nvmexpress:uuid:a8c13096-b83a-4350-a98e-355a77c87f7b&quot;</span><br></pre></td></tr></table></figure><h2 id="list-client"><a href="#list-client" class="headerlink" title="list  client"></a>list  client</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest   --server-address 10.225.10.50   --server-port 5500  host list --subsystem nqn.2025-11.io.ceph:dongwei-nvme</span><br></pre></td></tr></table></figure><h1 id="create-the-RBD-image"><a href="#create-the-RBD-image" class="headerlink" title="create the RBD image"></a>create the RBD image</h1><p>In NVMe terms:<br>    â€¢    A subsystem is like a container (it groups one or more namespaces).<br>    â€¢    A namespace is the actual block device (e.g. /dev/nvme0n1) that the client will see.<br>    â€¢    Each namespace typically maps to an RBD image in Ceph.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Create the RBD image</span></span><br><span class="line">rbd create nvmeof_csi/dongwei-rbd1 --size 10G</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Register it as an NVMe namespace</span></span><br><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">  --server-address 10.225.10.50 \</span><br><span class="line">  --server-port 5500 \</span><br><span class="line">  namespace add \</span><br><span class="line">  --subsystem nqn.2025-11.io.ceph:dongwei-nvme \</span><br><span class="line">  --rbd-pool nvmeof_csi \</span><br><span class="line">  --rbd-image dongwei-rbd1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span></span><br><span class="line">podman run -it --rm quay.io/ceph/nvmeof-cli:latest \</span><br><span class="line">  --server-address 10.225.10.50 \</span><br><span class="line">  --server-port 5500 \</span><br><span class="line">  namespace list --subsystem nqn.2025-11.io.ceph:dongwei-nvme</span><br></pre></td></tr></table></figure><h1 id="config-client-initiator"><a href="#config-client-initiator" class="headerlink" title="config client initiator"></a>config client initiator</h1><blockquote><p>on client machine</p></blockquote><h2 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install nvme-cli</span><br><span class="line">modprobe nvme-fabrics</span><br><span class="line"><span class="meta">#</span><span class="bash"> (deprecated) verify connect</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nvme discover -t tcp -a 10.220.69.130 -s 4420</span></span><br></pre></td></tr></table></figure><h2 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> connect</span></span><br><span class="line">nvme connect -t tcp -a 10.220.69.130 -s 4420 -n nqn.2025-11.io.ceph:dongwei-nvme</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">nvme list</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disconnect</span></span><br><span class="line">nvme disconnect -n nqn.2025-11.io.ceph:dongwei-nvme</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;server: &lt;/p&gt;
&lt;p&gt;dingo-dongwei-1,dingo-dongwei-2,dingo-dongwei-3&lt;/p&gt;
&lt;p&gt;client:&lt;/p&gt;
&lt;p&gt;ubuntu1,ubuntu2,ubuntu3&lt;/p&gt;
&lt;/blockquo</summary>
      
    
    
    
    <category term="ceph" scheme="https://www.willshirley.top/categories/ceph/"/>
    
    
    <category term="nvme" scheme="https://www.willshirley.top/tags/nvme/"/>
    
  </entry>
  
  <entry>
    <title>nvme-of</title>
    <link href="https://www.willshirley.top/2025/11/02/fs:%20nvme-of/"/>
    <id>https://www.willshirley.top/2025/11/02/fs:%20nvme-of/</id>
    <published>2025-11-02T04:21:01.000Z</published>
    <updated>2026-02-02T10:17:18.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt install nvme-cli</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœé‡åˆ° modprobe: FATAL: Module nvme_tcp not found <span class="keyword">in</span> directory /lib/modules/5.15.0-122-generic</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> éœ€è¦å®‰è£… apt install linux-modules-extra-5.15.0-122-generic</span></span><br><span class="line">modprobe nvme_tcp </span><br><span class="line"></span><br><span class="line">modprobe nvme_fabrics</span><br><span class="line"><span class="meta">#</span><span class="bash"> nvme connect -t tcp -a 10.220.8.57 -s 4420   -n nqn.2025-11.io.spdk:cnode-test-volume</span></span><br></pre></td></tr></table></figure><h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><h2 id="system-service"><a href="#system-service" class="headerlink" title="system service"></a>system service</h2><ul><li><p>step1: config nvmeof info</p><p><code>vim /etc/nvme/discovery.conf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-t tcp -a 10.220.32.14 -s 4420 -n nqn.2025-11.io.spdk:cnode-test-volume</span><br></pre></td></tr></table></figure></li><li><p>step2: create systemd unit</p><p><code>vim /etc/systemd/system/nvmeof-connect.service</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=<span class="string">NVMe-oF TCP Auto Connect</span></span><br><span class="line"><span class="attr">After</span>=<span class="string">network-online.target</span></span><br><span class="line"><span class="attr">Wants</span>=<span class="string">network-online.target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=<span class="string">oneshot</span></span><br><span class="line"><span class="attr">RemainAfterExit</span>=<span class="string">yes</span></span><br><span class="line"><span class="attr">ExecStart</span>=<span class="string">/usr/sbin/nvme connect \</span></span><br><span class="line"><span class="string">  -t tcp \</span></span><br><span class="line"><span class="string">  -a 10.220.32.14 \</span></span><br><span class="line"><span class="string">  -s 4420 \</span></span><br><span class="line"><span class="string">  -n nqn.2025-11.io.spdk:cnode-test-volume \</span></span><br><span class="line"><span class="string">  --keep-alive-tmo=30</span></span><br><span class="line"><span class="attr">ExecStop</span>=<span class="string">/usr/sbin/nvme disconnect \</span></span><br><span class="line"><span class="string">  -n nqn.2025-11.io.spdk:cnode-test-volume</span></span><br><span class="line"><span class="attr">TimeoutSec</span>=<span class="string">60</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=<span class="string">multi-user.target</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>step3: enable service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable nvmeof-connect.service</span><br><span class="line">systemctl start nvmeof-connect.service</span><br></pre></td></tr></table></figure></li></ul><h1 id="command"><a href="#command" class="headerlink" title="command"></a>command</h1><h2 id="pv"><a href="#pv" class="headerlink" title="pv"></a>pv</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> flush cache</span></span><br><span class="line">pvscan --cache</span><br><span class="line">lvscan</span><br></pre></td></tr></table></figure><h2 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Show LV name + tags <span class="keyword">for</span> all LVs <span class="keyword">in</span> VG , add Â --noheadingsÂ  <span class="keyword">if</span> you donâ€™t want the header line).</span></span><br><span class="line">lvs csi-lvm -o lv_name,lv_tags</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check specify lv tag</span></span><br><span class="line">lvs -o tags /dev/vg_name/lv_name</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete tag</span></span><br><span class="line">lvchange --deltag node/xxx vg_name/lv_name</span><br></pre></td></tr></table></figure><h2 id="active"><a href="#active" class="headerlink" title="active"></a>active</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> activate specific multiple LVs explicitly</span></span><br><span class="line">lvchange -ay vg_data/lv1 vg_data/lv2 vg_data/lv3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disactivate specific multiple LVs explicitly</span></span><br><span class="line">lvchange -an vg_data/lv1 vg_data/lv2 vg_data/lv3</span><br></pre></td></tr></table></figure><ul><li><strong>Inactive LV â†’ no device-mapper node â†’ no /dev/mapper/* file</strong></li></ul><h2 id="expand"><a href="#expand" class="headerlink" title="expand"></a>expand</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> device</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tell LVM to use the new space. This updates the PV metadata to claim the new free space.</span></span><br><span class="line">sudo pvresize  /dev/nvmexxx </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lv</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> adds 10GB to the logical volume</span> </span><br><span class="line">lvextend -L +10G /dev/vg_name/lv_name</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> expands the LV to exactly xxx total</span></span><br><span class="line">lvextend -L xxxG /dev/vg_name/lv_name</span><br></pre></td></tr></table></figure><h1 id="troubleshooting"><a href="#troubleshooting" class="headerlink" title="troubleshooting"></a>troubleshooting</h1><h2 id="èŠ‚ç‚¹lv-mapperæ²¡æœ‰æ¸…ç†å¹²å‡€"><a href="#èŠ‚ç‚¹lv-mapperæ²¡æœ‰æ¸…ç†å¹²å‡€" class="headerlink" title="èŠ‚ç‚¹lv mapperæ²¡æœ‰æ¸…ç†å¹²å‡€"></a>èŠ‚ç‚¹lv mapperæ²¡æœ‰æ¸…ç†å¹²å‡€</h2><blockquote><p>è™½ç„¶ lvscan ä¸å†æ˜¾ç¤ºlvï¼Œä½†æ˜¯lsblk -f è¿˜æ˜¯æœ‰æ˜¾ç¤º lvçš„ä¿¡æ¯</p><p>åŸå› æ˜¯ deletelv pod æ˜¯éšæœºè°ƒåº¦åˆ°ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ï¼Œè™½ç„¶å†…æœ‰ dmsetup remove çš„é€»è¾‘ï¼Œä½†ä¹Ÿä»…é™äºä½œç”¨äºå½“å‰è¢«è°ƒåº¦åˆ°çš„èŠ‚ç‚¹</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç°è±¡</span></span><br><span class="line">nvme0n1</span><br><span class="line">â”‚    LVM2_m LVM2        7CKk4S-JMin-iUPj-iTmS-1Qqc-pNDf-UkRH6E                </span><br><span class="line">â””â”€csi--lvm-pvc--115f834a--c2bd--4206--852d--0141f6ee4937</span><br><span class="line">     ext4   1.0         40c1ff24-7a27-4085-9ed3-9a1b2e5daacb</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ­£ç¡®æ“ä½œï¼ˆæŠ¹é™¤ä¹‹å‰lvçš„å…ƒæ•°æ®ï¼‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> â€¢ Recreation: When you recreate the LV, LVM allocates physical blocks on the disk. If it allocates the exact same blocks (<span class="built_in">which</span> is very likely <span class="keyword">if</span> you just deleted and recreated it), the new LV points to the exact same physical location.</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The actual dataâ€”including the filesystem Superblock <span class="built_in">which</span> stores the UUIDâ€”is still physically written on the storage disk.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. Wipe the filesystem signature (removing the UUID)</span></span><br><span class="line">wipefs -a /dev/csi-lvm/pvc-115f834a...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. Now remove the mapping</span></span><br><span class="line">dmsetup remove csi--lvm-pvc--115f834a...</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> é”™è¯¯æ“ä½œ (wrong operate)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&#x27;dmsetup remove&#x27;</span> only removes the â€œmappingâ€ (the virtual device path <span class="keyword">in</span> the kernel) that allows you to access the data. This is like unplugging a USB cable, It disconnects the device from the OS view, but the data stays on the â€œstick.â€</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dmsetup removeÂ : Only removes the kernel device mapper entry. The Logical Volume definition typically still exists <span class="keyword">in</span> LVM metadata, and the data is definitely still on disk.</span></span><br><span class="line">dmsetup remove csi--lvm-pvc--115f834a--c2bd--4206--852d--0141f6ee4937</span><br></pre></td></tr></table></figure><h2 id="lsblk-f-æ— æ³•æ˜¾ç¤ºæ–°çš„è®¾å¤‡"><a href="#lsblk-f-æ— æ³•æ˜¾ç¤ºæ–°çš„è®¾å¤‡" class="headerlink" title="lsblk -f æ— æ³•æ˜¾ç¤ºæ–°çš„è®¾å¤‡"></a>lsblk -f æ— æ³•æ˜¾ç¤ºæ–°çš„è®¾å¤‡</h2><blockquote><p>Force Client to See the New Volume</p></blockquote><ol><li><p><strong>Find the NVMe Device Name:</strong><br>Run <code>ls /dev/nvme*</code>. You are looking for the controller character device, likely <code>/dev/nvme0</code> or <code>/dev/nvme1</code> (not ending in <code>n1</code>).</p></li><li><p><strong>Rescan:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Replace with your actual controller device</span></span><br><span class="line">nvme ns-rescan /dev/nvmex  </span><br></pre></td></tr></table></figure></li><li><p><strong>Check Again:</strong><br>Now run <code>lsblk</code>. The device (e.g., <code>nvmex</code>) should appear.</p></li></ol><h2 id="lvs-Checksum-error"><a href="#lvs-Checksum-error" class="headerlink" title="lvs Checksum error"></a>lvs Checksum error</h2><blockquote><p>ç”±äºnvmeof åªèƒ½åŒæ—¶åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ“ä½œæ•°æ®ï¼Œå¦‚æœå¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ“ä½œæ•°æ®ï¼Œåˆ™ä¼šé€ æˆå†²çª</p></blockquote><p><strong>issue</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/dev/nvme4n4: Checksum error at offset 372224</span><br><span class="line">WARNING: invalid metadata text from /dev/nvme4n4 at 372224.</span><br><span class="line">WARNING: metadata on /dev/nvme4n4 at 372224 has invalid summary for VG.</span><br><span class="line">WARNING: bad metadata text on /dev/nvme4n4 in mda1</span><br><span class="line">WARNING: scanning /dev/nvme4n4 mda1 failed to read metadata summary.</span><br><span class="line">WARNING: repair VG metadata on /dev/nvme4n4 with vgck --updatemetadata.</span><br><span class="line">WARNING: scan failed to get metadata summary from /dev/nvme4n4 PVID 0y2OB6itmv7xauOycVUpvAiAarPLUI6o</span><br></pre></td></tr></table></figure><p><strong>solution</strong></p><ul><li><p><strong>step1: Dump the Metadata to a File</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Since the system cannot <span class="built_in">read</span> the VG, use the low-level `pvck` tool to extract the configuration text stored on the drive.</span></span><br><span class="line">pvck --dump metadata_search /dev/nvme4n4 &gt; /tmp/csi-lvm_search.vg</span><br></pre></td></tr></table></figure><p><strong>csi-lvm_search.vg</strong> as below</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Searching for metadata at offset 4096 size 1044480</span><br><span class="line">metadata at 17408 length 31448 crc 9fb93ed6 vg csi-lvm seqno 31081 id UShLSg-JLRf-Agkb-YRQK-asNV-GSFn-IRqbDH</span><br><span class="line">......</span><br><span class="line">metadata at 339456 length 32289 crc 4cc1a315 vg csi-lvm seqno 31091 id UShLSg-JLRf-Agkb-YRQK-asNV-GSFn-IRqbDH</span><br><span class="line">ğŸš¨metadata at 372224 length 32281 crc 3ab9a3d8 vg csi-lvm seqno 31092 id UShLSg-JLRf-Agkb-YRQK-asNV-GSFn-IRqbDH</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>Key finding:</p><ul><li>The corrupted one is at <code>372224</code>.</li><li>A newer valid one (higher seqno <code>31093</code>) exists at <code>404992</code>.</li><li>We must extract <code>404992</code>.</li></ul></li><li><p><strong>step2: Stop all I/O to this NVMe-oF LUN</strong></p><blockquote><p>Make sure no pod/host is using the LV/VG, and this NVMe namespace is not attached read-write from two nodes at the same time.</p></blockquote></li><li><p><strong>step3: Extract the Raw Metadata Text</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Run this <span class="built_in">command</span> to copy exactly 31,840 bytes from offset 404992:</span></span><br><span class="line">dd if=/dev/nvme4n4 bs=1 skip=404992 count=31840 of=/tmp/csi-lvm_fixed.vg</span><br></pre></td></tr></table></figure><p><strong>csi-lvm_fixed.vg</strong> as below</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">csi-lvm &#123;</span><br><span class="line">id = <span class="attr">&quot;UShLSg-JLRf-Agkb-YRQK-asNV-GSFn-IRqbDH&quot;</span></span><br><span class="line">seqno = 31093</span><br><span class="line">format = <span class="attr">&quot;lvm2&quot;</span></span><br><span class="line">status = [<span class="attr">&quot;RESIZEABLE&quot;</span>, <span class="attr">&quot;READ&quot;</span>, <span class="attr">&quot;WRITE&quot;</span>]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">physical_volumes &#123;</span><br><span class="line"></span><br><span class="line">pv0 &#123;</span><br><span class="line">id = <span class="attr">&quot;0y2OB6-itmv-7xau-OycV-UpvA-iAar-PLUI6o&quot;</span></span><br><span class="line">device = <span class="attr">&quot;/dev/nvme4n4&quot;</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logical_volumes &#123;</span><br><span class="line"></span><br><span class="line">pvc-a75bd3c3-b2f8-4ae1-904b-af95c5ed1ad6 &#123;</span><br><span class="line">id = <span class="attr">&quot;RwMGsf-R7GE-GiyI-jw3V-J4To-S8aX-wrrFTr&quot;</span></span><br><span class="line">status = [<span class="attr">&quot;READ&quot;</span>, <span class="attr">&quot;WRITE&quot;</span>, <span class="attr">&quot;VISIBLE&quot;</span>]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pvc-6cee2171-b630-4756-8f05-2727f2f53d09 &#123;</span><br><span class="line">id = <span class="attr">&quot;jg1OEJ-eLzj-FS41-3Z2L-3kyT-IJtV-Ur7x59&quot;</span></span><br><span class="line">status = [<span class="attr">&quot;READ&quot;</span>, <span class="attr">&quot;WRITE&quot;</span>, <span class="attr">&quot;VISIBLE&quot;</span>]</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p><strong>step4: Wipe the Corrupted Signature</strong></p><blockquote><p>We will wipe the first 1MB of the disk to remove the broken LVM label and metadata. <strong>Do not worry</strong>, this only removes the LVM headers (which are already broken); your data is safely located further down (at PE start 2048 sectors = 1MB).</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=/dev/nvme4n4 bs=1M count=1</span><br></pre></td></tr></table></figure></li><li><p><strong>step5: Re-create the PV Header</strong></p><blockquote><p>This fixes the â€œNo metadata areasâ€ error by creating a new, valid metadata area.<br>This rewrites the header (label) and creates a fresh metadata area without touching your data.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pvcreate --uuid &quot;&lt;YOUR-UUID&gt;&quot; --restorefile /tmp/csi-lvm_fixed.vg /dev/nvme4n4</span><br><span class="line"><span class="meta">#</span><span class="bash"> actual: pvcreate --uuid <span class="string">&quot;0y2OB6-itmv-7xau-OycV-UpvA-iAar-PLUI6o&quot;</span> --restorefile /tmp/csi-lvm_fixed.vg /dev/nvme4n4</span></span><br></pre></td></tr></table></figure></li><li><p><strong>step6: Restore the VG Configuration</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcfgrestore -f /tmp/csi-lvm_fixed.vg csi-lvm</span><br></pre></td></tr></table></figure></li><li><p><strong>step7: Verify</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvs</span><br></pre></td></tr></table></figure></li></ul><h1 id="best-practices"><a href="#best-practices" class="headerlink" title="best practices"></a>best practices</h1><h2 id="discard-the-space-after-removing-the-LV"><a href="#discard-the-space-after-removing-the-LV" class="headerlink" title="discard the space after removing the LV"></a>discard the space after removing the LV</h2><p><strong>method1: Automatic (after execute lvremove /dev/vg_name/lv_name)</strong></p><ol><li><p>Edit the config file <code>/etc/lvm/lvm.conf</code></p></li><li><p>Change the value, set  <code>issue_discards = 1</code>  (The default is usually 0).</p></li></ol><p><strong>method2: Manual</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> manually sends the trim <span class="built_in">command</span> <span class="keyword">while</span> the volume still exists, <span class="keyword">then</span> removes it. This achieves the same result without changing Â lvm.conf</span></span><br><span class="line">blkdiscard /dev/vg_name/lv_name</span><br><span class="line">lvremove /dev/vg_name/lv_name</span><br></pre></td></tr></table></figure><h2 id="wipefs-vs-desetup-vs-lvremove"><a href="#wipefs-vs-desetup-vs-lvremove" class="headerlink" title="wipefs vs desetup vs lvremove"></a>wipefs vs desetup vs lvremove</h2><ul><li>wipefs : Just removes labels. Data remains. Space is not freed on server.</li><li>blkdiscard : Wipes data. Sends TRIM. Space is freed on server (if supported).</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      Application Layer                       â”‚</span><br><span class="line">â”‚                    (mount, read/write files)                 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                              â–²</span><br><span class="line">                              â”‚</span><br><span class="line">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                    â”‚   wipefs -a xxx   â”‚  â† Erases filesystem signature</span><br><span class="line">                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (XFS/ext4 magic bytes)</span><br><span class="line">                              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                     Filesystem Layer                         â”‚</span><br><span class="line">â”‚              (XFS superblock, UUID, LABEL, etc.)            â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                              â–²</span><br><span class="line">                              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                   Block Device Layer                         â”‚</span><br><span class="line">â”‚                  /dev/mapper/vg-lv                          â”‚</span><br><span class="line">â”‚                  /dev/dm-X                                   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                              â–²</span><br><span class="line">                              â”‚</span><br><span class="line">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                    â”‚ dmsetup remove xxxâ”‚  â† Removes device mapper entry</span><br><span class="line">                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (kernel memory cleanup)</span><br><span class="line">                              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                   Device Mapper Layer                        â”‚</span><br><span class="line">â”‚            (Kernel creates /dev/mapper devices)             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                              â–²</span><br><span class="line">                              â”‚</span><br><span class="line">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                    â”‚   lvremove xxx    â”‚  â† Removes LVM metadata</span><br><span class="line">                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (VG metadata update)</span><br><span class="line">                              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      LVM Metadata Layer                      â”‚</span><br><span class="line">â”‚              (PV/VG/LV configuration on disk)               â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                              â–²</span><br><span class="line">                              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                   Physical Storage Layer                     â”‚</span><br><span class="line">â”‚              (NVMe-oF device, disk sectors)                 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;prepare&quot;&gt;&lt;a href=&quot;#prepare&quot; class=&quot;headerlink&quot; title=&quot;prepare&quot;&gt;&lt;/a&gt;prepare&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="fs" scheme="https://www.willshirley.top/categories/fs/"/>
    
    
    <category term="nvmeof" scheme="https://www.willshirley.top/tags/nvmeof/"/>
    
  </entry>
  
  <entry>
    <title>haproxy &amp; keepalived</title>
    <link href="https://www.willshirley.top/2025/10/15/HA/"/>
    <id>https://www.willshirley.top/2025/10/15/HA/</id>
    <published>2025-10-15T07:20:27.000Z</published>
    <updated>2025-10-17T10:12:59.286Z</updated>
    
    <content type="html"><![CDATA[<h1 id="detect"><a href="#detect" class="headerlink" title="detect"></a>detect</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> virtual machine will <span class="built_in">return</span> <span class="string">&#x27;kvm&#x27;</span> or <span class="string">&#x27;vmware&#x27;</span>, physical machine will <span class="built_in">return</span> <span class="string">&#x27;none&#x27;</span></span></span><br><span class="line">systemd-detect-virt</span><br><span class="line"><span class="meta">#</span><span class="bash"> KVM may have not previlege to config vip, so may could not config vip <span class="keyword">in</span> keepalived</span></span><br></pre></td></tr></table></figure><h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install haproxy keepalived  # Debian/Ubuntu</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">sudo yum install haproxy keepalived  # RHEL/CentOS/Rocky Linux</span><br></pre></td></tr></table></figure><blockquote><p>assume there are two server e.g. 10.225.10.50 and 10.225.10.51, and each bootstrap web service with 13307 port</p><p>and i want export both service by same port 13308 with same ip </p><p>if server is physical machine, could use haproxy &amp; keepalived strategy</p><p>if server is virtural machine, could use </p></blockquote><h1 id="haproxy"><a href="#haproxy" class="headerlink" title="haproxy"></a>haproxy</h1><blockquote><p>both server all should config and bootstrap haproxy</p></blockquote><h2 id="config"><a href="#config" class="headerlink" title="config"></a>config</h2><p><strong>/etc/haproxy/haproxy.cfg</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    log                     global</span><br><span class="line">    option                  tcplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">frontend ft_executor</span><br><span class="line">    bind *:13308</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend bk_executor</span><br><span class="line"></span><br><span class="line">backend bk_executor</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server executor1 10.225.10.50:13307 check</span><br><span class="line">    server executor2 10.225.10.51:13307 check</span><br></pre></td></tr></table></figure><h2 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h2><p><strong>config restart policy</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/haproxy.service</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo setenforce 0</span><br><span class="line">sudo systemctl enable haproxy</span><br><span class="line">sudo systemctl start haproxy</span><br></pre></td></tr></table></figure><h1 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h1><blockquote><p>both server all should config and bootstrap keepalived</p></blockquote><h2 id="config-1"><a href="#config-1" class="headerlink" title="config"></a>config</h2><p><strong>/etc/keepalived/keepalived.conf</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    # âš ï¸ Remove or comment out vrrp_strict if it exists</span><br><span class="line">    # vrrp_strict</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;pidof haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -15</span><br><span class="line">    fall 3</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER # server1 is MASTER , server2 should be BACKUP</span><br><span class="line">    interface eth0 # replace eth0 with your real network interface</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110 # server1 is 110, server2 should be lower </span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    # Add unicast configuration, âš ï¸ server2 would swap ip , src should be 51, peer should be 50</span><br><span class="line">    unicast_src_ip 10.225.10.50    # This server&#x27;s IP</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        10.225.10.51                # Peer server&#x27;s IP</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # Add this line to allow traffic to VIP</span><br><span class="line">    accept</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass dingo   # custome password</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"># å¦‚æœè™šæ‹Ÿæœºæ— æƒé™é…ç½®vipï¼Œéœ€è¦æ³¨é‡Šæ‰vipçš„é…ç½®</span><br><span class="line">    #virtual_ipaddress &#123;</span><br><span class="line">    #    10.225.10.160/24 dev eth0 label eth0:vip</span><br><span class="line">    #&#125;</span><br><span class="line">    </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>config virtual ip as 10.225.10.160</p></blockquote><h2 id="bootstrap-1"><a href="#bootstrap-1" class="headerlink" title="bootstrap"></a>bootstrap</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable keepalived</span><br><span class="line">sudo systemctl start keepalived</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;detect&quot;&gt;&lt;a href=&quot;#detect&quot; class=&quot;headerlink&quot; title=&quot;detect&quot;&gt;&lt;/a&gt;detect&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut</summary>
      
    
    
    
    <category term="HA" scheme="https://www.willshirley.top/categories/HA/"/>
    
    
    <category term="load balance" scheme="https://www.willshirley.top/tags/load-balance/"/>
    
  </entry>
  
  <entry>
    <title>s3-benchmark</title>
    <link href="https://www.willshirley.top/2025/07/01/s3-benchmark/"/>
    <id>https://www.willshirley.top/2025/07/01/s3-benchmark/</id>
    <published>2025-07-01T08:34:52.000Z</published>
    <updated>2025-07-06T13:13:55.351Z</updated>
    
    <content type="html"><![CDATA[<h1 id="warp"><a href="#warp" class="headerlink" title="warp"></a>warp</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">warp mixed --host=&lt;ip&gt;:&lt;port&gt; --access-key=&lt;ak&gt; --secret-key=&lt;sk&gt; --autoterm --tls --insecure --bucket &lt;bucketName&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> e.g.</span></span><br><span class="line">warp mixed --host=10.220.32.17:30369 --access-key=&lt;ak&gt; --secret-key=&lt;sk&gt; --autoterm --tls --insecure --bucket dongwei-data  --duration=3m</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> put</span></span><br><span class="line">warp put --host=10.220.32.17:30369 --access-key=&lt;ak&gt; --secret-key=&lt;ak&gt; --autoterm --tls --insecure --bucket benchmark-data --obj.size=4M --concurrent=32</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> analyze</span></span><br><span class="line">warp analyze --analyze.v  --analyze.out=1.csv &#x27;warp-mixed-2025-07-01[220228]-u7Ii.json.zst&#x27;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;warp&quot;&gt;&lt;a href=&quot;#warp&quot; class=&quot;headerlink&quot; title=&quot;warp&quot;&gt;&lt;/a&gt;warp&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr</summary>
      
    
    
    
    <category term="s3" scheme="https://www.willshirley.top/categories/s3/"/>
    
    
    <category term="tool" scheme="https://www.willshirley.top/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>noobaa</title>
    <link href="https://www.willshirley.top/2025/06/26/noobaa/"/>
    <id>https://www.willshirley.top/2025/06/26/noobaa/</id>
    <published>2025-06-26T03:12:48.000Z</published>
    <updated>2025-07-06T12:58:23.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h1><p><strong>NSFS</strong></p><p>NSFS (short for Namespace-Filesystem) is a capability to use a shared filesystem (mounted in the endpoints) for the storage of S3 buckets, while keeping a 1-1 mapping between Object and File.</p><p>reference </p><p><a href="https://github.com/noobaa/noobaa-core/wiki/NSFS-on-Kubernetes">NSFS on Kubernetes</a></p><ul><li>FS backend supported types are <code>GPFS</code>, <code>CEPH_FS</code>, <code>NFSv4</code> default is <code>POSIX</code></li></ul><h1 id="code"><a href="#code" class="headerlink" title="code"></a>code</h1><h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make noobaa  # include: 1 make build, 2 make base, 3 make noobaa</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> include below operate</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. make noobaa-builder image</span> </span><br><span class="line">docker build   --build-arg CENTOS_VER=9 --build-arg BUILD_S3SELECT=1 --build-arg BUILD_S3SELECT_PARQUET=0 -f src/deploy/NVA_build/builder.Dockerfile   -t noobaa-builder .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. make noobaa-base image</span></span><br><span class="line">docker build   --build-arg BUILD_S3SELECT=1 --build-arg BUILD_S3SELECT_PARQUET=0 -f src/deploy/NVA_build/Base.Dockerfile   -t noobaa-base .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. make noobaa-core image</span></span><br><span class="line">docker build   --build-arg CENTOS_VER=9 --build-arg BUILD_S3SELECT=1 --build-arg BUILD_S3SELECT_PARQUET=0 -f src/deploy/NVA_build/NooBaa.Dockerfile   -t noobaa --build-arg GIT_COMMIT=&quot;d6feb0a&quot; .</span><br></pre></td></tr></table></figure><ul><li><p>å¦‚æœä¿®æ”¹ä»£ç éœ€è¦æ‰§è¡Œ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make base  # åˆ¶ä½œ noobaa-base:dingofs</span><br><span class="line">make noobaa # åˆ¶ä½œ noobaa-core:dingofs-v1.0</span><br><span class="line">docker tag noobaa-core:dingofs-v1.0 harbor.zetyun.cn/dingofs/noobaa-core:dingofs-v1.0.x</span><br><span class="line">docker push harbor.zetyun.cn/dingofs/noobaa-core:dingofs-v1.0.x</span><br></pre></td></tr></table></figure></li></ul><p><strong>quay archifact</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/noobaa/noobaa-builder:master-20250623</span><br><span class="line">docker pull quay.io/noobaa/noobaa-base:master-20250623</span><br></pre></td></tr></table></figure><h2 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h2><ul><li><p>build image</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.github/workflows/manual-full-build.yaml</span><br></pre></td></tr></table></figure></li></ul><h1 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://github.com/noobaa/noobaa-operator/releases/download/v5.18.4/noobaa-operator-v5.18.4-linux-amd64.tar.gz</span><br><span class="line">tar -xzvf noobaa-operator-v5.18.4-linux-amd64.tar.gz</span><br><span class="line">chmod +x noobaa-$OS-$VERSION</span><br><span class="line">mv noobaa-$OS-$VERSION /usr/local/bin/noobaa</span><br></pre></td></tr></table></figure><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><ul><li><p>default sc</p><p><strong>default-sc-dingofs-noobaa.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-sc-dingofs-noobaa</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">csi.dingofs.com</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span> </span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-name:</span> <span class="string">dingofs-secret-noobaa</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-namespace:</span> <span class="string">dingofs</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-publish-secret-name:</span> <span class="string">dingofs-secret-noobaa</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-publish-secret-namespace:</span> <span class="string">dingofs</span></span><br><span class="line">  <span class="attr">pathPattern:</span> <span class="string">&quot;$&#123;.pvc.namespace&#125;-$&#123;.pvc.name&#125;&quot;</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">diskCache.diskCacheType=2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">block_cache.cache_store=disk</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">disk_cache.cache_dir=/dingofs/client/data/cache/0:10240</span>  <span class="comment"># &quot;/data1:100;/data2:200&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">disk_cache.cache_size_mb=102400</span>   <span class="comment"># MB</span></span><br></pre></td></tr></table></figure></li><li><p>prepare</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ctr -n k8s.io images pull dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-core:master-20250623</span><br><span class="line">sudo ctr -n k8s.io images pull dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-operator:5.18.4</span><br><span class="line">sudo ctr -n k8s.io images pull quay.io/sclorg/postgresql-15-c9s:latest</span><br></pre></td></tr></table></figure></li><li><p>install</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns noobaa</span><br><span class="line">kubectl config set-context --current --namespace noobaa</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use internal postgres</span></span><br><span class="line">noobaa install --noobaa-image=dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-core:master-20250623 --operator-image=dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-operator:5.18.4 --db-image=quay.io/sclorg/postgresql-15-c9s:latest --namespace=noobaa</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use external postgres</span> </span><br><span class="line">noobaa install --noobaa-image=dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-core:master-20250623 --operator-image=dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-operator:5.18.4 --postgres-url=&quot;postgres://postgres:noobaa123@10.220.32.18:5432/nbcore&quot; --namespace=noobaa</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use dingofs image</span></span><br><span class="line">noobaa install --noobaa-image harbor.zetyun.cn/dingofs/noobaa-core:dingofs-v1.0 --operator-image dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-operator:5.18.4 --namespace=noobaa --debug-level all </span><br></pre></td></tr></table></figure></li><li><p>status</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa status --show-secrets</span><br></pre></td></tr></table></figure></li><li><p>uninstall</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">noobaa uninstall --cleanup</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clean expired data</span></span><br><span class="line">kubectl exec -it &lt;noobaaFS-debug-pod&gt; -n dingofs -- bash</span><br><span class="line">cd /dfs/noobaa-debug-pv-xxx</span><br><span class="line">rm -rf noobaa-db-noobaa-db-pg-0</span><br><span class="line">rm -rf noobaa-noobaa-default-backing-store-noobaa-pvc-xxx</span><br></pre></td></tr></table></figure></li><li><p>upgrade</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">noobaa upgrade --noobaa-image &lt;noobaa-image-path-and-tag&gt; --operator-image &lt;operator-image-path-and-tag&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> image update</span></span><br><span class="line">sudo ctr -n k8s.io images pull harbor.zetyun.cn/dingofs/noobaa-core:dingofs-v1.0.3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> e.g.</span></span><br><span class="line">noobaa upgrade --noobaa-image harbor.zetyun.cn/dingofs/noobaa-core:dingofs-v1.0.3 --operator-image dockerproxy.zetyun.cn/docker.io/noobaa/noobaa-operator:5.18.4 --debug-level all </span><br></pre></td></tr></table></figure></li></ul><h2 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">noobaa-core-0                                      2/2     Running   0          2m5s</span><br><span class="line">noobaa-db-pg-0                                     1/1     Running   0          2m6s</span><br><span class="line">noobaa-default-backing-store-noobaa-pod-cb1747eb   1/1     Running   0          19s</span><br><span class="line">noobaa-endpoint-79677c7dd9-cjqdj                   1/1     Running   0          42s</span><br><span class="line">noobaa-operator-7d969db69c-gmlm4                   1/1     Running   0          2m28s</span><br></pre></td></tr></table></figure><p><strong>default resource</strong></p><ul><li><p>noobaa-core-0</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     999m</span><br><span class="line">  memory:  4Gi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:     999m</span><br><span class="line">  memory:  4Gi </span><br></pre></td></tr></table></figure></li><li><p>noobaa-db-pg-0 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     500m</span><br><span class="line">  memory:  4Gi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:     500m</span><br><span class="line">  memory:  4Gi</span><br></pre></td></tr></table></figure></li><li><p>noobaa-default-backing-store-â€¦â€¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     100m</span><br><span class="line">  memory:  400Mi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:     100m</span><br><span class="line">  memory:  400Mi</span><br></pre></td></tr></table></figure></li><li><p>noobaa-endpoint-â€¦â€¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     999m</span><br><span class="line">  memory:  2Gi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:      999m</span><br><span class="line">  memory:   2Gi</span><br></pre></td></tr></table></figure></li><li><p>noobaa-operator-â€¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     250m</span><br><span class="line">  memory:  512Mi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:     250m</span><br><span class="line">  memory:  512Mi</span><br></pre></td></tr></table></figure></li></ul><h3 id="endpoint"><a href="#endpoint" class="headerlink" title="endpoint"></a>endpoint</h3><blockquote><p>Endpoints are deployed as a deployment with autoscaling, so the <code>minCount</code>/<code>maxCount</code> values should be used to set a range for the autoscaler to use, and this is typically how you can increase the systemâ€™s S3 throughput. It should be preferred to increase the number of endpoints rather than increasing the resources for each endpoint.</p></blockquote><p><strong>replica</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch noobaa noobaa --type merge --patch &#x27;&#123;</span><br><span class="line">  &quot;spec&quot;: &#123;</span><br><span class="line">    &quot;endpoints&quot;: &#123;</span><br><span class="line">      &quot;minCount&quot;: 3,</span><br><span class="line">      &quot;maxCount&quot;: 3,</span><br><span class="line">      &quot;resources&quot;: &#123;</span><br><span class="line">        &quot;limits&quot;: &#123;</span><br><span class="line">          &quot;cpu&quot;: &quot;4&quot;,</span><br><span class="line">          &quot;memory&quot;: &quot;4Gi&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;requests&quot;: &#123;</span><br><span class="line">          &quot;cpu&quot;: &quot;4&quot;,</span><br><span class="line">          &quot;memory&quot;: &quot;4Gi&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p><strong>boostrap</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> /noobaa_init_files/noobaa_init.sh init_endpoint</span></span><br><span class="line">init_endpoint() &#123;</span><br><span class="line">  fix_non_root_user</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> nsfs folder is a root folder of mount points to backing storages.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> In oder to avoid access denied of sub folders, configure nsfs with full permisions (777)</span></span><br><span class="line">  if [ -d &quot;/nsfs&quot; ];then</span><br><span class="line">    chmod 777 /nsfs</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  cd /root/node_modules/noobaa-core/</span><br><span class="line">  run_internal_process node --unhandled-rejections=warn ./src/s3/s3rver_starter.js</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run_internal_process() &#123;</span><br><span class="line">  while true</span><br><span class="line">  do</span><br><span class="line">    local package_path=&quot;/root/node_modules/noobaa-core/package.json&quot;</span><br><span class="line">    local version=$(cat $&#123;package_path&#125; | grep version | awk &#x27;&#123;print $2&#125;&#x27; | sed &#x27;s/[&quot;,]//g&#x27;)</span><br><span class="line">    echo &quot;Version is: $&#123;version&#125;&quot;</span><br><span class="line">    echo &quot;Running: $*&quot;</span><br><span class="line">    $*</span><br><span class="line">    rc=$?</span><br><span class="line">    echo -e &quot;\n\n\n&quot;</span><br><span class="line">    echo &quot;######################################################################&quot;</span><br><span class="line">    echo &quot;$(date) NooBaa: Process exited RIP (RC=$rc)&quot;</span><br><span class="line">    echo &quot;######################################################################&quot;</span><br><span class="line">    echo -e &quot;\n\n\n&quot;</span><br><span class="line"></span><br><span class="line">    mode=&quot;manual&quot; # initial value just to start the loop</span><br><span class="line">    while [ &quot;$mode&quot; == &quot;manual&quot; ]</span><br><span class="line">    do</span><br><span class="line">      # load mode from file/env</span><br><span class="line">      if [ -f &quot;./NOOBAA_INIT_MODE&quot; ]</span><br><span class="line">      then</span><br><span class="line">        mode=&quot;$(cat ./NOOBAA_INIT_MODE)&quot;</span><br><span class="line">      else</span><br><span class="line">        mode=&quot;$NOOBAA_INIT_MODE&quot;</span><br><span class="line">      fi</span><br><span class="line"></span><br><span class="line">      if [ &quot;$mode&quot; == &quot;auto&quot; ]</span><br><span class="line">      then</span><br><span class="line">        echo &quot;######################################################################&quot;</span><br><span class="line">        echo &quot;$(date) NooBaa: Restarting process (NOOBAA_INIT_MODE=auto)&quot;</span><br><span class="line">        echo &quot;######################################################################&quot;</span><br><span class="line">        echo -e &quot;\n\n\n&quot;</span><br><span class="line">        # will break from the inner loop and re-run the process</span><br><span class="line">      elif [ &quot;$mode&quot; == &quot;manual&quot; ]</span><br><span class="line">      then</span><br><span class="line">        echo &quot;######################################################################&quot;</span><br><span class="line">        echo &quot;$(date) NooBaa: Waiting for manual intervention (NOOBAA_INIT_MODE=manual)&quot;</span><br><span class="line">        echo &quot;######################################################################&quot;</span><br><span class="line">        echo -e &quot;\n&quot;</span><br><span class="line">        sleep 10</span><br><span class="line">        # will re-enter the inner loop and reload the mode</span><br><span class="line">      else</span><br><span class="line">        [ ! -z &quot;$mode&quot; ] &amp;&amp; echo &quot;NooBaa: unrecognized NOOBAA_INIT_MODE = $mode&quot;</span><br><span class="line">        return $rc</span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="noobaa-db-pg-0"><a href="#noobaa-db-pg-0" class="headerlink" title="noobaa-db-pg-0"></a>noobaa-db-pg-0</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> volume</span></span><br><span class="line">/var/lib/pgsql from db (rw)</span><br><span class="line">db:</span><br><span class="line">  Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)</span><br><span class="line">  ClaimName:  db-noobaa-db-pg-0</span><br><span class="line">  ReadOnly:   false</span><br></pre></td></tr></table></figure><h2 id="serivice"><a href="#serivice" class="headerlink" title="serivice"></a>serivice</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                    AGE</span><br><span class="line">noobaa-db-pg    ClusterIP      None            &lt;none&gt;        5432/TCP                                                   2m15s</span><br><span class="line">noobaa-mgmt     ClusterIP      10.97.139.113   &lt;none&gt;        80/TCP,443/TCP,8445/TCP,8446/TCP                           2m14s</span><br><span class="line">noobaa-syslog   ClusterIP      10.102.80.226   &lt;none&gt;        514/UDP                                                    2m11s</span><br><span class="line">s3              LoadBalancer   10.110.97.124   &lt;pending&gt;     80:32292/TCP,443:32034/TCP,8444:31155/TCP,7004:30222/TCP   2m14s</span><br><span class="line">sts             LoadBalancer   10.103.219.22   &lt;pending&gt;     443:30126/TCP                                              2m13s</span><br></pre></td></tr></table></figure><h2 id="volume"><a href="#volume" class="headerlink" title="volume"></a>volume</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">noobaa-db-noobaa-db-pg-0</span><br><span class="line">noobaa-noobaa-default-backing-store-noobaa-pvc-07c805ab</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mountpod</span> </span><br><span class="line">dingofs-ubuntu2-pvc-ef31f21c-5677-4f83-94ad-face89b741c3-lhenuc</span><br><span class="line">dingofs-ubuntu3-pvc-10fd093a-0d75-45ee-b52d-84f712378e09-jbxeue</span><br></pre></td></tr></table></figure><h2 id="systemc-info"><a href="#systemc-info" class="headerlink" title="systemc info"></a>systemc info</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NOOBAA_SECRET=$(kubectl get noobaa noobaa -n noobaa -o json | jq -r &#x27;.status.accounts.admin.secretRef.name&#x27; )</span><br><span class="line">noobaa-admin</span><br><span class="line"></span><br><span class="line">NOOBAA_MGMT=$(kubectl get noobaa noobaa -n noobaa -o json | jq -r &#x27;.status.services.serviceMgmt.nodePorts[0]&#x27; )</span><br><span class="line">https://10.xx.xx.18:0</span><br><span class="line"></span><br><span class="line">NOOBAA_S3=$(kubectl get noobaa noobaa -n noobaa -o json | jq -r &#x27;.status.services.serviceS3.nodePorts[0]&#x27; )</span><br><span class="line">https://10.xx.xx.18:30478   # entrypoint</span><br><span class="line"></span><br><span class="line">NOOBAA_ACCESS_KEY=$(kubectl get secret noobaa-admin -n noobaa -o json | jq -r &#x27;.data.AWS_ACCESS_KEY_ID|@base64d&#x27;)</span><br><span class="line">3gR59xxxxxHBbOdOx</span><br><span class="line"></span><br><span class="line">NOOBAA_SECRET_KEY=$(kubectl get secret noobaa-admin -n noobaa -o json | jq -r &#x27;.data.AWS_SECRET_ACCESS_KEY|@base64d&#x27;)</span><br><span class="line">zu229xxxxxxxxxxxxxxxxxxxxxxxxcfX</span><br></pre></td></tr></table></figure><h2 id="Mgmt-UI"><a href="#Mgmt-UI" class="headerlink" title="Mgmt UI"></a>Mgmt UI</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret noobaa-admin -n noobaa -o json | jq &#x27;.data|map_values(@base64d)&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span></span> </span><br><span class="line">&#123;</span><br><span class="line">  &quot;AWS_ACCESS_KEY_ID&quot;: &quot;3gR59eoLoBvhjHBbOdOx&quot;,</span><br><span class="line">  &quot;AWS_SECRET_ACCESS_KEY&quot;: &quot;zu229aAJIo6g9GOsjKTyUc6p3Rc0c/nHGdjI3cfX&quot;,</span><br><span class="line">  &quot;email&quot;: &quot;admin@noobaa.io&quot;,</span><br><span class="line">  &quot;password&quot;: &quot;7JfrgTXgnJjU4ywSFWYr+Q==&quot;,</span><br><span class="line">  &quot;system&quot;: &quot;noobaa&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">open $NOOBAA_MGMT</span><br></pre></td></tr></table></figure><h2 id="aws-cli"><a href="#aws-cli" class="headerlink" title="aws-cli"></a>aws-cli</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alias s3=&#x27;AWS_ACCESS_KEY_ID=3gR5xxxxxxxxOx AWS_SECRET_ACCESS_KEY=zu229aAJxxxxxxxxxxxxxxxxxcfX aws --endpoint https://10.xxx.xx.18:30478 --no-verify-ssl s3&#x27;</span><br><span class="line">s3 ls</span><br><span class="line">s3 sync /var/log/ s3://first.bucket</span><br><span class="line">s3 ls s3://first.bucket</span><br></pre></td></tr></table></figure><h1 id="NSFS"><a href="#NSFS" class="headerlink" title="NSFS"></a>NSFS</h1><h2 id="1-create-NSFS-resource"><a href="#1-create-NSFS-resource" class="headerlink" title="1. create NSFS resource"></a>1. create NSFS resource</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa namespacestore create nsfs dingofs --pvc-name=&#x27;noobaa-nsfs-pvc&#x27;</span><br></pre></td></tr></table></figure><p><strong>nsfs-dingofs-pvc.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nsfs-dingofs-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">noobaa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">dingofs-sc-s3</span></span><br></pre></td></tr></table></figure><p><strong>delete</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa namespacestore delete dingofs-nsfs</span><br></pre></td></tr></table></figure><p><strong>list</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa namespacestore list</span><br></pre></td></tr></table></figure><h2 id="2-create-bucket-optional"><a href="#2-create-bucket-optional" class="headerlink" title="2. create bucket (optional)"></a>2. create bucket (optional)</h2><blockquote><p>è¯¥æ­¥éª¤ä¸»è¦ç”¨äºè®¾ç½®æ–‡ä»¶ç³»ç»Ÿå·²æœ‰çš„ç›®å½•ä¸º bucket ï¼Œå¦‚æœå·²ä½¿ç”¨ s3-user-dingofs mb s3://dingofs-bucket-1 åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºç›®å½•ï¼Œåˆ™æ— éœ€æ‰§è¡Œæ­¤æ­¥éª¤ï¼ˆå¦åˆ™ä¼šæç¤ºbucketå·²å­˜åœ¨ï¼‰ã€‚åç»­ç›´æ¥ä½¿ç”¨  s3-user-dingofs è¿›è¡Œ bucket çš„æ“ä½œå³å¯</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ˜ å°„æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½• dingofs-bucket-1 ä¸º bucket</span></span><br><span class="line">noobaa api bucket_api create_bucket &#x27;&#123;</span><br><span class="line">  &quot;name&quot;: &quot;dingofs-bucket-1&quot;,</span><br><span class="line">  &quot;namespace&quot;:&#123;</span><br><span class="line">    &quot;write_resource&quot;: &#123; &quot;resource&quot;: &quot;dingofs&quot;, &quot;path&quot;: &quot;dingofs-bucket-1/&quot; &#125;,</span><br><span class="line">    &quot;read_resources&quot;: [ &#123; &quot;resource&quot;: &quot;dingofs&quot;, &quot;path&quot;: &quot;dingofs-bucket-1/&quot; &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p><strong>status</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa bucket status &lt;bucketName&gt;</span><br></pre></td></tr></table></figure><p><strong>list bucket</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">noobaa api bucket_api list_buckets &#x27;&#123;&#125;&#x27;</span><br><span class="line">or </span><br><span class="line">noobaa bucket list</span><br></pre></td></tr></table></figure><p><strong>get_bucket_policy</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noobaa api bucket_api get_bucket_policy &#x27;&#123;&quot;name&quot;: &quot;&lt;bucketName&gt;&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure><p><strong>delete bucket</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">noobaa api bucket_api delete_bucket &#x27;&#123;&quot;name&quot;: &quot;&lt;bucketName&gt;&quot;&#125;&#x27;</span><br><span class="line">or </span><br><span class="line">noobaa bucket delete &lt;bucketName&gt;</span><br></pre></td></tr></table></figure><h3 id="add-bucket-policy"><a href="#add-bucket-policy" class="headerlink" title="add bucket policy"></a>add bucket policy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®bucketè®¿é—®ç­–ç•¥åªèƒ½ä½¿ç”¨ admin è´¦å·</span></span><br><span class="line">AWS_ACCESS_KEY_ID=3gR59eoxxxxBbOdOx AWS_SECRET_ACCESS_KEY=zu229aAJIxxxxxxxxxxxdjI3cfX aws --endpoint-url=https://10.220.32.18:30478 --no-verify-ssl s3api put-bucket-policy --bucket dingofs-bucket-1 --policy file://policy.json</span><br></pre></td></tr></table></figure><p><strong>policy.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;Version&quot;</span>:<span class="string">&quot;2025-06-25&quot;</span>,</span><br><span class="line"><span class="attr">&quot;Statement&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="attr">&quot;Sid&quot;</span>:<span class="string">&quot;id-1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span>:<span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Principal&quot;</span>:<span class="string">&quot;*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Action&quot;</span>:[<span class="string">&quot;s3:*&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span>:[<span class="string">&quot;arn:aws:s3:::*&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>Sid</code> (Statement ID) serves as an optional identifier for individual policy statements, allowing for easier management and referencing of specific rules within a larger policy. Itâ€™s a way to give a unique name to each permission set within the bucket policy, which can be helpful when dealing with multiple statements or when debugging policy issues</p></blockquote><h2 id="3-create-account"><a href="#3-create-account" class="headerlink" title="3. create account"></a>3. create account</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">noobaa api account_api create_account &#x27;&#123;</span><br><span class="line">    &quot;email&quot;: &quot;dingofs@zetyun.com&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;dingofs&quot;,</span><br><span class="line">    &quot;has_login&quot;: false,</span><br><span class="line">    &quot;s3_access&quot;: true,</span><br><span class="line">    &quot;default_resource&quot;: &quot;dingofs&quot;,</span><br><span class="line">    &quot;nsfs_account_config&quot;: &#123;</span><br><span class="line">      &quot;uid&quot;: 0,</span><br><span class="line">      &quot;gid&quot;: 0,</span><br><span class="line">      &quot;new_buckets_path&quot;: &quot;/&quot;,</span><br><span class="line">      &quot;nsfs_only&quot;: false</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;&#x27;</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span></span> </span><br><span class="line">access_keys:</span><br><span class="line">access_key: UanhXoxxxxxIggJP</span><br><span class="line">secret_key: ptsSJUYxxxxxxxx2SF8ltV</span><br><span class="line">token: eyJhbGcixxxxxxxxxxxxxxxxxxxxxxxxxxxxxqGdB-E2zQF-3MBII</span><br></pre></td></tr></table></figure><ul><li>check account<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">noobaa api account_api list_accounts &#123;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> check specify accout</span></span><br><span class="line">noobaa api account_api read_account &#x27;&#123;&quot;email&quot;:&quot;jenia@noobaa.io&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure></li></ul><h2 id="4-config-s3-client"><a href="#4-config-s3-client" class="headerlink" title="4. config s3 client"></a>4. config s3 client</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias s3-user-dingofs=&#x27;AWS_ACCESS_KEY_ID=UanhxxxxxxggJP AWS_SECRET_ACCESS_KEY=ptsSJUYVCxxxxxxxxxxxSF8ltV aws --endpoint https://10.220.32.18:30478  --no-verify-ssl s3&#x27;</span><br></pre></td></tr></table></figure><h2 id="5-operate"><a href="#5-operate" class="headerlink" title="5. operate"></a>5. operate</h2><p><strong>aws s3</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> create bucket</span></span><br><span class="line">s3-user-dingofs mb s3://&lt;bucketName&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> copy object</span> </span><br><span class="line">s3-user-dingofs cp &lt;file&gt; s3://&lt;bucketName&gt;/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> list object</span> </span><br><span class="line">s3-user-dingofs ls s3://&lt;bucketName&gt;/</span><br></pre></td></tr></table></figure><p><strong>mc</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mc alias set &lt;aliasName&gt; &lt;entrypoint&gt; &lt;ak&gt; &lt;sk&gt; --insecure</span><br><span class="line">mc ls &lt;aliasName&gt; --insecure</span><br></pre></td></tr></table></figure><h1 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h1><h2 id="External-Postgresql-DB-TBD"><a href="#External-Postgresql-DB-TBD" class="headerlink" title="External Postgresql DB (TBD)"></a>External Postgresql DB (TBD)</h2><ul><li><p>binary install</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">sudo dnf -qy module disable postgresql</span><br><span class="line">sudo dnf install -y postgresql17-server</span><br><span class="line">sudo /usr/pgsql-17/bin/postgresql-17-setup initdb</span><br><span class="line">sudo systemctl enable postgresql-17</span><br><span class="line">sudo systemctl start postgresql-17</span><br></pre></td></tr></table></figure></li><li><p>docker install</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 17 version</span></span><br><span class="line">docker run --name noobaa-postgres \</span><br><span class="line">  -e POSTGRES_PASSWORD=&lt;&gt; \</span><br><span class="line">  --restart always \</span><br><span class="line">  --network host \</span><br><span class="line">  -d dockerproxy.zetyun.cn/docker.io/postgres:latest</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 15 version</span></span><br><span class="line">docker run --name noobaa-postgres \</span><br><span class="line">  -e POSTGRESQL_ADMIN_PASSWORD=&lt;&gt; \</span><br><span class="line">  --restart always \</span><br><span class="line">  --network host \</span><br><span class="line">  -d quay.io/sclorg/postgresql-15-c9s:latest</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enter psql</span></span><br><span class="line">psql -U postgres</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> create nbcore database</span></span><br><span class="line">CREATE DATABASE nbcore WITH LC_COLLATE = &#x27;C&#x27; TEMPLATE template0;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span> </span><br><span class="line">\list</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> db url</span> </span><br><span class="line">postgres://postgres:&lt;mysecretpassword&gt;@&lt;ip&gt;:5432/nbcore&quot;</span><br></pre></td></tr></table></figure><blockquote><p>use postgres 15, should config </p><p>variables:                                                               </p><p>POSTGRESQL_USER POSTGRESQL_PASSWORD POSTGRESQL_DATABASE     </p><p>Or the following environment variable:                                                 </p><p>POSTGRESQL_ADMIN_PASSWORD                                                       </p><p>Or both.  </p></blockquote></li></ul><h1 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h1><h2 id="entrypointçš„loadbalance"><a href="#entrypointçš„loadbalance" class="headerlink" title="entrypointçš„loadbalance"></a>entrypointçš„loadbalance</h2><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><h2 id="éªŒè¯-install-æ—¶å€™ä½¿ç”¨-â€“db-storage-class-å’Œ-â€“pv-pool-default-storage-class-æŒ‡å®šé»˜è®¤sc"><a href="#éªŒè¯-install-æ—¶å€™ä½¿ç”¨-â€“db-storage-class-å’Œ-â€“pv-pool-default-storage-class-æŒ‡å®šé»˜è®¤sc" class="headerlink" title="éªŒè¯ install æ—¶å€™ä½¿ç”¨ â€“db-storage-class å’Œ â€“pv-pool-default-storage-class æŒ‡å®šé»˜è®¤sc"></a>éªŒè¯ install æ—¶å€™ä½¿ç”¨ â€“db-storage-class å’Œ â€“pv-pool-default-storage-class æŒ‡å®šé»˜è®¤sc</h2><blockquote><p>ä¸è®¾ç½® storageclass.kubernetes.io/is-default-class: â€œtrueâ€ çš„ default sc</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Terminology&quot;&gt;&lt;a href=&quot;#Terminology&quot; class=&quot;headerlink&quot; title=&quot;Terminology&quot;&gt;&lt;/a&gt;Terminology&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;NSFS&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;NSFS </summary>
      
    
    
    
    <category term="noobaa" scheme="https://www.willshirley.top/categories/noobaa/"/>
    
    
    <category term="s3" scheme="https://www.willshirley.top/tags/s3/"/>
    
  </entry>
  
  <entry>
    <title>aws cli</title>
    <link href="https://www.willshirley.top/2025/06/24/aws%20cli/"/>
    <id>https://www.willshirley.top/2025/06/24/aws%20cli/</id>
    <published>2025-06-24T03:28:21.000Z</published>
    <updated>2025-07-22T02:45:38.454Z</updated>
    
    <content type="html"><![CDATA[<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot; -o &quot;awscliv2.zip&quot;</span><br><span class="line">unzip awscliv2.zip</span><br><span class="line">sudo ./aws/install</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;install&quot;&gt;&lt;a href=&quot;#install&quot; class=&quot;headerlink&quot; title=&quot;install&quot;&gt;&lt;/a&gt;install&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="aws cli" scheme="https://www.willshirley.top/categories/aws-cli/"/>
    
    
    <category term="tool" scheme="https://www.willshirley.top/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>cmake learn</title>
    <link href="https://www.willshirley.top/2025/06/17/cmake%20learn/"/>
    <id>https://www.willshirley.top/2025/06/17/cmake%20learn/</id>
    <published>2025-06-17T07:09:24.000Z</published>
    <updated>2025-07-23T02:29:22.544Z</updated>
    
    <content type="html"><![CDATA[<h1 id="default"><a href="#default" class="headerlink" title="default"></a>default</h1><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_CURRENT_SOURCE_DIR</span><br><span class="line">PROJECT_SOURCE_DIR</span><br></pre></td></tr></table></figure><p>**CMAKE_CURRENT_SOURCE_DIR **</p><p>The path to the source directory currently being processed.</p><p>This is the full path to the source directory that is currently being processed by cmake.</p><p><strong>PROJECT_SOURCE_DIR</strong></p><p>This is the source directory of the last call to the project() command made in the current directory scope or one of its parents. Note, it is not affected by calls to project() made within a child directory scope (i.e. from within a call to add_subdirectory()  from the current scope).</p><ul><li>When run in <a href="https://cmake.org/cmake/help/v3.31/manual/cmake.1.html#cmdoption-cmake-P"><code>cmake -P</code></a> script mode, CMake sets the variables <code>CMAKE_BINARY_DIR</code>, <code>CMAKE_SOURCE_DIR</code>, <code>CMAKE_CURRENT_BINARY_DIR</code> and <code>CMAKE_CURRENT_SOURCE_DIR</code> to the current working directory.</li></ul><h1 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h1><p><strong><code>PUBLIC</code></strong></p><p>Populates both properties for <a href="https://cmake.org/cmake/help/v3.31/manual/cmake-buildsystem.7.html#target-build-specification">building</a> and properties for <a href="https://cmake.org/cmake/help/v3.31/manual/cmake-buildsystem.7.html#target-usage-requirements">using</a> a target.</p><p><strong><code>PRIVATE</code></strong></p><p>Populates only properties for <a href="https://cmake.org/cmake/help/v3.31/manual/cmake-buildsystem.7.html#target-build-specification">building</a> a target.</p><p><strong><code>INTERFACE</code></strong></p><p>Populates only properties for <a href="https://cmake.org/cmake/help/v3.31/manual/cmake-buildsystem.7.html#target-usage-requirements">using</a> a target.</p><ul><li>Remember <code>INTERFACE</code> means things that consumers require but the producer doesnâ€™t.</li></ul><h1 id="syntax"><a href="#syntax" class="headerlink" title="syntax"></a>syntax</h1><h2 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>()</span><br><span class="line"><span class="keyword">cmake_minimum_required</span>()</span><br><span class="line"><span class="keyword">project</span>()</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"><span class="keyword">project</span>(Tutorial VERSION <span class="number">2.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the variable</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tells CMake to create an executable using the specified source code files</span></span><br><span class="line"><span class="keyword">add_executable</span>(Tutorial tutorial.cxx)</span><br></pre></td></tr></table></figure><h3 id="configure-file"><a href="#configure-file" class="headerlink" title="configure_file"></a>configure_file</h3><blockquote><p>copy the input file with the specified CMake variables replaced</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copies an &lt;input&gt; file to an &lt;output&gt; file </span></span><br><span class="line"><span class="keyword">configure_file</span>(&lt;input&gt; &lt;output&gt;)</span><br></pre></td></tr></table></figure><h3 id="target-include-directories"><a href="#target-include-directories" class="headerlink" title="target_include_directories"></a>target_include_directories</h3><blockquote><p>specify where the executable target should look for include files</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_include_directories</span>(Tutorial PUBLIC <span class="string">&quot;$&#123;PROJECT_BINARY_DIR&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="Adding-a-Library"><a href="#Adding-a-Library" class="headerlink" title="Adding a Library"></a>Adding a Library</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>()</span><br><span class="line"><span class="keyword">add_subdirectory</span>()</span><br><span class="line"><span class="keyword">target_include_directories</span>()</span><br><span class="line"><span class="keyword">target_link_libraries</span>()</span><br></pre></td></tr></table></figure><h3 id="add-library"><a href="#add-library" class="headerlink" title="add_library"></a>add_library</h3><blockquote><p>Add a library target called <code>&lt;name&gt;</code> to be built from the source files listed in the command invocation</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(MathFunctions MathFunctions.cxx mysqrt.cxx)</span><br></pre></td></tr></table></figure><h3 id="add-subdirectory"><a href="#add-subdirectory" class="headerlink" title="add_subdirectory"></a>add_subdirectory</h3><blockquote><p>make use of the new library call</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(MathFunctions)</span><br></pre></td></tr></table></figure><h2 id="Adding-Usage-Requirements-for-a-Library"><a href="#Adding-Usage-Requirements-for-a-Library" class="headerlink" title="Adding Usage Requirements for a Library"></a>Adding Usage Requirements for a Library</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_compile_definitions</span>()</span><br><span class="line"><span class="keyword">target_compile_options</span>()</span><br><span class="line"><span class="keyword">target_include_directories</span>()</span><br><span class="line"><span class="keyword">target_link_directories</span>()</span><br><span class="line"><span class="keyword">target_link_options</span>()</span><br><span class="line">target_precompile_headers()</span><br><span class="line"><span class="keyword">target_sources</span>()</span><br><span class="line"><span class="keyword">add_library</span>()</span><br><span class="line"><span class="keyword">target_compile_features</span>()</span><br><span class="line"><span class="keyword">target_link_libraries</span>()</span><br></pre></td></tr></table></figure><h2 id="Adding-Generator-Expressions"><a href="#Adding-Generator-Expressions" class="headerlink" title="Adding Generator Expressions"></a>Adding Generator Expressions</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmake-generator-expressions(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">cmake_minimum_required</span>()</span><br><span class="line"><span class="keyword">set</span>()</span><br><span class="line"><span class="keyword">target_compile_options</span>()</span><br></pre></td></tr></table></figure><h2 id="Installing-and-Testing"><a href="#Installing-and-Testing" class="headerlink" title="Installing and Testing"></a>Installing and Testing</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>()</span><br></pre></td></tr></table></figure><h2 id="Adding-System-Introspection"><a href="#Adding-System-Introspection" class="headerlink" title="Adding System Introspection"></a>Adding System Introspection</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Packaging-an-Installer"><a href="#Packaging-an-Installer" class="headerlink" title="Packaging an Installer"></a>Packaging an Installer</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpack</span><br></pre></td></tr></table></figure><h2 id="Selecting-Static-or-Shared-Libraries"><a href="#Selecting-Static-or-Shared-Libraries" class="headerlink" title="Selecting Static or Shared Libraries"></a>Selecting Static or Shared Libraries</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span>(BUILD_SHARED_LIBS <span class="string">&quot;Build using shared libraries&quot;</span> <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure><h2 id="Adding-Export-Configuration"><a href="#Adding-Export-Configuration" class="headerlink" title="Adding Export Configuration"></a>Adding Export Configuration</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;default&quot;&gt;&lt;a href=&quot;#default&quot; class=&quot;headerlink&quot; title=&quot;default&quot;&gt;&lt;/a&gt;default&lt;/h1&gt;&lt;figure class=&quot;highlight cmake&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="cmake" scheme="https://www.willshirley.top/categories/cmake/"/>
    
    
    <category term="tool" scheme="https://www.willshirley.top/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>c++ summary</title>
    <link href="https://www.willshirley.top/2025/06/07/c++%20summary/"/>
    <id>https://www.willshirley.top/2025/06/07/c++%20summary/</id>
    <published>2025-06-07T03:14:58.000Z</published>
    <updated>2025-07-02T03:05:48.356Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h1><p>C++ é‡Œç±»çš„å››å¤§å‡½æ•°ï¼šæ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€æ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼å‡½æ•°ã€‚C++11 å› ä¸ºå¼•å…¥äº†å³å€¼ï¼ˆRvalueï¼‰å’Œè½¬ç§»ï¼ˆMoveï¼‰ï¼Œåˆå¤šå‡ºäº†ä¸¤å¤§å‡½æ•°ï¼šè½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»èµ‹å€¼å‡½æ•°ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ç°ä»£ C++ é‡Œï¼Œä¸€ä¸ªç±»æ€»æ˜¯ä¼šæœ‰å…­å¤§åŸºæœ¬å‡½æ•°ï¼šä¸‰ä¸ªæ„é€ ã€ä¸¤ä¸ªèµ‹å€¼ã€ä¸€ä¸ªææ„ã€‚</p><ul><li>åœ¨ C/C++ é‡Œï¼Œæ‰€æœ‰çš„å‡½æ•°éƒ½æ˜¯å…¨å±€çš„ï¼Œæ²¡æœ‰ç”Ÿå­˜å‘¨æœŸçš„æ¦‚å¿µï¼ˆstaticã€åå­—ç©ºé—´çš„ä½œç”¨å¾ˆå¼±ï¼Œåªæ˜¯ç®€å•é™åˆ¶äº†åº”ç”¨èŒƒå›´ï¼Œé¿å…åå­—å†²çªï¼‰ã€‚è€Œä¸”å‡½æ•°ä¹Ÿéƒ½æ˜¯å¹³çº§çš„ï¼Œä¸èƒ½åœ¨å‡½æ•°é‡Œå†å®šä¹‰å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸å®šä¹‰åµŒå¥—å‡½æ•°ã€å‡½æ•°å¥—å‡½æ•°ã€‚</li></ul><h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><h3 id="â€œå§”æ‰˜æ„é€ â€ï¼ˆdelegating-constructorï¼‰"><a href="#â€œå§”æ‰˜æ„é€ â€ï¼ˆdelegating-constructorï¼‰" class="headerlink" title="â€œå§”æ‰˜æ„é€ â€ï¼ˆdelegating constructorï¼‰"></a>â€œå§”æ‰˜æ„é€ â€ï¼ˆdelegating constructorï¼‰</h3><blockquote><p>ä½¿ç”¨â€œå§”æ‰˜æ„é€ â€çš„æ–°ç‰¹æ€§ï¼Œä¸€ä¸ªæ„é€ å‡½æ•°ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½æ•°ï¼ŒæŠŠæ„é€ å·¥ä½œâ€œå§”æ‰˜â€å‡ºå»ï¼Œæ—¢ç®€å•åˆé«˜æ•ˆã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoDelegating</span> <span class="keyword">final</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> a; <span class="comment">// æˆå‘˜å˜é‡</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DemoDelegating</span>(<span class="keyword">int</span> x) : <span class="built_in">a</span>(x) <span class="comment">// åŸºæœ¬çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DemoDelegating</span>() : <span class="comment">// æ— å‚æ•°çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">DemoDelegating</span>(<span class="number">0</span>) <span class="comment">// ç»™å‡ºé»˜è®¤å€¼ï¼Œå§”æ‰˜ç»™ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DemoDelegating</span>(<span class="keyword">const</span> string&amp; s) : <span class="comment">// å­—ç¬¦ä¸²å‚æ•°æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">DemoDelegating</span>(<span class="built_in">stoi</span>(s)) <span class="comment">// è½¬æ¢æˆæ•´æ•°ï¼Œå†å§”æ‰˜ç»™ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="â€œæˆå‘˜å˜é‡åˆå§‹åŒ–â€ï¼ˆIn-class-member-initializerï¼‰"><a href="#â€œæˆå‘˜å˜é‡åˆå§‹åŒ–â€ï¼ˆIn-class-member-initializerï¼‰" class="headerlink" title="â€œæˆå‘˜å˜é‡åˆå§‹åŒ–â€ï¼ˆIn-class member initializerï¼‰"></a>â€œæˆå‘˜å˜é‡åˆå§‹åŒ–â€ï¼ˆIn-class member initializerï¼‰</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoInit</span> <span class="keyword">final</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span>                 a = <span class="number">0</span>;</span><br><span class="line">    std::string         s = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt;    v&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DemoInit</span>() = <span class="keyword">default</span>;</span><br><span class="line">   ~<span class="built_in">DemoInit</span>() = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DemoInit</span>(<span class="keyword">int</span> x) : <span class="built_in">a</span>(x) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="â€œç±»å‹åˆ«åâ€ï¼ˆType-Aliasï¼‰"><a href="#â€œç±»å‹åˆ«åâ€ï¼ˆType-Aliasï¼‰" class="headerlink" title="â€œç±»å‹åˆ«åâ€ï¼ˆType Aliasï¼‰"></a>â€œç±»å‹åˆ«åâ€ï¼ˆType Aliasï¼‰</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">uint_t</span> = <span class="keyword">unsigned</span> <span class="keyword">int</span>; <span class="comment">// usingåˆ«å</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="keyword">uint_t</span>ï¼› <span class="comment">// ç­‰ä»·çš„typedef</span></span><br></pre></td></tr></table></figure><h2 id="lambda"><a href="#lambda" class="headerlink" title="lambda"></a>lambda</h2><blockquote><p>C++ æ²¡æœ‰ä¸º lambda è¡¨è¾¾å¼å¼•å…¥æ–°çš„å…³é”®å­—ï¼Œå¹¶æ²¡æœ‰â€œlambdaâ€è¿™æ ·çš„è¯æ±‡ï¼Œè€Œæ˜¯ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„å½¢å¼â€œ[]â€ï¼Œæœ¯è¯­å«â€œlambda å¼•å‡ºç¬¦â€ï¼ˆlambda introducerï¼‰ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lambda è¡¨è¾¾å¼ç¤ºä¾‹</span></span><br><span class="line">auto f1 = [](&lt;å…¥å£å‚æ•°&gt;)&#123;å‡½æ•°ä½“&#125;; </span><br></pre></td></tr></table></figure><ul><li>lambdaè¡¨è¾¾å¼èµ‹å€¼å¿…é¡»ç”¨autoï¼ˆä½†autoä¸èƒ½ç”¨åœ¨ç±»æˆå‘˜åˆå§‹åŒ–ï¼‰</li><li>lambda è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œèƒ½å¤Ÿåƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ï¼Œåƒå˜é‡ä¸€æ ·è¢«ä¼ é€’</li><li>æ•è·å¼•ç”¨æ—¶å¿…é¡»è¦æ³¨æ„å¤–éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢å˜é‡å¤±æ•ˆ</li></ul><p><strong>å˜é‡æ•è·</strong></p><ul><li><code>[=]</code>è¡¨ç¤ºæŒ‰å€¼æ•è·æ‰€æœ‰å¤–éƒ¨å˜é‡ï¼Œè¡¨è¾¾å¼å†…éƒ¨æ˜¯å€¼çš„æ‹·è´ï¼Œå¹¶ä¸”ä¸èƒ½ä¿®æ”¹</li><li><code>[&amp;]</code>æ˜¯æŒ‰å¼•ç”¨æ•è·æ‰€æœ‰å¤–éƒ¨å˜é‡ï¼Œå†…éƒ¨ä»¥å¼•ç”¨çš„æ–¹å¼ä½¿ç”¨ï¼Œå¯ä»¥ä¿®æ”¹</li></ul><h1 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h1><blockquote><p>å°½é‡ä¸è¦å†ä½¿ç”¨è£¸æŒ‡é’ˆã€new å’Œ delete æ¥æ“ä½œå†…å­˜</p></blockquote><h2 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h2><ul><li>å°½é‡ä¸è¦å¯¹ unique_ptr æ‰§è¡Œèµ‹å€¼æ“ä½œå°±å¥½äº†ï¼Œè®©å®ƒâ€œè‡ªç”Ÿè‡ªç­â€ï¼Œå®Œå…¨è‡ªåŠ¨åŒ–ç®¡ç†ã€‚</li></ul><h2 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h2><ul><li>shared_ptr æ”¯æŒå®‰å…¨å…±äº«çš„ç§˜å¯†åœ¨äºå†…éƒ¨ä½¿ç”¨äº†â€œå¼•ç”¨è®¡æ•°â€</li><li>å› ä¸º shared_ptr å…·æœ‰å®Œæ•´çš„â€œå€¼è¯­ä¹‰â€ï¼ˆå³å¯ä»¥æ‹·è´èµ‹å€¼ï¼‰ï¼Œæ‰€ä»¥ï¼Œå®ƒå¯ä»¥åœ¨ä»»ä½•åœºåˆæ›¿ä»£åŸå§‹æŒ‡é’ˆï¼Œè€Œä¸ç”¨å†æ‹…å¿ƒèµ„æºå›æ”¶çš„é—®é¢˜ï¼Œæ¯”å¦‚ç”¨äºå®¹å™¨å­˜å‚¨æŒ‡é’ˆã€ç”¨äºå‡½æ•°å®‰å…¨è¿”å›åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡ï¼Œç­‰ç­‰</li></ul><h1 id="å®¹å™¨"><a href="#å®¹å™¨" class="headerlink" title="å®¹å™¨"></a>å®¹å™¨</h1><ul><li>å®¹å™¨éƒ½å…·æœ‰çš„ä¸€ä¸ªåŸºæœ¬ç‰¹æ€§ï¼šå®ƒä¿å­˜å…ƒç´ é‡‡ç”¨çš„æ˜¯â€œå€¼â€ï¼ˆvalueï¼‰è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨é‡Œå­˜å‚¨çš„æ˜¯å…ƒç´ çš„æ‹·è´ã€å‰¯æœ¬ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚ä»è¿™ä¸ªåŸºæœ¬ç‰¹æ€§å¯ä»¥å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼Œå®¹å™¨æ“ä½œå…ƒç´ çš„å¾ˆå¤§ä¸€å—æˆæœ¬å°±æ˜¯å€¼çš„æ‹·è´ã€‚æ‰€ä»¥ï¼Œå¦‚æœå…ƒç´ æ¯”è¾ƒå¤§ï¼Œæˆ–è€…éå¸¸å¤šï¼Œé‚£ä¹ˆæ“ä½œæ—¶çš„æ‹·è´å¼€é”€å°±ä¼šå¾ˆé«˜ï¼Œæ€§èƒ½ä¹Ÿå°±ä¸ä¼šå¤ªå¥½ã€‚</li><li>å°½é‡ä¸ºå…ƒç´ å®ç°è½¬ç§»æ„é€ å’Œè½¬ç§»èµ‹å€¼å‡½æ•°</li><li>ä¾æ®å…ƒç´ çš„è®¿é—®æ–¹å¼ï¼Œåˆ†æˆé¡ºåºå®¹å™¨ã€æœ‰åºå®¹å™¨å’Œæ— åºå®¹å™¨ä¸‰å¤§ç±»åˆ«</li></ul><h2 id="é¡ºåºå®¹å™¨"><a href="#é¡ºåºå®¹å™¨" class="headerlink" title="é¡ºåºå®¹å™¨"></a>é¡ºåºå®¹å™¨</h2><img src="/images/c++/c++-container.jpeg" style="zoom: 50%"><p>é¡ºåºå®¹å™¨å°±æ˜¯æ•°æ®ç»“æ„é‡Œçš„çº¿æ€§è¡¨ï¼Œä¸€å…±æœ‰ 5 ç§ï¼š<code>array</code>ã€<code>vector</code>ã€<code>deque</code>ã€<code>list</code>ã€<code>forward_list</code>ï¼ŒæŒ‰ç…§å­˜å‚¨ç»“æ„ï¼Œè¿™ 5 ç§å®¹å™¨åˆå¯ä»¥å†ç»†åˆ†æˆä¸¤ç»„ã€‚</p><p>è¿ç»­å­˜å‚¨çš„æ•°ç»„ï¼š<code>array</code>ã€<code>vector</code> å’Œ <code>deque</code>ã€‚</p><p>æŒ‡é’ˆç»“æ„çš„é“¾è¡¨ï¼š<code>list</code> å’Œ <code>forward_list</code>ã€‚</p><ul><li><p><code>array</code> å’Œ <code>vector</code> ç›´æ¥å¯¹åº” C çš„å†…ç½®æ•°ç»„ï¼Œå†…å­˜å¸ƒå±€ä¸ C å®Œå…¨å…¼å®¹ï¼Œæ‰€ä»¥æ˜¯å¼€é”€æœ€ä½ã€é€Ÿåº¦æœ€å¿«çš„å®¹å™¨ã€‚å®ƒä»¬ä¸¤ä¸ªçš„åŒºåˆ«åœ¨äºå®¹é‡èƒ½å¦åŠ¨æ€å¢é•¿ã€‚array æ˜¯é™æ€æ•°ç»„ï¼Œå¤§å°åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å›ºå®šäº†ï¼Œä¸èƒ½å†å®¹çº³æ›´å¤šçš„å…ƒç´ ã€‚è€Œ vector æ˜¯åŠ¨æ€æ•°ç»„ï¼Œè™½ç„¶åˆå§‹åŒ–çš„æ—¶å€™è®¾å®šäº†å¤§å°ï¼Œä½†å¯ä»¥åœ¨åé¢éšéœ€å¢é•¿ï¼Œå®¹çº³ä»»æ„æ•°é‡çš„å…ƒç´ ã€‚</p></li><li><p><code>deque</code> ä¹Ÿæ˜¯ä¸€ç§å¯ä»¥åŠ¨æ€å¢é•¿çš„æ•°ç»„ï¼Œå®ƒå’Œ<code>vector</code> çš„åŒºåˆ«æ˜¯ï¼Œå®ƒå¯ä»¥åœ¨ä¸¤ç«¯é«˜æ•ˆåœ°æ’å…¥åˆ é™¤å…ƒç´ ï¼Œè¿™ä¹Ÿæ˜¯å®ƒçš„åå­— double-end queue çš„æ¥å†ï¼Œè€Œ <code>vector</code> åˆ™åªèƒ½ç”¨ push_back åœ¨æœ«ç«¯è¿½åŠ å…ƒç´ ã€‚</p></li><li><p><code>vector</code> å’Œ <code>deque</code> é‡Œçš„å…ƒç´ å› ä¸ºæ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæ‰€ä»¥åœ¨ä¸­é—´çš„æ’å…¥åˆ é™¤æ•ˆç‡å°±å¾ˆä½ï¼Œè€Œ <code>list</code>å’Œ <code>forward_list</code> æ˜¯é“¾è¡¨ç»“æ„ï¼Œæ’å…¥åˆ é™¤æ“ä½œåªéœ€è¦è°ƒæ•´æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨ä»»æ„ä½ç½®çš„æ“ä½œéƒ½å¾ˆé«˜æ•ˆã€‚</p></li><li><p>é“¾è¡¨çš„ç¼ºç‚¹æ˜¯æŸ¥æ‰¾æ•ˆç‡ä½ï¼Œåªèƒ½æ²¿ç€æŒ‡é’ˆé¡ºåºè®¿é—®ï¼Œè¿™æ–¹é¢ä¸å¦‚ <code>vector</code> éšæœºè®¿é—®çš„æ•ˆç‡é«˜ã€‚<code>list</code> æ˜¯åŒå‘é“¾è¡¨ï¼Œå¯ä»¥å‘å‰æˆ–è€…å‘åéå†ï¼Œè€Œ <code>forward_list</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯å•å‘é“¾è¡¨ï¼Œåªèƒ½å‘å‰éå†ï¼ŒæŸ¥æ‰¾æ•ˆç‡å°±æ›´ä½äº†</p></li><li><p>é“¾è¡¨ç»“æ„æ¯”èµ·æ•°ç»„ç»“æ„è¿˜æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å­˜å‚¨æˆæœ¬ç•¥é«˜ï¼Œå› ä¸ºå¿…é¡»è¦ä¸ºæ¯ä¸ªå…ƒç´ é™„åŠ ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªçš„æŒ‡é’ˆï¼ŒæŒ‡å‘é“¾è¡¨çš„å‰åèŠ‚ç‚¹ã€‚</p></li><li><p>å½“ <code>vector</code> çš„å®¹é‡åˆ°è¾¾ä¸Šé™çš„æ—¶å€™ï¼ˆcapacityï¼‰ï¼Œå®ƒä¼šå†åˆ†é…ä¸€å—ä¸¤å€å¤§å°çš„æ–°å†…å­˜ï¼Œç„¶åæŠŠæ—§å…ƒç´ æ‹·è´æˆ–è€…ç§»åŠ¨è¿‡å»ã€‚è¿™ä¸ªæ“ä½œçš„æˆæœ¬æ˜¯éå¸¸å¤§çš„ï¼Œæ‰€ä»¥ï¼Œä½ åœ¨ä½¿ç”¨ <code>vector</code> çš„æ—¶å€™æœ€å¥½èƒ½å¤Ÿâ€œé¢„ä¼°â€å®¹é‡ï¼Œä½¿ç”¨ reserve æå‰åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ï¼Œå‡å°‘åŠ¨æ€æ‰©å®¹çš„æ‹·è´ä»£ä»·ã€‚</p></li><li><p><code>vector</code> çš„åšæ³•å¤ªâ€œæ¿€è¿›â€ï¼Œè€Œ <code>deque</code>ã€<code>list</code> çš„çš„æ‰©å®¹ç­–ç•¥å°±â€œä¿å®ˆâ€å¤šäº†ï¼Œåªä¼šæŒ‰ç…§å›ºå®šçš„â€œæ­¥é•¿â€ï¼ˆä¾‹å¦‚ N ä¸ªå­—èŠ‚ã€ä¸€ä¸ªèŠ‚ç‚¹ï¼‰å»å¢åŠ å®¹é‡ã€‚ä½†åœ¨çŸ­æ—¶é—´å†…æ’å…¥å¤§é‡æ•°æ®çš„æ—¶å€™å°±ä¼šé¢‘ç¹åˆ†é…å†…å­˜ï¼Œæ•ˆæœåè€Œä¸å¦‚ <code>vector</code> ä¸€æ¬¡åˆ†é…æ¥å¾—å¥½ã€‚</p></li></ul><h2 id="æœ‰åºå®¹å™¨"><a href="#æœ‰åºå®¹å™¨" class="headerlink" title="æœ‰åºå®¹å™¨"></a>æœ‰åºå®¹å™¨</h2><p>é¡ºåºå®¹å™¨çš„ç‰¹ç‚¹æ˜¯ï¼Œå…ƒç´ çš„æ¬¡åºæ˜¯ç”±å®ƒæ’å…¥çš„æ¬¡åºè€Œå†³å®šçš„ï¼Œè®¿é—®å…ƒç´ ä¹Ÿå°±æŒ‰ç…§æœ€åˆæ’å…¥çš„é¡ºåºã€‚è€Œæœ‰åºå®¹å™¨åˆ™ä¸åŒï¼Œå®ƒçš„å…ƒç´ åœ¨æ’å…¥å®¹å™¨åå°±è¢«æŒ‰ç…§æŸç§è§„åˆ™è‡ªåŠ¨æ’åºï¼Œæ‰€ä»¥æ˜¯â€œæœ‰åºâ€çš„ã€‚C++ çš„æœ‰åºå®¹å™¨ä½¿ç”¨çš„æ˜¯æ ‘ç»“æ„ï¼Œé€šå¸¸æ˜¯çº¢é»‘æ ‘â€”â€”æœ‰ç€æœ€å¥½æŸ¥æ‰¾æ€§èƒ½çš„äºŒå‰æ ‘ã€‚</p><p>æ ‡å‡†åº“é‡Œä¸€å…±æœ‰å››ç§æœ‰åºå®¹å™¨ï¼š<code>set/multiset</code> å’Œ <code>map/multimap</code>ã€‚<code>set</code> æ˜¯é›†åˆï¼Œ<code>map</code> æ˜¯å…³è”æ•°ç»„ï¼ˆåœ¨å…¶ä»–è¯­è¨€é‡Œä¹Ÿå«â€œå­—å…¸â€ï¼‰ï¼Œæœ‰ multi å‰ç¼€çš„å®¹å™¨è¡¨ç¤ºå¯ä»¥å®¹çº³é‡å¤çš„ keyã€‚</p><h2 id="æ— åºå®¹å™¨"><a href="#æ— åºå®¹å™¨" class="headerlink" title="æ— åºå®¹å™¨"></a>æ— åºå®¹å™¨</h2><p>åˆ†åˆ«æ˜¯ <code>unordered_set/unordered_multiset</code>ã€<code>unordered_map/unordered_multimap</code>ã€‚æ— åºå®¹å™¨åŒæ ·ä¹Ÿæ˜¯é›†åˆå’Œå…³è”æ•°ç»„ï¼Œç”¨æ³•ä¸Šä¸æœ‰åºå®¹å™¨å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºå†…éƒ¨æ•°æ®ç»“æ„ï¼šå®ƒä¸æ˜¯çº¢é»‘æ ‘ï¼Œè€Œæ˜¯æ•£åˆ—è¡¨ï¼ˆä¹Ÿå«å“ˆå¸Œè¡¨ï¼Œhash tableï¼‰ã€‚å› ä¸ºå®ƒé‡‡ç”¨æ•£åˆ—è¡¨å­˜å‚¨æ•°æ®ï¼Œå…ƒç´ çš„ä½ç½®å–å†³äºè®¡ç®—çš„æ•£åˆ—å€¼ï¼Œæ²¡æœ‰è§„å¾‹å¯è¨€ï¼Œæ‰€ä»¥å°±æ˜¯â€œæ— åºâ€çš„ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œä¹±åºâ€å®¹å™¨ã€‚</p><h1 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h1><ul><li>ç®—æ³•å…¶å®å¹¶ä¸ç¥ç§˜ï¼Œå› ä¸ºæ‰€æœ‰çš„ç®—æ³•æœ¬è´¨ä¸Šéƒ½æ˜¯ for æˆ–è€… whileï¼Œé€šè¿‡å¾ªç¯éå†æ¥é€ä¸ªå¤„ç†å®¹å™¨é‡Œçš„å…ƒç´ ã€‚</li><li>è¿½æ±‚æ›´é«˜å±‚æ¬¡ä¸Šçš„æŠ½è±¡å’Œå°è£…</li><li>ç®—æ³•æ˜¯ä¸“é—¨æ“ä½œå®¹å™¨çš„å‡½æ•°ï¼Œæ˜¯ä¸€ç§â€œæ™ºèƒ½ for å¾ªç¯â€ï¼Œå®ƒçš„æœ€ä½³æ­æ¡£æ˜¯ lambda è¡¨è¾¾å¼</li></ul><h2 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h2><ul><li>ç®—æ³•åªèƒ½é€šè¿‡è¿­ä»£å™¨å»â€œé—´æ¥â€è®¿é—®å®¹å™¨ä»¥åŠå…ƒç´ ï¼Œç®—æ³•çš„èƒ½åŠ›æ˜¯ç”±è¿­ä»£å™¨å†³å®šçš„ã€‚</li><li>è¿­ä»£å™¨ä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚è¾“å…¥è¿­ä»£å™¨ã€è¾“å‡ºè¿­ä»£å™¨ã€åŒå‘è¿­ä»£å™¨ã€éšæœºè®¿é—®è¿­ä»£å™¨</li></ul><h1 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h1><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><ul><li>åœ¨ C++ è¯­è¨€é‡Œï¼Œçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªèƒ½å¤Ÿç‹¬ç«‹è¿è¡Œçš„å‡½æ•°</li><li>ä»»ä½•ç¨‹åºä¸€å¼€å§‹å°±æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå®ƒä» main() å¼€å§‹è¿è¡Œã€‚ä¸»çº¿ç¨‹å¯ä»¥è°ƒç”¨æ¥å£å‡½æ•°ï¼Œåˆ›å»ºå‡ºå­çº¿ç¨‹ã€‚å­çº¿ç¨‹ä¼šç«‹å³è„±ç¦»ä¸»çº¿ç¨‹çš„æ§åˆ¶æµç¨‹ï¼Œå•ç‹¬è¿è¡Œï¼Œä½†å…±äº«ä¸»çº¿ç¨‹çš„æ•°æ®ã€‚ç¨‹åºåˆ›å»ºå‡ºå¤šä¸ªå­çº¿ç¨‹ï¼Œæ‰§è¡Œå¤šä¸ªä¸åŒçš„å‡½æ•°ï¼Œä¹Ÿå°±æˆäº†å¤šçº¿ç¨‹ã€‚</li><li>æœ€å¥½çš„å¹¶å‘å°±æ˜¯æ²¡æœ‰å¹¶å‘ï¼Œæœ€å¥½çš„å¤šçº¿ç¨‹å°±æ˜¯æ²¡æœ‰çº¿ç¨‹ã€‚(ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤§çš„ã€å®è§‚çš„å±‚é¢ä¸Šâ€œçœ‹å¾—åˆ°â€å¹¶å‘å’Œçº¿ç¨‹ï¼Œè€Œåœ¨å°çš„ã€å¾®è§‚çš„å±‚é¢ä¸Šâ€œçœ‹ä¸åˆ°â€çº¿ç¨‹ï¼Œå‡å°‘æ­»é”ã€åŒæ­¥ç­‰æ¶æ€§é—®é¢˜çš„å‡ºç°å‡ ç‡)</li><li>å››ä¸ªåŸºæœ¬çš„å·¥å…·ï¼š<strong>ä»…è°ƒç”¨ä¸€æ¬¡</strong>ã€<strong>çº¿ç¨‹å±€éƒ¨å­˜å‚¨</strong>ã€<strong>åŸå­å˜é‡</strong>å’Œ<strong>çº¿ç¨‹å¯¹è±¡</strong>ã€‚</li></ul><h3 id="ä»…è°ƒç”¨ä¸€æ¬¡"><a href="#ä»…è°ƒç”¨ä¸€æ¬¡" class="headerlink" title="ä»…è°ƒç”¨ä¸€æ¬¡"></a>ä»…è°ƒç”¨ä¸€æ¬¡</h3><p>å…ˆå£°æ˜ä¸€ä¸ª once_flag ç±»å‹çš„å˜é‡ï¼Œç„¶åè°ƒç”¨ä¸“é—¨çš„ call_once() å‡½æ•°ï¼Œä»¥å‡½æ•°å¼ç¼–ç¨‹çš„æ–¹å¼ï¼Œä¼ é€’è¿™ä¸ªæ ‡å¿—å’Œåˆå§‹åŒ–å‡½æ•°ã€‚è¿™æ ·å³ä½¿å¤šä¸ªçº¿ç¨‹é‡å…¥ call_once()ï¼Œä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸè¿è¡Œåˆå§‹åŒ–ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> once_flag flag; <span class="comment">// å…¨å±€çš„åˆå§‹åŒ–æ ‡å¿—</span></span><br><span class="line">std::<span class="built_in">call_once</span>(flag,</span><br><span class="line">            []()&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;only once&quot;</span> &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><h3 id="çº¿ç¨‹å±€éƒ¨å­˜å‚¨"><a href="#çº¿ç¨‹å±€éƒ¨å­˜å‚¨" class="headerlink" title="çº¿ç¨‹å±€éƒ¨å­˜å‚¨"></a>çº¿ç¨‹å±€éƒ¨å­˜å‚¨</h3><p><code>thread_local</code> æ ‡è®°çš„å˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹é‡Œéƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„å‰¯æœ¬ï¼Œæ˜¯â€œçº¿ç¨‹ç‹¬å â€çš„ï¼Œæ‰€ä»¥å°±ä¸ä¼šæœ‰ç«äº‰è¯»å†™çš„é—®é¢˜</p><h3 id="åŸå­å˜é‡"><a href="#åŸå­å˜é‡" class="headerlink" title="åŸå­å˜é‡"></a>åŸå­å˜é‡</h3><p>åŸå­å˜é‡ç¦ç”¨äº†æ‹·è´æ„é€ å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¸èƒ½ç”¨â€œ=â€çš„èµ‹å€¼å½¢å¼ï¼Œåªèƒ½ç”¨åœ†æ‹¬å·æˆ–è€…èŠ±æ‹¬å·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">atomic_int x &#123;0&#125;; </span><br><span class="line">atomic_long y &#123;1000L&#125;;</span><br></pre></td></tr></table></figure><h3 id="çº¿ç¨‹å¯¹è±¡"><a href="#çº¿ç¨‹å¯¹è±¡" class="headerlink" title="çº¿ç¨‹å¯¹è±¡"></a>çº¿ç¨‹å¯¹è±¡</h3><p><strong>thread</strong></p><p>TBD</p><p><strong>async</strong></p><p><code>async()</code> ä¼šè¿”å›ä¸€ä¸ª <code>future</code> å˜é‡ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä»£è¡¨äº†æ‰§è¡Œç»“æœçš„â€œæœŸè´§â€ï¼Œå¦‚æœä»»åŠ¡æœ‰è¿”å›å€¼ï¼Œå°±å¯ä»¥ç”¨æˆå‘˜å‡½æ•° <code>get()</code> è·å–ã€‚ä¸è¿‡è¦ç‰¹åˆ«æ³¨æ„ï¼Œ<code>get()</code> åªèƒ½è°ƒä¸€æ¬¡ï¼Œå†æ¬¡è·å–ç»“æœä¼šå‘ç”Ÿé”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸<code>std::future_error</code>ã€‚</p><p>å¦‚æœåªæ˜¯æƒ³ç®€å•åœ°åœ¨çº¿ç¨‹é‡Œå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå®Œå…¨ä¸å…³å¿ƒè¿”å›å€¼ï¼Œå¯ä»¥è°ƒç”¨threadçš„æˆå‘˜å‡½æ•°<code>detach()</code>ï¼Œæ¯”<code>async()</code>ä¼šæ–¹ä¾¿ä¸€ç‚¹</p><h1 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h1><p>åºåˆ—åŒ–ï¼Œå°±æ˜¯æŠŠå†…å­˜é‡Œâ€œæ´»çš„å¯¹è±¡â€è½¬æ¢æˆé™æ­¢çš„å­—èŠ‚åºåˆ—ï¼Œä¾¿äºå­˜å‚¨å’Œç½‘ç»œä¼ è¾“ï¼›è€Œååºåˆ—åŒ–åˆ™æ˜¯åå‘æ“ä½œï¼Œä»é™æ­¢çš„å­—èŠ‚åºåˆ—é‡æ–°æ„å»ºå‡ºå†…å­˜é‡Œå¯ç”¨çš„å¯¹è±¡ã€‚</p><p><strong>JSON</strong> æ˜¯çº¯æ–‡æœ¬ï¼Œå®¹æ˜“é˜…è¯»ï¼Œæ–¹ä¾¿ç¼–è¾‘ï¼Œé€‚ç”¨æ€§æœ€å¹¿</p><p><strong>MessagePack</strong> æ˜¯äºŒè¿›åˆ¶ï¼Œå°å·§é«˜æ•ˆï¼Œåœ¨å¼€æºç•Œæ¥å—ç¨‹åº¦æ¯”è¾ƒé«˜</p><p><strong>ProtoBuffer</strong> æ˜¯å·¥ä¸šçº§çš„æ•°æ®æ ¼å¼ï¼Œæ³¨é‡å®‰å…¨å’Œæ€§èƒ½ï¼Œå¤šç”¨åœ¨å¤§å…¬å¸çš„å•†ä¸šäº§å“é‡Œ</p><p><strong>Avro</strong></p><p><strong>Thrift</strong></p><h1 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h1><h1 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h1><blockquote><p>å¦‚ä½•åˆ›å»ºå¯¹è±¡ã€å¦‚ä½•ç»„åˆå¯¹è±¡ï¼Œä»¥åŠå¦‚ä½•å¤„ç†å¯¹è±¡ä¹‹é—´çš„åŠ¨æ€é€šä¿¡å’ŒèŒè´£åˆ†é…</p></blockquote><p>æœ€å¸¸ç”¨æœ‰ 5 ä¸ªåŸåˆ™ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„<code>SOLID</code></p><ol><li><p>SRPï¼Œå•ä¸€èŒè´£ï¼ˆSingle ResponsibilityPrincipleï¼‰</p><p>å•ä¸€èŒè´£åŸåˆ™ï¼Œç®€å•æ¥è¯´å°±æ˜¯â€œä¸è¦åšå¤šä½™çš„äº‹â€ï¼Œæ›´å¸¸è§çš„è¯´æ³•å°±æ˜¯â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è®¾è®¡ç±»çš„æ—¶å€™ï¼Œè¦å°½é‡ç¼©å°â€œç²’åº¦â€ï¼ŒåŠŸèƒ½æ˜ç¡®å•ä¸€ï¼Œä¸è¦è®¾è®¡å‡ºâ€œå¤§è€Œå…¨â€çš„ç±»ã€‚</p></li><li><p>OCPï¼Œå¼€é—­ï¼ˆOpen Closed Principleï¼‰</p><p>å•ä¸€èŒè´£åŸåˆ™ï¼Œç®€å•æ¥è¯´å°±æ˜¯â€œä¸è¦åšå¤šä½™çš„äº‹â€ï¼Œæ›´å¸¸è§çš„è¯´æ³•å°±æ˜¯â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è®¾è®¡ç±»çš„æ—¶å€™ï¼Œè¦å°½é‡ç¼©å°â€œç²’åº¦â€ï¼ŒåŠŸèƒ½æ˜ç¡®å•ä¸€ï¼Œä¸è¦è®¾è®¡å‡ºâ€œå¤§è€Œå…¨â€çš„ç±»ã€‚</p></li><li><p>LSPï¼Œé‡Œæ°æ›¿æ¢ï¼ˆLiskov Substitution Principleï¼‰</p><p>å­ç±»å¿…é¡»èƒ½å¤Ÿå®Œå…¨æ›¿ä»£çˆ¶ç±»</p></li><li><p>ISPï¼Œæ¥å£éš”ç¦»ï¼ˆInterface-Segregation Principleï¼‰</p><p>ä¾§é‡ç‚¹æ˜¯å¯¹å¤–çš„æ¥å£è€Œä¸æ˜¯å†…éƒ¨çš„åŠŸèƒ½ï¼Œç›®æ ‡æ˜¯å°½é‡ç®€åŒ–ã€å½’å¹¶ç»™å¤–ç•Œè°ƒç”¨çš„æ¥å£ï¼Œé¿å…å†™å‡ºå¤§è€Œä¸å½“çš„â€œé¢æ¡ç±»â€</p></li><li><p>DIPï¼Œä¾èµ–åè½¬ï¼Œæœ‰çš„æ—¶å€™ä¹Ÿå«ä¾èµ–å€’ç½®ï¼ˆDependency Inversion Principleï¼‰</p><p>ä¸Šå±‚è¦é¿å…ä¾èµ–ä¸‹å±‚çš„å®ç°ç»†èŠ‚ï¼Œä¸‹å±‚è¦åè¿‡æ¥ä¾èµ–ä¸Šå±‚çš„æŠ½è±¡å®šä¹‰ï¼Œè¯´ç™½äº†ï¼Œå¤§æ¦‚å°±æ˜¯â€œè§£è€¦â€</p></li></ol><table><thead><tr><th></th><th>åˆ›å»ºå‹æ¨¡å¼</th><th>ç»“æ„å‹æ¨¡å¼</th><th>è¡Œä¸ºæ¨¡å¼</th></tr></thead><tbody><tr><td>ç‰¹ç‚¹</td><td>éš”ç¦»å¯¹è±¡çš„ç”Ÿäº§å’Œä½¿ç”¨</td><td>éš”ç¦»å®¢æˆ·ä»£ç ä¸åŸå¯¹è±¡çš„æ¥å£</td><td>éš”ç¦»ç¨‹åºé‡Œç¨³å®šçš„ä¸»é€»è¾‘ä¸åŠ¨æ€å˜åŒ–çš„éƒ¨åˆ†</td></tr><tr><td>ç®€å•(å¸¸ç”¨)</td><td>å•ä»¶ã€å·¥å‚</td><td>é€‚é…å™¨ã€å¤–è§‚ã€ä»£ç†</td><td>èŒè´£é“¾ã€å‘½ä»¤ã€ç­–ç•¥</td></tr><tr><td>æ™®é€š(å¸¸ç”¨)</td><td>ç”Ÿæˆå™¨ã€åŸå‹</td><td>æ¡¥æ¥ã€è£…é¥°</td><td>è¿­ä»£å™¨ã€è§‚å¯Ÿè€…ã€çŠ¶æ€ã€æ¨¡æ¿æ–¹æ³•ã€è®¿é—®è€…</td></tr><tr><td>å›°éš¾(ä¸å¸¸ç”¨)</td><td></td><td>ç»„æˆã€äº«å…ƒ</td><td>è§£é‡Šå™¨ã€å¤‡å¿˜å½•ã€ä¸­ä»‹è€…</td></tr></tbody></table><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><ul><li><p>C++ é‡Œä¹Ÿæ˜¯æœ‰åƒåœ¾å›æ”¶çš„ï¼Œä¸è¿‡ä¸æ˜¯ Javaã€Go é‚£ç§ä¸¥æ ¼æ„ä¹‰ä¸Šçš„åƒåœ¾å›æ”¶ï¼Œè€Œæ˜¯å¹¿ä¹‰ä¸Šçš„åƒåœ¾å›æ”¶ï¼Œè¿™å°±æ˜¯æ„é€  / ææ„å‡½æ•°å’Œ <code>RAII</code> æƒ¯ç”¨æ³•ï¼ˆResource Acquisition Is Initializationï¼‰</p></li><li><p><code>noexcept</code> ä¸“é—¨ç”¨æ¥ä¿®é¥°å‡½æ•°ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™ä¸ªå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç¼–è¯‘å™¨çœ‹åˆ°<code>noexcept</code>ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªâ€œä¿è¯â€ï¼Œå°±å¯ä»¥å¯¹å‡½æ•°åšä¼˜åŒ–ï¼Œä¸å»åŠ é‚£äº›æ ˆå±•å¼€çš„é¢å¤–ä»£ç ï¼Œæ¶ˆé™¤å¼‚å¸¸å¤„ç†çš„æˆæœ¬ã€‚</p></li></ul><p><strong>reference</strong></p><ul><li>&lt;&lt;ç½—å‰‘é”‹çš„C++å®æˆ˜ç¬”è®°&gt;&gt;</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‡½æ•°&quot;&gt;&lt;a href=&quot;#å‡½æ•°&quot; class=&quot;headerlink&quot; title=&quot;å‡½æ•°&quot;&gt;&lt;/a&gt;å‡½æ•°&lt;/h1&gt;&lt;p&gt;C++ é‡Œç±»çš„å››å¤§å‡½æ•°ï¼šæ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€æ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼å‡½æ•°ã€‚C++11 å› ä¸ºå¼•å…¥äº†å³å€¼ï¼ˆRvalueï¼‰å’Œè½¬ç§»ï¼ˆMoveï¼‰ï¼Œåˆå¤šå‡º</summary>
      
    
    
    
    <category term="c++" scheme="https://www.willshirley.top/categories/c/"/>
    
    
    <category term="snippet" scheme="https://www.willshirley.top/tags/snippet/"/>
    
  </entry>
  
  <entry>
    <title>c++ tools</title>
    <link href="https://www.willshirley.top/2025/06/06/c++%20tools/"/>
    <id>https://www.willshirley.top/2025/06/06/c++%20tools/</id>
    <published>2025-06-06T02:46:06.000Z</published>
    <updated>2025-09-13T03:54:07.434Z</updated>
    
    <content type="html"><![CDATA[<h1 id="daignose-debug"><a href="#daignose-debug" class="headerlink" title="daignose/debug"></a>daignose/debug</h1><h2 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h2><h3 id="install-debug-tool"><a href="#install-debug-tool" class="headerlink" title="install debug tool"></a>install debug tool</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯ç”¨æº</span></span><br><span class="line">sudo dnf config-manager --set-enabled baseos-debuginfo appstream-debuginfo crb-debuginfo devel-debuginfo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> upgrade</span></span><br><span class="line">sudo dnf upgrade glibc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é¿å…ä½¿ç”¨dockeræº</span></span><br><span class="line">sudo dnf debuginfo-install --disablerepo=&#x27;docker*&#x27; glibc</span><br></pre></td></tr></table></figure><h2 id="Valgrind"><a href="#Valgrind" class="headerlink" title="Valgrind"></a>Valgrind</h2><h2 id="Systemtap"><a href="#Systemtap" class="headerlink" title="Systemtap"></a>Systemtap</h2><h2 id="FlameGraph"><a href="#FlameGraph" class="headerlink" title="FlameGraph"></a>FlameGraph</h2><p><a href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a>)</p><h2 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h2><h2 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h2><h2 id="perf"><a href="#perf" class="headerlink" title="perf"></a>perf</h2><h2 id="gperftools"><a href="#gperftools" class="headerlink" title="gperftools"></a>gperftools</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;daignose-debug&quot;&gt;&lt;a href=&quot;#daignose-debug&quot; class=&quot;headerlink&quot; title=&quot;daignose/debug&quot;&gt;&lt;/a&gt;daignose/debug&lt;/h1&gt;&lt;h2 id=&quot;GDB&quot;&gt;&lt;a href=&quot;#GD</summary>
      
    
    
    
    <category term="c++" scheme="https://www.willshirley.top/categories/c/"/>
    
    
    <category term="tools" scheme="https://www.willshirley.top/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>etcd snippet</title>
    <link href="https://www.willshirley.top/2025/04/24/etcd/"/>
    <id>https://www.willshirley.top/2025/04/24/etcd/</id>
    <published>2025-04-24T11:26:30.000Z</published>
    <updated>2025-05-07T02:13:27.958Z</updated>
    
    <content type="html"><![CDATA[<h1 id="command"><a href="#command" class="headerlink" title="command"></a>command</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --endpoints=http://127.0.0.1:2379 endpoint health</span><br><span class="line">ETCDCTL_API=3 /dingofs/etcd/sbin/etcdctl   --endpoints=http://127.0.0.1:2379   member list</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;command&quot;&gt;&lt;a href=&quot;#command&quot; class=&quot;headerlink&quot; title=&quot;command&quot;&gt;&lt;/a&gt;command&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="etcd" scheme="https://www.willshirley.top/categories/etcd/"/>
    
    
    <category term="snippet" scheme="https://www.willshirley.top/tags/snippet/"/>
    
  </entry>
  
  <entry>
    <title>containerd</title>
    <link href="https://www.willshirley.top/2025/03/28/containerd/"/>
    <id>https://www.willshirley.top/2025/03/28/containerd/</id>
    <published>2025-03-28T06:10:57.000Z</published>
    <updated>2026-01-08T11:02:45.656Z</updated>
    
    <content type="html"><![CDATA[<h1 id="history"><a href="#history" class="headerlink" title="history"></a>history</h1><ul><li>Docker created  containerd  originally as a component of its own engine to separate â€œhigh-levelâ€ management from â€œlow-levelâ€ execution.</li><li>Later, Docker donated  containerd  to the CNCF (Cloud Native Computing Foundation).</li><li>Kubernetes then adopted  containerd  as its runtime to remove its dependency on the full Docker daemon (the â€œDocker Shimâ€ removal), because Kubernetes only needed the â€œrunning containersâ€ part, not the full Docker UI/Network/Build stack.</li></ul><p>So today:</p><ol><li>   Docker USES containerd (as its internal engine).</li><li>   Kubernetes USES containerd (directly, skipping Docker).<br>Both tools rely on the same underlying  containerd  daemon to actually manage processes and images on Linux. If you kill  containerd , you break both Docker and Kubernetes on that node.</li></ol><h1 id="best-practise"><a href="#best-practise" class="headerlink" title="best practise"></a>best practise</h1><p><strong>change containerdâ€™s default data path</strong></p><ol><li><p>Identify the Current Data Path</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config default | grep &quot;root&quot; # Expected output: root = &quot;/var/lib/containerd&quot;</span><br></pre></td></tr></table></figure></li><li><p>Modify the following lines in /etc/containerd/config.toml:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root = &quot;/path/to/new/data/path&quot; # the location where container data (images, volumes) is stored</span><br></pre></td></tr></table></figure></li><li><p>Move Existing Data (if required)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop containerd  # optional</span><br><span class="line">sudo mv /var/lib/containerd /data/containerd</span><br><span class="line">sudo systemctl start containerd</span><br></pre></td></tr></table></figure></li></ol><h1 id="command"><a href="#command" class="headerlink" title="command"></a>command</h1><h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> list k8s image</span></span><br><span class="line">sudo ctr -n k8s.io images ls</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pull k8s image</span></span><br><span class="line">sudo ctr -n k8s.io images pull xxx</span><br><span class="line"><span class="meta">#</span><span class="bash"> pull with auth</span></span><br><span class="line">sudo ctr images pull --user username:password registry.example.com/repository/image:tag</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> load tar file</span> </span><br><span class="line">sudo ctr -n k8s.io images import /tmp/my-image.tar</span><br><span class="line"><span class="meta">#</span><span class="bash"> combine load tar file to specify tag image</span></span><br><span class="line">sudo ctr -n k8s.io images import --base-name my.registry.com/myproject/my-image:v1.2.3 /path/to/image.tar</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rename tag</span></span><br><span class="line">sudo ctr -n k8s.io images tag &lt;old-image-name&gt; &lt;new-image-name&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove image</span></span><br><span class="line">sudo ctr -n k8s.io images remove &lt;name&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure><h2 id="container"><a href="#container" class="headerlink" title="container"></a>container</h2><table><thead><tr><th align="left">Usage Context</th><th align="left">Command</th></tr></thead><tbody><tr><td align="left"><strong>Default Namespace</strong></td><td align="left"><code>ctr container ls</code></td></tr><tr><td align="left"><strong>Kubernetes Namespace</strong></td><td align="left"><code>ctr -n k8s.io container ls</code></td></tr><tr><td align="left"><strong>Check Process PIDs</strong></td><td align="left"><code>ctr task ls</code></td></tr><tr><td align="left"><strong>Detailed Inspection</strong></td><td align="left"><code>ctr container info &lt;id&gt;</code></td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> list k8s running container</span> </span><br><span class="line">ctr -n k8s.io  container ls</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> check k8s<span class="string">&#x27;s specify container</span></span></span><br><span class="line">ctr -n k8s.io  container info xxx</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> Forcefully stop the task</span></span></span><br><span class="line">ctr task kill -s SIGKILL &lt;taskName&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> Delete the Stopped Task</span></span></span><br><span class="line">ctr task rm &lt;taskName&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> Remove the Container Metadata</span></span></span><br><span class="line">ctr container rm &lt;taskName&gt;</span><br></pre></td></tr></table></figure><h1 id="nerdctl"><a href="#nerdctl" class="headerlink" title="nerdctl"></a>nerdctl</h1><p>Converting your Docker command to containerd requires using either <code>ctr</code> (low-level tool) or <code>nerdctl</code> (Docker-compatible CLI). <strong>I strongly recommend using <code>nerdctl</code></strong> as <code>ctr</code> is designed for debugging and lacks many Docker features.</p><p><code>nerdctl</code> provides a Docker-compatible interface and supports the features you need.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> list</span></span><br><span class="line">nerdctl ps</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exec</span></span> </span><br><span class="line">nerdctl exec -it &lt;containerID&gt; bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> stop</span></span><br><span class="line">nerdctl stop &lt;containerID&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm</span></span><br><span class="line">nerdctl rm &lt;containerID&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;history&quot;&gt;&lt;a href=&quot;#history&quot; class=&quot;headerlink&quot; title=&quot;history&quot;&gt;&lt;/a&gt;history&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Docker created  containerd  originally as a </summary>
      
    
    
    
    <category term="containerd" scheme="https://www.willshirley.top/categories/containerd/"/>
    
    
    <category term="container" scheme="https://www.willshirley.top/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>ceph fs</title>
    <link href="https://www.willshirley.top/2025/03/26/ceph%20FS/"/>
    <id>https://www.willshirley.top/2025/03/26/ceph%20FS/</id>
    <published>2025-03-26T08:45:16.000Z</published>
    <updated>2025-07-09T16:41:13.097Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä½¿ç”¨rootæ“ä½œ</p></blockquote><h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><blockquote><p>operate on host server</p></blockquote><p>Before mounting CephFS, ensure that</p><ol><li>the client host (where CephFS has to be mounted and used) has a copy of the Ceph configuration file (i.e. ceph.conf)</li><li>a keyring of the CephX user that has permission to access the MDS.<br>both of these files must already be present on the host where the Ceph MON resides.</li></ol><ul><li>Generate a minimal conf file for the client host and place it at a standard location:<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> on client host</span></span><br><span class="line">mkdir -p -m 755 /etc/ceph</span><br><span class="line">sudo ceph config generate-minimal-conf | sudo tee /etc/ceph/ceph.conf</span><br><span class="line">chmod 644 /etc/ceph/ceph.conf</span><br></pre></td></tr></table></figure></li></ul><h1 id="Create-Pool-FS"><a href="#Create-Pool-FS" class="headerlink" title="Create Pool/FS"></a>Create Pool/FS</h1><blockquote><p>operate in cephadm cli</p></blockquote><h2 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h2><blockquote><p>è‡ªåŠ¨é…ç½®mds</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> automatically create and configure MDS <span class="keyword">for</span>  file system</span></span><br><span class="line">ceph fs volume create cephfs-2 </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> specify mds</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ceph fs volume create cephfs-2 --placement=<span class="string">&quot;2 node1 node2&quot;</span></span></span><br></pre></td></tr></table></figure><h2 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h2><blockquote><p>æ‰‹åŠ¨é…ç½®mds</p></blockquote><ul><li><p>deploy mds</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir /var/lib/ceph/mds/ceph-<span class="variable">$&#123;id&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo ceph auth get-or-create mds.<span class="variable">$&#123;id&#125;</span> mon <span class="string">&#x27;profile mds&#x27;</span> mgr <span class="string">&#x27;profile mds&#x27;</span> mds <span class="string">&#x27;allow *&#x27;</span> osd <span class="string">&#x27;allow *&#x27;</span> &gt; /var/lib/ceph/mds/ceph-<span class="variable">$&#123;id&#125;</span>/keyring</span></span><br><span class="line"></span><br><span class="line">mkdir /var/lib/ceph/mds/ceph-node1</span><br><span class="line">ceph auth get-or-create mds.node1 mon &#x27;profile mds&#x27; mgr &#x27;profile mds&#x27; mds &#x27;allow *&#x27; osd &#x27;allow *&#x27; &gt; /var/lib/ceph/mds/ceph-node1/keyring</span><br><span class="line"></span><br><span class="line">systemctl start ceph-mds@node1</span><br></pre></td></tr></table></figure></li><li><p>Creating pools</p><blockquote><p>A Ceph file system requires at least two RADOS pools, one for data and one for metadata.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create cephfs_data</span><br><span class="line">ceph osd pool create cephfs_metadata</span><br></pre></td></tr></table></figure></li><li><p>Creating the file system</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph fs new cephfs-1 cephfs_metadata cephfs_data</span><br></pre></td></tr></table></figure></li><li><p>Check the status of the file system</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph fs status</span><br></pre></td></tr></table></figure></li><li><p>check mds status</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mds stat</span><br></pre></td></tr></table></figure></li><li><p>Using Erasure Coded pools with CephFSï¼ˆoptionalï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool set my_ec_pool allow_ec_overwrites true</span><br></pre></td></tr></table></figure></li></ul><h2 id="Create-a-CephX-user"><a href="#Create-a-CephX-user" class="headerlink" title="Create a CephX user"></a>Create a CephX user</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> éœ€è¦åœ¨åˆ›å»ºå¥½æ–‡ä»¶ç³»ç»Ÿcephfs-1å†è¿›è¡Œæ“ä½œ</span></span><br><span class="line">sudo ceph fs authorize cephfs-1 client.dongwei / rw | sudo tee /etc/ceph/ceph.client.dongwei.keyring</span><br></pre></td></tr></table></figure><blockquote><p>In above command, replace cephfs with the name of your CephFS, foo by the name you want for your CephX user and / by the path within your CephFS for which you want to allow access to the client host and rw stands for both read and write permissions.</p></blockquote><ul><li>Ensure that the keyring has appropriate permissions:</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/ceph/ceph.client.dongwei.keyring</span><br></pre></td></tr></table></figure><h1 id="Mount-CephFS-using-Kernel-Driver"><a href="#Mount-CephFS-using-Kernel-Driver" class="headerlink" title="Mount CephFS using Kernel Driver"></a>Mount CephFS using Kernel Driver</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> install ceph commond</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mount -t ceph &#123;device-string&#125;=&#123;path-to-mounted&#125; &#123;mount-point&#125; -o &#123;key-value-args&#125; &#123;other-args&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mount -t ceph &lt;name&gt;@&lt;fsid&gt;.&lt;fs_name&gt;=/ /mnt/mycephfs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fsid is the FSID of the Ceph cluster, <span class="built_in">which</span> can be found using the `ceph fsid` <span class="built_in">command</span>.</span></span><br><span class="line"></span><br><span class="line">mkdir /mnt/mycephfs</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> not use mount.helper</span></span><br><span class="line">mount -t ceph dongwei@b3acfc0d-575f-41d3-9c91-0e7ed3dbb3fa.cephfs-1=/ /mnt/cephfs -o mon_addr=192.168.0.1:6789,secret=AQATSKdNGBnwLhAAnNDKnH65FmVKpXZJVasUeQ==</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use mount.helper</span></span><br><span class="line">mount -t ceph dongwei@.cephfs-1=/ /mnt/cephfs -o secret=AQATSKdNGBnwLhAAnNDKnH65FmVKpXZJVasUeQ==</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use secret file and Multiple monitor hosts</span></span><br><span class="line">mount -t ceph cephuser@.cephfs=/ /mnt/mycephfs -o</span><br><span class="line">mon_addr=192.168.0.1:6789/192.168.0.2:6789,secretfile=/etc/ceph/cephuser.secret</span><br></pre></td></tr></table></figure><ul><li><p>check</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dongwei@6a65c746-e532-11ef-8ac2-fa7c097efb00.cephfs-1=/  190G     0  190G   0% /mnt/cephfs</span><br></pre></td></tr></table></figure></li></ul><h1 id="Mount-CephFS-using-FUSE"><a href="#Mount-CephFS-using-FUSE" class="headerlink" title="Mount CephFS using FUSE"></a>Mount CephFS using FUSE</h1><ul><li><p>install ceph-fuse</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Install the Ceph release RPM (adjust <span class="string">&#x27;reef&#x27;</span> as needed)</span></span><br><span class="line">sudo rpm -Uvh https://download.ceph.com/rpm-reef/el9/noarch/ceph-release-1-1.el9.noarch.rpm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Import the Ceph GPG key</span></span><br><span class="line">sudo rpm --import &#x27;https://download.ceph.com/keys/release.asc&#x27;</span><br><span class="line"></span><br><span class="line">sudo dnf install -y ceph-fuse</span><br></pre></td></tr></table></figure></li><li><p>mount</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ceph-fuse &#123;mount point&#125; &#123;options&#125;</span></span><br><span class="line">mkdir /mnt/mycephfs</span><br><span class="line">ceph-fuse --id dongwei /mnt/mycephfs  # mount default fs</span><br><span class="line"></span><br><span class="line">ceph-fuse --id dongwei --client_fs cephfs-1 /mnt/mycephfs # mount specify fs</span><br></pre></td></tr></table></figure></li><li><p>check</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-fuse190G     0  190G   0% /mnt/cephfs2</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä½¿ç”¨rootæ“ä½œ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;Prerequisites&quot;&gt;&lt;a href=&quot;#Prerequisites&quot; class=&quot;headerlink&quot; title=&quot;Prerequisites&quot;&gt;&lt;/a&gt;Prer</summary>
      
    
    
    
    <category term="ceph" scheme="https://www.willshirley.top/categories/ceph/"/>
    
    
    <category term="fs" scheme="https://www.willshirley.top/tags/fs/"/>
    
  </entry>
  
  <entry>
    <title>ceph csi</title>
    <link href="https://www.willshirley.top/2025/03/26/ceph%20csi/"/>
    <id>https://www.willshirley.top/2025/03/26/ceph%20csi/</id>
    <published>2025-03-26T06:14:17.000Z</published>
    <updated>2025-11-03T09:48:50.722Z</updated>
    
    <content type="html"><![CDATA[<h1 id="image"><a href="#image" class="headerlink" title="image"></a>image</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> v3.13</span></span><br><span class="line">quay.io/cephcsi/cephcsi:canary</span><br><span class="line"></span><br><span class="line">registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.13.0</span><br><span class="line">registry.k8s.io/sig-storage/csi-provisioner:v5.1.0</span><br><span class="line">registry.k8s.io/sig-storage/csi-resizer:v1.13.1</span><br><span class="line">registry.k8s.io/sig-storage/csi-snapshotter:v8.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> v3.10</span></span><br><span class="line">quay.io/cephcsi/cephcsi:v3.10-canary</span><br><span class="line"></span><br><span class="line">registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.9.1</span><br><span class="line">registry.k8s.io/sig-storage/csi-provisioner:v3.6.2</span><br><span class="line">registry.k8s.io/sig-storage/csi-resizer:v1.9.2</span><br><span class="line">registry.k8s.io/sig-storage/csi-snapshotter:v6.3.2</span><br></pre></td></tr></table></figure><h1 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h1><h2 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h2><ul><li>step1</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 18 server: /home/dongwei/k8s/ceph-resource/v3.10-work/deploy/cephfs/kubernetes</span></span><br><span class="line">kubectl create -f csidriver.yaml</span><br><span class="line">kubectl create -f csi-provisioner-rbac.yaml</span><br><span class="line">kubectl create -f csi-nodeplugin-rbac.yaml</span><br></pre></td></tr></table></figure><ul><li><p>step2</p><p><code>kubectl create -f csi-config-map.yaml</code></p><blockquote><p>check by <code>ceph mon dump</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-csi-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ceph</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.json:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;clusterID&quot;: &quot;xxx&quot;, </span></span><br><span class="line"><span class="string">        &quot;monitors&quot;: [</span></span><br><span class="line"><span class="string">          &quot;172.20.7.xxx:6789&quot;,</span></span><br><span class="line"><span class="string">          &quot;172.20.7.xxx:6789&quot;,</span></span><br><span class="line"><span class="string">          &quot;172.20.7.xxx:6789&quot;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br></pre></td></tr></table></figure></li><li><p>step3</p><p><code>kubectl create -f ceph-conf.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">ceph.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [global]</span></span><br><span class="line"><span class="string">    auth_cluster_required = cephx</span></span><br><span class="line"><span class="string">    auth_service_required = cephx</span></span><br><span class="line"><span class="string">    auth_client_required = cephx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="comment"># keyring is a required key and its value should be empty</span></span><br><span class="line">  <span class="attr">keyring:</span> <span class="string">|</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ceph</span></span><br></pre></td></tr></table></figure></li><li><p>step4</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kms-config.yaml</span><br><span class="line">kubectl create -f csi-cephfsplugin-provisioner.yaml</span><br><span class="line">kubectl create -f csi-cephfsplugin.yaml</span><br></pre></td></tr></table></figure></li></ul><h2 id="provision"><a href="#provision" class="headerlink" title="provision"></a>provision</h2><blockquote><p>Requires subvolumegroup to be created before provisioning the PVC. If the subvolumegroup provided in <code>ceph-csi-config</code> ConfigMap is missing in the ceph cluster, the PVC creation will fail and will stay in <code>Pending</code> state.</p></blockquote><h3 id="dynamic-provision"><a href="#dynamic-provision" class="headerlink" title="dynamic provision"></a>dynamic provision</h3><ul><li><p>step1 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph fs subvolumegroup create &lt;fsName&gt; csi # ä¼šç”Ÿæˆå­ç›®å½•ï¼ˆvolumes/csiï¼‰ /æŒ‚è½½ç‚¹/volumes/csi/</span><br></pre></td></tr></table></figure></li><li><p>step2</p><p><code>kubectl create -f secret.yaml</code></p><blockquote><p>check by <code>ceph auth get client.dongwei</code> and <code>ceph auth get client.admin</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-cephfs-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ceph</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="comment"># Required for statically provisioned volumes, ğŸš¨ this use userID</span></span><br><span class="line">  <span class="attr">userID:</span> <span class="string">dongwei</span></span><br><span class="line">  <span class="attr">userKey:</span> <span class="string">&lt;&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required for dynamically provisioned volumes, ğŸš¨ this use adminID</span></span><br><span class="line">  <span class="attr">adminID:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">adminKey:</span> <span class="string">&lt;&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Encryption passphrase</span></span><br><span class="line">  <span class="attr">encryptionPassphrase:</span> <span class="string">test_passphrase</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>Required secrets for provisioning:</strong> Admin credentials are required for provisioning new volumes</p><ul><li><code>adminID</code>: ID of an admin client</li><li><code>adminKey</code>: key of the admin client</li></ul><p><strong>Required secrets for statically provisioned volumes:</strong> User credentials with access to an existing volume</p><ul><li><code>userID</code>: ID of a user client</li><li><code>userKey</code>: key of a user client</li></ul></blockquote></li><li><p>step3</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f storageclass.yaml</span><br><span class="line">kubectl create -f pvc.yaml</span><br><span class="line">kubectl create -f pod.yaml</span><br></pre></td></tr></table></figure></li></ul><h3 id="static-provision"><a href="#static-provision" class="headerlink" title="static provision"></a>static provision</h3><ul><li><p>step1 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph fs subvolumegroup create &lt;fsName&gt; testGroup</span><br><span class="line">ceph fs subvolume create &lt;fsName&gt; testSubVolume testGroup --size=1073741824  # byte 1073741824/1024/1024=1024MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">ceph fs subvolume getpath &lt;fsName&gt; testSubVolume testGroup</span><br></pre></td></tr></table></figure></li><li><p>step2</p><p><code>kubectl create -f secret.yaml</code></p><blockquote><p>check by <code>ceph auth get client.dongwei</code> </p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-cephfs-secret-static</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ceph</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="comment"># Required for statically provisioned volumes, ğŸš¨ this use userID</span></span><br><span class="line">  <span class="attr">userID:</span> <span class="string">dongwei</span></span><br><span class="line">  <span class="attr">userKey:</span> <span class="string">&lt;&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Encryption passphrase</span></span><br><span class="line">  <span class="attr">encryptionPassphrase:</span> <span class="string">test_passphrase</span></span><br></pre></td></tr></table></figure></li><li><p>step3</p><p><code>kubectl create -f pv.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-static-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">csi:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">cephfs.csi.ceph.com</span></span><br><span class="line">    <span class="attr">nodeStageSecretRef:</span></span><br><span class="line">      <span class="comment"># node stage secret name</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csi-cephfs-secret</span></span><br><span class="line">      <span class="comment"># node stage secret namespace where above secret is created</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">ceph</span></span><br><span class="line">    <span class="attr">volumeAttributes:</span></span><br><span class="line">      <span class="comment"># optional file system to be mounted</span></span><br><span class="line">      <span class="attr">&quot;fsName&quot;:</span> <span class="string">&quot;cephfs-1&quot;</span></span><br><span class="line">      <span class="comment"># Required options from storageclass parameters need to be added in volumeAttributes</span></span><br><span class="line">      <span class="attr">&quot;clusterID&quot;:</span> <span class="string">&quot;ba68226a-672f-4ba5-97bc-22840318b2ec&quot;</span></span><br><span class="line">      <span class="attr">&quot;staticVolume&quot;:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">&quot;rootPath&quot;:</span> <span class="string">/volumes/testGroup/testSubVolume</span></span><br><span class="line">    <span class="comment"># volumeHandle can be anything, need not to be same</span></span><br><span class="line">    <span class="comment"># as PV name or volume name. keeping same for brevity</span></span><br><span class="line">    <span class="attr">volumeHandle:</span> <span class="string">cephfs-static-pv</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><blockquote><p>rootPath ä¹Ÿå¯ä»¥æŒ‡å®šä¸º  /volumes/csi</p></blockquote></li><li><p>step4</p><p><code>kubectl create -f pvc.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-static-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="comment"># volumeName should be same as PV name</span></span><br><span class="line">  <span class="attr">volumeName:</span> <span class="string">cephfs-static-pv</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="best-practices"><a href="#best-practices" class="headerlink" title="best practices"></a>best practices</h1><h2 id="æ›´é«˜clusterID"><a href="#æ›´é«˜clusterID" class="headerlink" title="æ›´é«˜clusterID"></a>æ›´é«˜clusterID</h2><p>éœ€è¦åˆ é™¤å†å²çš„ PV å’Œ PVC</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¼ºåˆ¶åˆ é™¤PV</span></span><br><span class="line">kubectl patch pv pvc-xxx -p &#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27; --type=merge</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;image&quot;&gt;&lt;a href=&quot;#image&quot; class=&quot;headerlink&quot; title=&quot;image&quot;&gt;&lt;/a&gt;image&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;</summary>
      
    
    
    
    <category term="ceph" scheme="https://www.willshirley.top/categories/ceph/"/>
    
    
    <category term="csi" scheme="https://www.willshirley.top/tags/csi/"/>
    
  </entry>
  
  <entry>
    <title>kubelet snippet</title>
    <link href="https://www.willshirley.top/2025/03/25/k8s-point%20kubelet/"/>
    <id>https://www.willshirley.top/2025/03/25/k8s-point%20kubelet/</id>
    <published>2025-03-25T06:58:19.000Z</published>
    <updated>2025-12-26T08:37:05.762Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th><strong>Path</strong></th><th><strong>Purpose</strong></th></tr></thead><tbody><tr><td>/var/lib/kubelet/pods/</td><td>Pod + volume desired state</td></tr><tr><td>/var/lib/kubelet/plugins/kubernetes.io/csi/</td><td>CSI mount state</td></tr><tr><td>/var/lib/kubelet/volumeDevices/ or /volumePlugins/</td><td>Volume tracking</td></tr></tbody></table><h1 id="log"><a href="#log" class="headerlink" title="log"></a>log</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u kubelet -g &quot;&lt;key-words&gt;&quot;</span><br></pre></td></tr></table></figure><h1 id="troubleshooting"><a href="#troubleshooting" class="headerlink" title="troubleshooting"></a>troubleshooting</h1><h2 id="mount-pvc-which-is-absent"><a href="#mount-pvc-which-is-absent" class="headerlink" title="mount pvc which is absent"></a>mount pvc which is absent</h2><p>Kubelet runs <strong>multiple controllers</strong> in parallel:</p><table><thead><tr><th><strong>Loop</strong></th><th><strong>Purpose</strong></th><th><strong>Trigger</strong></th></tr></thead><tbody><tr><td>Mount loop</td><td>NodePublishVolume</td><td>Pod volume</td></tr><tr><td>Expand loop</td><td>NodeExpandVolume</td><td>PVC resize logic</td></tr><tr><td>Attach loop</td><td>VolumeAttachment</td><td>Controller side</td></tr></tbody></table><ul><li><p>Even though the <strong>PVC object is absent</strong>, Kubelet thinks: <code>â€œVolume still required but temporarily unavailableâ€</code> (kubelet still has <strong>stale DesiredStateOfWorld (DSW)</strong> entries created earlier, and retry loop continues forever)</p></li><li><p>When <strong>Mount</strong> pvc success, Kubelet thinks: â€œMount succeeded, now check expansionâ€(kubelet calls <strong>NodeExpandVolume</strong>)</p><p>That code path: <code>mountVolume.NodeExpandVolume â†’ GET PVC</code>, But </p></li><li><p>kubelet schedules retry (2m backoff)  (âš ï¸This retry is NOT CSI-controlled)</p></li></ul><p>Once kubelet decides success Until <strong>DSW is updated</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pod X needs Volume Y</span><br></pre></td></tr></table></figure><p><strong>CSI cannot cancel kubelet desire</strong></p><table><thead><tr><th><strong>CSI Return</strong></th><th><strong>Result</strong></th></tr></thead><tbody><tr><td>OK</td><td>Expand loop triggers</td></tr><tr><td>NotFound</td><td>Mount loop retries</td></tr><tr><td>FailedPrecondition</td><td>Retries</td></tr><tr><td>Aborted</td><td>Retries</td></tr><tr><td>Canceled</td><td>Retries</td></tr></tbody></table><p><strong>Why kubelet behaves like this (design reality)</strong></p><p>Kubernetes assumes:</p><ul><li>API server may be temporarily unavailable</li><li>PVC deletion may be delayed</li><li>Node permissions may be limited</li></ul><p>So kubelet <strong>never treats â€œPVC missingâ€ as terminal</strong>, That decision is <strong>intentional</strong>.</p><blockquote><p><strong>If kubelet decides a Pod needs a volume, only kubelet can forget it. CSI can only convince it by saying â€œOKâ€.</strong></p></blockquote><h2 id="Version-from-runtime-service-failed"><a href="#Version-from-runtime-service-failed" class="headerlink" title="Version from runtime service failed"></a>Version from runtime service failed</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E0325 12:15:10.889620 3185179 remote_runtime.go:189] &quot;Version from runtime service failed&quot; err=&quot;rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;</span><br><span class="line">E0325 12:15:10.889663 3185179 kuberuntime_manager.go:226] &quot;Get runtime version failed&quot; err=&quot;get remote runtime typed version failed: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;</span><br><span class="line">E0325 12:15:10.889683 3185179 run.go:74] &quot;command failed&quot; err=&quot;failed to run Kubelet: failed to create kubelet: get remote runtime typed version failed: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;</span><br></pre></td></tr></table></figure><ul><li><p>resolve</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶æ­£å¸¸èŠ‚ç‚¹ /etc/containerd/config.toml é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯ containerd</span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line"></span><br><span class="line">kubeletæœåŠ¡ä¼šè‡ªåŠ¨æ‹‰èµ·</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;Path&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Purpose&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;/var/lib/kubelet/pods/&lt;</summary>
      
    
    
    
    <category term="kubernetes" scheme="https://www.willshirley.top/categories/kubernetes/"/>
    
    
    <category term="kubelet" scheme="https://www.willshirley.top/tags/kubelet/"/>
    
  </entry>
  
  <entry>
    <title>clang-uml</title>
    <link href="https://www.willshirley.top/2025/03/20/clang-uml/"/>
    <id>https://www.willshirley.top/2025/03/20/clang-uml/</id>
    <published>2025-03-20T11:27:14.000Z</published>
    <updated>2025-03-24T07:46:54.780Z</updated>
    
    <content type="html"><![CDATA[<h1 id="clang-uml"><a href="#clang-uml" class="headerlink" title="clang-uml"></a>clang-uml</h1><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> init .clang-uml file</span></span><br><span class="line">clang-uml --init</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use specify config file</span></span><br><span class="line">clang-uml -c /path/to/configFile</span><br></pre></td></tr></table></figure><h2 id="generate-PlantUML"><a href="#generate-PlantUML" class="headerlink" title="generate PlantUML"></a>generate PlantUML</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> generate xxx.puml base on default config</span></span><br><span class="line">clang-uml # --progress</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> draw svg picture base on above puml file</span></span><br><span class="line">plantuml -tsvg xxx.puml</span><br></pre></td></tr></table></figure><h2 id="generate-mermaid"><a href="#generate-mermaid" class="headerlink" title="generate  mermaid"></a>generate  mermaid</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> genrate xxx.mmd</span></span><br><span class="line">clang-uml -g mermaid</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> draw svg</span></span><br><span class="line">mmdc -i xxx.mmd # -o &lt;name&gt;.svg</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> draw big svg</span></span><br><span class="line">vim config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;maxTextSize&quot;: 1000000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mmdc -i diagram.mmd -c config.json</span><br></pre></td></tr></table></figure><h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> To find the exact <span class="keyword">function</span> signature</span></span><br><span class="line"> clang-uml --print-from -n client_class_diagram -c .clang-uml-sequence | grep main</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;clang-uml&quot;&gt;&lt;a href=&quot;#clang-uml&quot; class=&quot;headerlink&quot; title=&quot;clang-uml&quot;&gt;&lt;/a&gt;clang-uml&lt;/h1&gt;&lt;h2 id=&quot;init&quot;&gt;&lt;a href=&quot;#init&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="clang-uml" scheme="https://www.willshirley.top/categories/clang-uml/"/>
    
    
    <category term="tool" scheme="https://www.willshirley.top/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>nvidia cuda</title>
    <link href="https://www.willshirley.top/2025/03/12/cuda/"/>
    <id>https://www.willshirley.top/2025/03/12/cuda/</id>
    <published>2025-03-12T07:59:26.000Z</published>
    <updated>2025-12-30T02:42:30.774Z</updated>
    
    <content type="html"><![CDATA[<h1 id="version"><a href="#version" class="headerlink" title="version"></a>version</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GPU  drivercuda|vllm torch          image </span><br><span class="line">h10055012.4  |</span><br><span class="line">h20056512.7|0.7.32.5.1+cu124</span><br><span class="line">h20057012.8|0.7.32.5.1+cu124    nvcr.io/nvidia/pytorch:25.01-py3</span><br></pre></td></tr></table></figure><h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><h2 id="CUDA-Toolkit"><a href="#CUDA-Toolkit" class="headerlink" title="CUDA Toolkit"></a>CUDA Toolkit</h2><blockquote><p><a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a></p></blockquote><ul><li><p>local</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin</span><br><span class="line"></span><br><span class="line">sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600</span><br><span class="line"></span><br><span class="line">wget https://developer.download.nvidia.com/compute/cuda/12.8.1/local_installers/cuda-repo-ubuntu2204-12-8-local_12.8.1-570.124.06-1_amd64.deb</span><br><span class="line"></span><br><span class="line">sudo dpkg -i cuda-repo-ubuntu2204-12-8-local_12.8.1-570.124.06-1_amd64.deb</span><br><span class="line"></span><br><span class="line">sudo cp /var/cuda-repo-ubuntu2204-12-8-local/cuda-*-keyring.gpg /usr/share/keyrings/</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get -y install cuda-toolkit-12-8</span><br></pre></td></tr></table></figure></li><li><p>online</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb</span><br><span class="line">sudo dpkg -i cuda-keyring_1.1-1_all.deb</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install cuda-toolkit-12-8</span><br></pre></td></tr></table></figure></li></ul><h3 id="post-operate"><a href="#post-operate" class="headerlink" title="post operate"></a>post operate</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> config env</span></span><br><span class="line">export PATH=/usr/local/cuda/bin:$PATH</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NVIDIA persistence daemon</span></span><br><span class="line">sudo systemctl start nvidia-persistenced</span><br></pre></td></tr></table></figure><h2 id="driver"><a href="#driver" class="headerlink" title="driver"></a>driver</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y cuda-drivers</span><br></pre></td></tr></table></figure><h2 id="nvidia-fabricmanager"><a href="#nvidia-fabricmanager" class="headerlink" title="nvidia-fabricmanager"></a>nvidia-fabricmanager</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y nvidia-fabricmanager-570</span><br><span class="line"></span><br><span class="line">sudo systemctl start nvidia-fabricmanager</span><br></pre></td></tr></table></figure><h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><blockquote><p>resolve issues: Error 802: system not yet initialized</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sort GPUs, by ordering their IDs with IDs on the PCIe bus.</span></span><br><span class="line">export CUDA_DEVICE_ORDER=&quot;PCI_BUS_ID&quot; </span><br><span class="line"><span class="meta">#</span><span class="bash"> perform an availability check using NVML (NVIDIA Management Library). NVML is an API layer <span class="keyword">for</span> obtaining data directly from the NVIDIA-smi utility.</span></span><br><span class="line">export PYTORCH_NVML_BASED_CUDA_CHECK=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> force show the system the IDs of available GPUs.</span></span><br><span class="line">export CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7</span><br></pre></td></tr></table></figure><h1 id="cuda-kernel-model"><a href="#cuda-kernel-model" class="headerlink" title="cuda kernel model"></a>cuda kernel model</h1><ul><li>check by <code>lsmod | grep nvidia</code></li></ul><table><thead><tr><th><strong>Module</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>nvidia_uvm</td><td>NVIDIAâ€™s Unified Memory driver</td></tr><tr><td>nvidia_drm</td><td>Direct Rendering Manager support</td></tr><tr><td>nvidia_modeset</td><td>Kernel mode-setting support</td></tr><tr><td>nvidia</td><td>Main NVIDIA driver module</td></tr></tbody></table><h1 id="command"><a href="#command" class="headerlink" title="command"></a>command</h1><h2 id="nvidia-smi"><a href="#nvidia-smi" class="headerlink" title="nvidia-smi"></a>nvidia-smi</h2><ul><li><p>Enable Persistence Mode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi -pm 1</span><br></pre></td></tr></table></figure></li><li><p>check state</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi conf-compute -grs</span><br><span class="line"><span class="meta">#</span><span class="bash"> Confidential Compute GPUs Ready state: not-ready</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Confidential Compute GPUs Ready state: ready</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> above state is not-ready, execute below cmd</span></span><br><span class="line">nvidia-smi conf-compute -srs 1</span><br></pre></td></tr></table></figure></li><li><p>cuda 12.8</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nvidia-smi</span></span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 570.124.06             Driver Version: 570.124.06     CUDA Version: 12.8     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA H200                    On  |   00000000:19:00.0 Off |                    0 |</span><br><span class="line">| N/A   23C    P0             76W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   1  NVIDIA H200                    On  |   00000000:3B:00.0 Off |                    0 |</span><br><span class="line">| N/A   21C    P0             75W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   2  NVIDIA H200                    On  |   00000000:4C:00.0 Off |                    0 |</span><br><span class="line">| N/A   23C    P0             76W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   3  NVIDIA H200                    On  |   00000000:5D:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0             77W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   4  NVIDIA H200                    On  |   00000000:9B:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0             75W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   5  NVIDIA H200                    On  |   00000000:BB:00.0 Off |                    0 |</span><br><span class="line">| N/A   23C    P0             77W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   6  NVIDIA H200                    On  |   00000000:CB:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0             76W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   7  NVIDIA H200                    On  |   00000000:DB:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0             76W /  700W |       1MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                                         </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI              PID   Type   Process name                        GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">|  No running processes found                                                             |</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></li><li><p>cuda 12.7</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nvidia-smi</span></span><br><span class="line">Fri Mar 14 10:23:56 2025       </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 565.57.01              Driver Version: 565.57.01      CUDA Version: 12.7     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA H200                    On  |   00000000:19:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            111W /  700W |  134402MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   1  NVIDIA H200                    On  |   00000000:3B:00.0 Off |                    0 |</span><br><span class="line">| N/A   25C    P0            116W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   2  NVIDIA H200                    On  |   00000000:4C:00.0 Off |                    0 |</span><br><span class="line">| N/A   25C    P0            112W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   3  NVIDIA H200                    On  |   00000000:5D:00.0 Off |                    0 |</span><br><span class="line">| N/A   27C    P0            115W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   4  NVIDIA H200                    On  |   00000000:9B:00.0 Off |                    0 |</span><br><span class="line">| N/A   27C    P0            115W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   5  NVIDIA H200                    On  |   00000000:BB:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            114W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   6  NVIDIA H200                    On  |   00000000:CB:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            113W /  700W |  132320MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   7  NVIDIA H200                    On  |   00000000:DB:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0            114W /  700W |  131840MiB / 143771MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                                         </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h1 id="vllm"><a href="#vllm" class="headerlink" title="vllm"></a>vllm</h1><h2 id="install-offline"><a href="#install-offline" class="headerlink" title="install offline"></a>install offline</h2><p>On your local machine, create a virtual environment:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m venv vllm_env</span><br><span class="line">source vllm_env/bin/activate</span><br></pre></td></tr></table></figure><p>1ï¸âƒ£ <strong>On your local machine:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip download --dest=./vllm_deps vllm</span><br></pre></td></tr></table></figure><p>2ï¸âƒ£ <strong>Transfer dependencies to the remote server:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r vllm_deps user@remote_server:/path/to/destination/</span><br></pre></td></tr></table></figure><p>3ï¸âƒ£ <strong>On the remote server:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /path/to/destination/vllm_deps</span><br><span class="line">pip install --no-index --find-links=. vllm*</span><br><span class="line">â€¢--no-index tells pip not to use the internet.</span><br><span class="line">â€¢--find-links=./vllm_deps tells pip to look for packages in this directory.</span><br><span class="line">â€¢vllm* ensures pip finds the correct package in that folder.</span><br></pre></td></tr></table></figure><h2 id="running-time"><a href="#running-time" class="headerlink" title="running time"></a>running time</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vllm serve /mnt/dingofs-test/DeepSeek-R1 --host 0.0.0.0 --port 8000 --served-model-name deepseek-r1 --tensor-parallel-size 8 --gpu-memory-utilization 0.85 --max-model-len 128000 --max-num-batched-tokens 32000 --max-num-seqs 1024 --trust-remote-code --enable-reasoning --reasoning-parser deepseek_r1</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Sat Mar 15 20:33:04 2025       </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 570.124.06             Driver Version: 570.124.06     CUDA Version: 12.8     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA H200                    On  |   00000000:19:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            115W /  700W |   84474MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   1  NVIDIA H200                    On  |   00000000:3B:00.0 Off |                    0 |</span><br><span class="line">| N/A   24C    P0            113W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   2  NVIDIA H200                    On  |   00000000:4C:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            114W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   3  NVIDIA H200                    On  |   00000000:5D:00.0 Off |                    0 |</span><br><span class="line">| N/A   27C    P0            117W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   4  NVIDIA H200                    On  |   00000000:9B:00.0 Off |                    0 |</span><br><span class="line">| N/A   27C    P0            114W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   5  NVIDIA H200                    On  |   00000000:BB:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            116W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   6  NVIDIA H200                    On  |   00000000:CB:00.0 Off |                    0 |</span><br><span class="line">| N/A   27C    P0            115W /  700W |   84522MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">|   7  NVIDIA H200                    On  |   00000000:DB:00.0 Off |                    0 |</span><br><span class="line">| N/A   26C    P0            114W /  700W |   84282MiB / 143771MiB |      1%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                                         </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI              PID   Type   Process name                        GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">|    0   N/A  N/A          915920      C   ...niconda3/envs/vllm/bin/python      84464MiB |</span><br><span class="line">|    1   N/A  N/A          916338      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    2   N/A  N/A          916339      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    3   N/A  N/A          916340      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    4   N/A  N/A          916341      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    5   N/A  N/A          916342      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    6   N/A  N/A          916343      C   ...niconda3/envs/vllm/bin/python      84512MiB |</span><br><span class="line">|    7   N/A  N/A          916344      C   ...niconda3/envs/vllm/bin/python      84272MiB |</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li><p>log</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INFO 03-15 20:36:48 worker.py:267] Memory profiling takes 7.63 seconds</span><br><span class="line">INFO 03-15 20:36:48 worker.py:267] the current vLLM instance can use total_gpu_memory (139.81GiB) x gpu_memory_utilization (0.85) = 118.84GiB</span><br><span class="line">INFO 03-15 20:36:48 worker.py:267] model weights take 83.88GiB; non_torch_memory takes 7.16GiB; PyTorch activation peak memory takes 6.37GiB; the rest of the memory reserved </span><br><span class="line">for KV Cache is 21.43GiB.</span><br><span class="line">INFO 03-15 20:36:48 executor_base.py:111] # cuda blocks: 18418, # CPU blocks: 3437</span><br><span class="line">INFO 03-15 20:36:48 executor_base.py:116] Maximum concurrency for 128000 tokens per request: 2.30x</span><br></pre></td></tr></table></figure></li><li><p>chat</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8000/v1/chat/completions \</span><br><span class="line">    -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">    -d &#x27;&#123;</span><br><span class="line">        &quot;model&quot;: &quot;deepseek-r1&quot;,</span><br><span class="line">        &quot;messages&quot;: [</span><br><span class="line">            &#123;&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a helpful assistant.&quot;&#125;,</span><br><span class="line">            &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;introduce yourself&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;&#x27;</span><br></pre></td></tr></table></figure></li></ul><h1 id="sglang"><a href="#sglang" class="headerlink" title="sglang"></a>sglang</h1><h2 id="install-offline-1"><a href="#install-offline-1" class="headerlink" title="install offline"></a>install offline</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> prepare env</span></span><br><span class="line">python3 -m venv sglang_env</span><br><span class="line">source sglang_env/bin/activate</span><br><span class="line"><span class="meta">#</span><span class="bash"> optional use uv</span></span><br><span class="line">pip install --upgrade pip</span><br><span class="line"><span class="meta">#</span><span class="bash">pip install uv</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> download deps</span></span><br><span class="line">mkdir -p ./sglang_deps</span><br><span class="line">pip download &quot;sglang[all]&gt;=0.4.4.post1&quot; --find-links https://flashinfer.ai/whl/cu124/torch2.5/flashinfer-python -d ./sglang_deps</span><br><span class="line"><span class="meta">#</span><span class="bash"> scp deps to remote</span></span><br><span class="line">scp -r sglang_deps user@remote_server:/path/to/destination/</span><br><span class="line"><span class="meta">#</span><span class="bash"> install sglang on remote</span></span><br><span class="line">cd /path/to/remote/sglang_deps</span><br><span class="line">pip install --no-index --find-links=. &quot;sglang[all]&gt;=0.4.4.post1&quot;</span><br></pre></td></tr></table></figure><h2 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m sglang.launch_server --model /mnt/3fs/DeepSeek-R1 --tp 8 --trust-remote-code --port 30000</span><br></pre></td></tr></table></figure><ul><li><p>chat</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:30000/v1/chat/completions \</span><br><span class="line">    -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">    -d &#x27;&#123;</span><br><span class="line">        &quot;model&quot;: &quot;deepseek-r1&quot;,</span><br><span class="line">        &quot;messages&quot;: [</span><br><span class="line">            &#123;&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a helpful assistant.&quot;&#125;,</span><br><span class="line">            &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;introduce yourself&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;&#x27;</span><br></pre></td></tr></table></figure></li></ul><h1 id="torch"><a href="#torch" class="headerlink" title="torch"></a>torch</h1><h2 id="install-offline-2"><a href="#install-offline-2" class="headerlink" title="install offline"></a>install offline</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/torch_deps</span><br><span class="line">pip download --dest=~/torch_deps torch==2.5.1 --extra-index-url https://download.pytorch.org/whl/nightly/cu128</span><br><span class="line"></span><br><span class="line">scp -r ~/torch_deps user@remote_server:/path/to/remote/directory</span><br><span class="line">cd /path/to/remote/directory</span><br><span class="line">pip install --no-index --find-links=./ torch</span><br></pre></td></tr></table></figure><ul><li><p>check</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;import torch; print(torch.cuda.is_available()); print(torch.cuda.device_count())&quot;</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="built_in">print</span>(torch.cuda.is_available())  <span class="comment"># print false</span></span><br><span class="line"><span class="built_in">print</span>(torch.cuda.device_count())  <span class="comment"># print 8</span></span><br><span class="line"><span class="built_in">print</span>(torch.__version__)  <span class="comment"># print 2.5.1+cu124</span></span><br><span class="line"><span class="built_in">print</span>(torch.version.cuda) <span class="comment"># print 12.4</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="best-practices"><a href="#best-practices" class="headerlink" title="best practices"></a>best practices</h1><h2 id="CUDA-LAUNCH-BLOCKING-1"><a href="#CUDA-LAUNCH-BLOCKING-1" class="headerlink" title="CUDA_LAUNCH_BLOCKING=1"></a><code>CUDA_LAUNCH_BLOCKING=1</code></h2><blockquote><p>CUDA_LAUNCH_BLOCKING=1 will tell CUDA: â€œWait (block) for each GPU kernel to finish before moving to the next line of Python code.â€</p></blockquote><p>Normally, CUDA operations are <strong>asynchronous</strong>â€”errors may not happen exactly where the code looks wrong, because the kernel may fail later. This can make debugging frustrating.</p><p>should never use it in production or performance benchmarkingâ€”just for debugging.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;version&quot;&gt;&lt;a href=&quot;#version&quot; class=&quot;headerlink&quot; title=&quot;version&quot;&gt;&lt;/a&gt;version&lt;/h1&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="cuda" scheme="https://www.willshirley.top/categories/cuda/"/>
    
    
    <category term="nvidia" scheme="https://www.willshirley.top/tags/nvidia/"/>
    
  </entry>
  
</feed>
